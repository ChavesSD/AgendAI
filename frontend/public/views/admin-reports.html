<!-- View de Relatórios para o Dashboard Administrativo -->
<div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="border-end bg-white" id="sidebar-wrapper">
        <div class="sidebar-heading bg-primary text-white py-4 d-flex justify-content-center">
            <div class="logo-container">
                <img src="/public/src/img/LogoAgendAIForFooter.png" alt="AgendAI Logo" class="logo-medium">
            </div>
        </div>
        <div class="list-group list-group-flush">
            <a href="#/admin" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-tachometer-alt me-2"></i> Dashboard
            </a>
            <a href="#/admin/plans" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-tag me-2"></i> Planos
            </a>
            <a href="#/admin/companies" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-building me-2"></i> Empresas
            </a>
            <a href="#/admin/users" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-users me-2"></i> Usuários
            </a>
            <a href="#/admin/professionals" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-user-md me-2"></i> Profissionais
            </a>
            <a href="#/admin/services" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-list-alt me-2"></i> Serviços
            </a>
            <a href="#/admin/clients" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-user-friends me-2"></i> Clientes
            </a>
            <a href="#/admin/appointments" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-calendar-alt me-2"></i> Agendamentos
            </a>
            <a href="#/admin/reports" class="list-group-item list-group-item-action active" data-link>
                <i class="fas fa-chart-bar me-2"></i> Relatórios
            </a>
            <a href="#/admin/settings" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-cog me-2"></i> Configurações
            </a>
        </div>
    </div>
    
    <!-- Page Content -->
    <div id="page-content-wrapper">
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
                        <li class="nav-item">
                            <button class="btn btn-outline-secondary btn-sm mt-1" id="logout-button">
                                <i class="fas fa-sign-out-alt me-1"></i> Sair
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        
        <!-- Reports Content -->
        <div class="container-fluid p-4">
            <div class="row mb-4">
                <div class="col-md-8">
                    <h2 class="mb-3">Relatórios</h2>
                    <p class="text-muted">Gere relatórios detalhados sobre diversos aspectos do sistema.</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-download me-1"></i> Exportar
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="exportPDF"><i class="fas fa-file-pdf me-2"></i> Exportar PDF</a></li>
                            <li><a class="dropdown-item" href="#" id="exportExcel"><i class="fas fa-file-excel me-2"></i> Exportar Excel</a></li>
                            <li><a class="dropdown-item" href="#" id="exportCSV"><i class="fas fa-file-csv me-2"></i> Exportar CSV</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Report Type Selection -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Tipo de Relatório</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card report-card" data-report-type="billing">
                                <div class="card-body text-center py-4">
                                    <i class="fas fa-money-bill-wave fa-3x text-primary mb-3"></i>
                                    <h5 class="card-title">Faturamento</h5>
                                    <p class="card-text small">Relatórios de faturamento por período e empresa</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card report-card" data-report-type="appointments">
                                <div class="card-body text-center py-4">
                                    <i class="fas fa-calendar-check fa-3x text-success mb-3"></i>
                                    <h5 class="card-title">Agendamentos</h5>
                                    <p class="card-text small">Estatísticas de agendamentos por período</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card report-card" data-report-type="clients">
                                <div class="card-body text-center py-4">
                                    <i class="fas fa-users fa-3x text-info mb-3"></i>
                                    <h5 class="card-title">Clientes</h5>
                                    <p class="card-text small">Cadastros e atividade de clientes</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="card report-card" data-report-type="services">
                                <div class="card-body text-center py-4">
                                    <i class="fas fa-list-alt fa-3x text-warning mb-3"></i>
                                    <h5 class="card-title">Serviços</h5>
                                    <p class="card-text small">Serviços mais agendados e tempo médio</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Report Filters -->
            <div class="card shadow mb-4" id="reportFiltersCard">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Filtros do Relatório: <span id="reportTypeName">Selecione um tipo acima</span></h6>
                </div>
                <div class="card-body">
                    <form id="reportFiltersForm">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="reportDateFrom" class="form-label">Data Inicial</label>
                                <input type="date" class="form-control" id="reportDateFrom">
                            </div>
                            <div class="col-md-4">
                                <label for="reportDateTo" class="form-label">Data Final</label>
                                <input type="date" class="form-control" id="reportDateTo">
                            </div>
                            <div class="col-md-4">
                                <label for="reportCompany" class="form-label">Empresa</label>
                                <select class="form-select" id="reportCompany">
                                    <option value="">Todas as empresas</option>
                                    <!-- As empresas serão carregadas dinamicamente -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- Filtros dinâmicos baseados no tipo de relatório -->
                        <!-- Filtros para Faturamento -->
                        <div class="report-specific-filters" id="billingFilters" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="billingType" class="form-label">Tipo de Faturamento</label>
                                    <select class="form-select" id="billingType">
                                        <option value="all">Todos</option>
                                        <option value="appointments">Agendamentos</option>
                                        <option value="plans">Assinaturas de Planos</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="billingStatus" class="form-label">Status de Pagamento</label>
                                    <select class="form-select" id="billingStatus">
                                        <option value="all">Todos</option>
                                        <option value="paid">Pagos</option>
                                        <option value="pending">Pendentes</option>
                                        <option value="failed">Falhos</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="billingPeriod" class="form-label">Agrupamento</label>
                                    <select class="form-select" id="billingPeriod">
                                        <option value="daily">Diário</option>
                                        <option value="weekly">Semanal</option>
                                        <option value="monthly" selected>Mensal</option>
                                        <option value="yearly">Anual</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtros para Agendamentos -->
                        <div class="report-specific-filters" id="appointmentsFilters" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="appointmentStatus" class="form-label">Status</label>
                                    <select class="form-select" id="appointmentStatus">
                                        <option value="all">Todos</option>
                                        <option value="scheduled">Agendados</option>
                                        <option value="completed">Concluídos</option>
                                        <option value="cancelled">Cancelados</option>
                                        <option value="no-show">Não Compareceu</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="appointmentProfessional" class="form-label">Profissional</label>
                                    <select class="form-select" id="appointmentProfessional">
                                        <option value="">Todos os profissionais</option>
                                        <!-- Os profissionais serão carregados dinamicamente -->
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="appointmentView" class="form-label">Visualização</label>
                                    <select class="form-select" id="appointmentView">
                                        <option value="summary">Resumo</option>
                                        <option value="detailed">Detalhado</option>
                                        <option value="byProfessional">Por Profissional</option>
                                        <option value="byService">Por Serviço</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtros para Clientes -->
                        <div class="report-specific-filters" id="clientsFilters" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="clientStatus" class="form-label">Status</label>
                                    <select class="form-select" id="clientStatus">
                                        <option value="all">Todos</option>
                                        <option value="active">Ativos</option>
                                        <option value="inactive">Inativos</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="clientRegistration" class="form-label">Registro</label>
                                    <select class="form-select" id="clientRegistration">
                                        <option value="all">Todos</option>
                                        <option value="new">Novos no período</option>
                                        <option value="returning">Recorrentes</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="clientView" class="form-label">Visualização</label>
                                    <select class="form-select" id="clientView">
                                        <option value="summary">Resumo</option>
                                        <option value="detailed">Detalhado</option>
                                        <option value="byFrequency">Por Frequência</option>
                                        <option value="byCompany">Por Empresa</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtros para Serviços -->
                        <div class="report-specific-filters" id="servicesFilters" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="serviceType" class="form-label">Categoria</label>
                                    <select class="form-select" id="serviceType">
                                        <option value="all">Todas</option>
                                        <option value="hair">Cabelo</option>
                                        <option value="face">Rosto</option>
                                        <option value="nails">Unhas</option>
                                        <option value="body">Corpo</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="serviceRanking" class="form-label">Classificação</label>
                                    <select class="form-select" id="serviceRanking">
                                        <option value="mostScheduled">Mais Agendados</option>
                                        <option value="mostProfitable">Mais Rentáveis</option>
                                        <option value="longestDuration">Maior Duração</option>
                                        <option value="shortestDuration">Menor Duração</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="serviceView" class="form-label">Visualização</label>
                                    <select class="form-select" id="serviceView">
                                        <option value="summary">Resumo</option>
                                        <option value="detailed">Detalhado</option>
                                        <option value="byCompany">Por Empresa</option>
                                        <option value="trend">Tendência Temporal</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12 text-end">
                                <button type="reset" class="btn btn-secondary me-2" id="resetFiltersBtn">
                                    <i class="fas fa-eraser me-1"></i> Limpar
                                </button>
                                <button type="button" class="btn btn-primary" id="generateReportBtn" disabled>
                                    <i class="fas fa-chart-line me-1"></i> Gerar Relatório
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Report Results -->
            <div class="card shadow mb-4" id="reportResultsCard" style="display: none;">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Resultados: <span id="reportResultTitle"></span></h6>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="printReportBtn">
                            <i class="fas fa-print me-1"></i> Imprimir
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Charts Container -->
                    <div class="row mb-4">
                        <div class="col-lg-8 mb-4" id="chartContainer">
                            <div class="chart-container" style="position: relative; height:350px;">
                                <canvas id="mainChart"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4" id="statsContainer">
                            <div class="card border-left-primary shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1" id="statTitle1">Total</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="statValue1">0</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-calendar fa-2x text-gray-300" id="statIcon1"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card border-left-success shadow h-100 py-2 mt-4">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1" id="statTitle2">Média</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="statValue2">0</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-dollar-sign fa-2x text-gray-300" id="statIcon2"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card border-left-info shadow h-100 py-2 mt-4">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1" id="statTitle3">Crescimento</div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="statValue3">0%</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-percent fa-2x text-gray-300" id="statIcon3"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Table Container -->
                    <div class="table-responsive mt-3">
                        <table class="table table-bordered table-hover" id="reportDataTable" width="100%" cellspacing="0">
                            <thead>
                                <tr id="reportTableHeader">
                                    <!-- Cabeçalhos serão gerados dinamicamente -->
                                </tr>
                            </thead>
                            <tbody id="reportTableBody">
                                <!-- Dados serão carregados dinamicamente -->
                            </tbody>
                            <tfoot id="reportTableFooter">
                                <!-- Rodapés serão gerados dinamicamente se necessário -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Dados simulados para os relatórios
    const reportData = {
        // Dados de faturamento (simulados)
        billing: {
            monthly: [
                { period: 'Janeiro', total: 25800, appointments: 18500, plans: 7300, growth: 0 },
                { period: 'Fevereiro', total: 27400, appointments: 19200, plans: 8200, growth: 6.2 },
                { period: 'Março', total: 31500, appointments: 22100, plans: 9400, growth: 15.0 },
                { period: 'Abril', total: 33200, appointments: 23800, plans: 9400, growth: 5.4 },
                { period: 'Maio', total: 35100, appointments: 25300, plans: 9800, growth: 5.7 },
                { period: 'Junho', total: 38700, appointments: 27500, plans: 11200, growth: 10.3 }
            ],
            weekly: [
                { period: 'Semana 1', total: 8700, appointments: 6200, plans: 2500, growth: 0 },
                { period: 'Semana 2', total: 9100, appointments: 6400, plans: 2700, growth: 4.6 },
                { period: 'Semana 3', total: 10300, appointments: 7200, plans: 3100, growth: 13.2 },
                { period: 'Semana 4', total: 10600, appointments: 7700, plans: 2900, growth: 2.9 }
            ],
            byCompany: [
                { company: 'Salão Beleza Total', total: 15800, appointments: 12300, plans: 3500 },
                { company: 'Estética Sempre Bela', total: 11200, appointments: 8800, plans: 2400 },
                { company: 'Barbearia Modern Cut', total: 7300, appointments: 4800, plans: 2500 },
                { company: 'Clínica Estética Renascer', total: 4400, appointments: 1600, plans: 2800 }
            ]
        },
        
        // Dados de agendamentos (simulados)
        appointments: {
            summary: {
                total: 835,
                completed: 712,
                cancelled: 89,
                noShow: 34,
                byStatus: [
                    { status: 'Concluídos', count: 712, percentage: 85.3 },
                    { status: 'Cancelados', count: 89, percentage: 10.7 },
                    { status: 'Não Compareceu', count: 34, percentage: 4.0 }
                ],
                byDay: [
                    { day: 'Segunda', count: 145 },
                    { day: 'Terça', count: 132 },
                    { day: 'Quarta', count: 138 },
                    { day: 'Quinta', count: 150 },
                    { day: 'Sexta', count: 165 },
                    { day: 'Sábado', count: 105 },
                    { day: 'Domingo', count: 0 }
                ]
            },
            byProfessional: [
                { professional: 'Ana Silva', total: 135, completed: 118, cancelled: 12, noShow: 5 },
                { professional: 'João Barbosa', total: 142, completed: 129, cancelled: 8, noShow: 5 },
                { professional: 'Carla Ferreira', total: 98, completed: 85, cancelled: 9, noShow: 4 },
                { professional: 'Lucas Oliveira', total: 110, completed: 89, cancelled: 16, noShow: 5 },
                { professional: 'Mariana Santos', total: 124, completed: 103, cancelled: 15, noShow: 6 },
                { professional: 'Paulo Mendes', total: 126, completed: 108, cancelled: 11, noShow: 7 },
                { professional: 'Outros', total: 100, completed: 80, cancelled: 18, noShow: 2 }
            ],
            byService: [
                { service: 'Corte Feminino', total: 180, revenue: 7200 },
                { service: 'Corte Masculino', total: 195, revenue: 5850 },
                { service: 'Coloração', total: 120, revenue: 9600 },
                { service: 'Barba', total: 85, revenue: 1700 },
                { service: 'Manicure', total: 110, revenue: 3300 },
                { service: 'Maquiagem', total: 45, revenue: 3150 },
                { service: 'Outros', total: 100, revenue: 5000 }
            ]
        },
        
        // Dados de clientes (simulados)
        clients: {
            summary: {
                total: 1250,
                active: 980,
                inactive: 270,
                new: 145,
                returning: 835,
                byGender: [
                    { gender: 'Feminino', count: 820, percentage: 65.6 },
                    { gender: 'Masculino', count: 390, percentage: 31.2 },
                    { gender: 'Outro/Não informado', count: 40, percentage: 3.2 }
                ]
            },
            byFrequency: [
                { frequency: '1 vez', count: 340 },
                { frequency: '2-5 vezes', count: 425 },
                { frequency: '6-10 vezes', count: 280 },
                { frequency: 'Mais de 10 vezes', count: 205 }
            ],
            byCompany: [
                { company: 'Salão Beleza Total', total: 480, active: 385, inactive: 95, new: 55 },
                { company: 'Estética Sempre Bela', total: 320, active: 260, inactive: 60, new: 35 },
                { company: 'Barbearia Modern Cut', total: 290, active: 215, inactive: 75, new: 40 },
                { company: 'Clínica Estética Renascer', total: 160, active: 120, inactive: 40, new: 15 }
            ]
        },
        
        // Dados de serviços (simulados)
        services: {
            mostScheduled: [
                { service: 'Corte Masculino', count: 195, percentage: 23.4 },
                { service: 'Corte Feminino', count: 180, percentage: 21.6 },
                { service: 'Coloração', count: 120, percentage: 14.4 },
                { service: 'Manicure', count: 110, percentage: 13.2 },
                { service: 'Barba', count: 85, percentage: 10.2 },
                { service: 'Maquiagem', count: 45, percentage: 5.4 },
                { service: 'Outros', count: 100, percentage: 12.0 }
            ],
            mostProfitable: [
                { service: 'Coloração', revenue: 9600, percentage: 25.3 },
                { service: 'Corte Feminino', revenue: 7200, percentage: 19.0 },
                { service: 'Corte Masculino', revenue: 5850, percentage: 15.4 },
                { service: 'Outros', revenue: 5000, percentage: 13.2 },
                { service: 'Manicure', revenue: 3300, percentage: 8.7 },
                { service: 'Maquiagem', revenue: 3150, percentage: 8.3 },
                { service: 'Barba', revenue: 1700, percentage: 4.5 }
            ],
            byCategory: [
                { category: 'Cabelo', count: 495, revenue: 22650 },
                { category: 'Rosto', count: 130, revenue: 7850 },
                { category: 'Unhas', count: 110, revenue: 3300 },
                { category: 'Corpo', count: 100, revenue: 6000 }
            ]
        }
    };

    // Dados simulados de empresas, profissionais e serviços
    const companies = [
        { id: 1001, name: "Salão Beleza Total", status: "active" },
        { id: 1002, name: "Estética Sempre Bela", status: "active" },
        { id: 1003, name: "Barbearia Modern Cut", status: "trial" },
        { id: 1004, name: "Clínica Estética Renascer", status: "active" }
    ];

    const professionals = [
        { id: 1001, name: "Ana Silva", companyId: 1001 },
        { id: 1002, name: "João Barbosa", companyId: 1003 },
        { id: 1003, name: "Carla Ferreira", companyId: 1002 },
        { id: 1004, name: "Lucas Oliveira", companyId: 1004 },
        { id: 1005, name: "Mariana Santos", companyId: 1001 },
        { id: 1006, name: "Paulo Mendes", companyId: 1003 }
    ];

    // Inicialização da página
    document.addEventListener('DOMContentLoaded', function() {
        // Configuração do logout
        document.getElementById('logout-button')?.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Botão de logout clicado');
            
            // Limpar localStorage diretamente
            localStorage.removeItem('agendai_auth');
            console.log('Dados de autenticação removidos do localStorage');
            
            // Redirecionar para a página de login
            window.location.href = 'http://localhost:3001/';
            console.log('Redirecionando para a página inicial');
        });

        // Inicialização da página de relatórios
        initReportsPage();
    });

    // Função principal de inicialização
    function initReportsPage() {
        console.log('Página de relatórios inicializada!');
        
        // Definir datas padrão (últimos 30 dias)
        setDefaultDates();
        
        // Carregar empresas no select
        loadCompanies();
        
        // Carregar profissionais no select
        loadProfessionals();
        
        // Configurar eventos de interface
        setupEventListeners();
    }

    // Definir datas padrão (últimos 30 dias)
    function setDefaultDates() {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        const dateToInput = formatDateForInput(today);
        const dateFromInput = formatDateForInput(thirtyDaysAgo);
        
        document.getElementById('reportDateTo').value = dateToInput;
        document.getElementById('reportDateFrom').value = dateFromInput;
    }

    // Formatar data para input type date (YYYY-MM-DD)
    function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Carregar empresas no select
    function loadCompanies() {
        const companySelect = document.getElementById('reportCompany');
        if (!companySelect) return;
        
        // Tentar obter empresas do localStorage
        let storedCompanies = [];
        try {
            const companiesData = localStorage.getItem('agendai_companies');
            if (companiesData) {
                storedCompanies = JSON.parse(companiesData);
            }
        } catch (error) {
            console.error('Erro ao carregar empresas do localStorage:', error);
        }
        
        // Se não houver empresas no localStorage, usar as empresas simuladas
        const companiesToUse = storedCompanies.length > 0 ? storedCompanies : companies;
        
        // Adicionar as empresas como opções
        companiesToUse.forEach(company => {
            if (company.status !== 'inactive') {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.name;
                companySelect.appendChild(option);
            }
        });
        
        console.log('Empresas carregadas no select.');
    }

    // Carregar profissionais no select
    function loadProfessionals() {
        const professionalSelect = document.getElementById('appointmentProfessional');
        if (!professionalSelect) return;
        
        // Tentar obter profissionais do localStorage
        let storedProfessionals = [];
        try {
            const professionalsData = localStorage.getItem('agendai_professionals');
            if (professionalsData) {
                storedProfessionals = JSON.parse(professionalsData);
            }
        } catch (error) {
            console.error('Erro ao carregar profissionais do localStorage:', error);
        }
        
        // Se não houver profissionais no localStorage, usar os profissionais simulados
        const professionalsToUse = storedProfessionals.length > 0 ? storedProfessionals : professionals;
        
        // Adicionar os profissionais como opções
        professionalsToUse.forEach(professional => {
            const option = document.createElement('option');
            option.value = professional.id;
            option.textContent = professional.name;
            professionalSelect.appendChild(option);
        });
        
        console.log('Profissionais carregados no select.');
    }

    // Configurar listeners de eventos
    function setupEventListeners() {
        // Selecionar tipo de relatório
        document.querySelectorAll('.report-card').forEach(card => {
            card.addEventListener('click', function() {
                const reportType = this.getAttribute('data-report-type');
                selectReportType(reportType);
            });
            
            // Adicionar efeito hover
            card.addEventListener('mouseenter', function() {
                this.classList.add('border-primary');
                this.style.cursor = 'pointer';
            });
            
            card.addEventListener('mouseleave', function() {
                this.classList.remove('border-primary');
            });
        });
        
        // Botão para gerar relatório
        document.getElementById('generateReportBtn')?.addEventListener('click', generateReport);
        
        // Botão para limpar filtros
        document.getElementById('resetFiltersBtn')?.addEventListener('click', function() {
            document.getElementById('reportFiltersForm').reset();
            setDefaultDates();
            
            // Esconder todos os filtros específicos
            document.querySelectorAll('.report-specific-filters').forEach(filter => {
                filter.style.display = 'none';
            });
            
            // Resetar o nome do tipo de relatório
            document.getElementById('reportTypeName').textContent = 'Selecione um tipo acima';
            
            // Desabilitar botão de gerar relatório
            document.getElementById('generateReportBtn').disabled = true;
            
            // Esconder resultados
            document.getElementById('reportResultsCard').style.display = 'none';
        });
        
        // Botões para exportação
        document.getElementById('exportPDF')?.addEventListener('click', function() {
            exportReport('pdf');
        });
        
        document.getElementById('exportExcel')?.addEventListener('click', function() {
            exportReport('excel');
        });
        
        document.getElementById('exportCSV')?.addEventListener('click', function() {
            exportReport('csv');
        });
        
        // Botão para imprimir
        document.getElementById('printReportBtn')?.addEventListener('click', function() {
            window.print();
        });
    }

    // Selecionar tipo de relatório
    function selectReportType(reportType) {
        // Remover seleção anterior
        document.querySelectorAll('.report-card').forEach(card => {
            card.classList.remove('bg-light', 'border-primary', 'shadow');
        });
        
        // Adicionar seleção atual
        const selectedCard = document.querySelector(`.report-card[data-report-type="${reportType}"]`);
        if (selectedCard) {
            selectedCard.classList.add('bg-light', 'border-primary', 'shadow');
        }
        
        // Atualizar nome do tipo de relatório
        const reportTypeNames = {
            'billing': 'Faturamento',
            'appointments': 'Agendamentos',
            'clients': 'Clientes',
            'services': 'Serviços'
        };
        document.getElementById('reportTypeName').textContent = reportTypeNames[reportType] || 'Desconhecido';
        
        // Esconder todos os filtros específicos
        document.querySelectorAll('.report-specific-filters').forEach(filter => {
            filter.style.display = 'none';
        });
        
        // Mostrar apenas os filtros do tipo selecionado
        const specificFilters = document.getElementById(`${reportType}Filters`);
        if (specificFilters) {
            specificFilters.style.display = 'block';
        }
        
        // Habilitar botão de gerar relatório
        document.getElementById('generateReportBtn').disabled = false;
    }
    
    // Gerar relatório com base nos filtros
    function generateReport() {
        // Obter tipo de relatório
        const reportType = getSelectedReportType();
        if (!reportType) {
            alert('Selecione um tipo de relatório.');
            return;
        }
        
        // Obter valores dos filtros
        const filters = {
            dateFrom: document.getElementById('reportDateFrom').value,
            dateTo: document.getElementById('reportDateTo').value,
            company: document.getElementById('reportCompany').value
        };
        
        // Adicionar filtros específicos com base no tipo de relatório
        switch (reportType) {
            case 'billing':
                filters.billingType = document.getElementById('billingType').value;
                filters.billingStatus = document.getElementById('billingStatus').value;
                filters.billingPeriod = document.getElementById('billingPeriod').value;
                break;
            case 'appointments':
                filters.appointmentStatus = document.getElementById('appointmentStatus').value;
                filters.appointmentProfessional = document.getElementById('appointmentProfessional').value;
                filters.appointmentView = document.getElementById('appointmentView').value;
                break;
            case 'clients':
                filters.clientStatus = document.getElementById('clientStatus').value;
                filters.clientRegistration = document.getElementById('clientRegistration').value;
                filters.clientView = document.getElementById('clientView').value;
                break;
            case 'services':
                filters.serviceType = document.getElementById('serviceType').value;
                filters.serviceRanking = document.getElementById('serviceRanking').value;
                filters.serviceView = document.getElementById('serviceView').value;
                break;
        }
        
        console.log('Gerando relatório do tipo:', reportType);
        console.log('Filtros:', filters);
        
        // Em uma implementação real, aqui seria uma chamada de API para obter os dados filtrados
        // Para fins de demonstração, estamos usando dados simulados
        const data = getReportData(reportType, filters);
        
        // Exibir resultados
        displayReportResults(reportType, filters, data);
    }
    
    // Obter tipo de relatório selecionado
    function getSelectedReportType() {
        const selectedCard = document.querySelector('.report-card.border-primary');
        return selectedCard ? selectedCard.getAttribute('data-report-type') : null;
    }
    
    // Obter dados do relatório (simulados para demonstração)
    function getReportData(reportType, filters) {
        // Em uma implementação real, aqui seriam aplicados todos os filtros aos dados
        // e seriam obtidos de uma API ou banco de dados
        
        // Para esta demonstração, retornamos dados fixos baseados no tipo de relatório
        switch (reportType) {
            case 'billing':
                // Selecionar dados com base no período
                if (filters.billingPeriod === 'monthly') {
                    return reportData.billing.monthly;
                } else if (filters.billingPeriod === 'weekly') {
                    return reportData.billing.weekly;
                } else {
                    return reportData.billing.byCompany;
                }
            
            case 'appointments':
                // Selecionar dados com base na visualização
                if (filters.appointmentView === 'summary') {
                    return reportData.appointments.summary;
                } else if (filters.appointmentView === 'byProfessional') {
                    return reportData.appointments.byProfessional;
                } else {
                    return reportData.appointments.byService;
                }
            
            case 'clients':
                // Selecionar dados com base na visualização
                if (filters.clientView === 'summary') {
                    return reportData.clients.summary;
                } else if (filters.clientView === 'byFrequency') {
                    return reportData.clients.byFrequency;
                } else {
                    return reportData.clients.byCompany;
                }
            
            case 'services':
                // Selecionar dados com base na classificação
                if (filters.serviceRanking === 'mostScheduled') {
                    return reportData.services.mostScheduled;
                } else if (filters.serviceRanking === 'mostProfitable') {
                    return reportData.services.mostProfitable;
                } else {
                    return reportData.services.byCategory;
                }
            
            default:
                return [];
        }
    }
    
    // Exibir resultados do relatório
    function displayReportResults(reportType, filters, data) {
        // Mostrar o card de resultados
        document.getElementById('reportResultsCard').style.display = 'block';
        
        // Definir título do relatório
        const reportTitles = {
            'billing': 'Relatório de Faturamento',
            'appointments': 'Relatório de Agendamentos',
            'clients': 'Relatório de Clientes',
            'services': 'Relatório de Serviços'
        };
        document.getElementById('reportResultTitle').textContent = reportTitles[reportType];
        
        // Configurar estatísticas, gráfico e tabela com base no tipo de relatório
        switch (reportType) {
            case 'billing':
                displayBillingReport(filters, data);
                break;
            case 'appointments':
                displayAppointmentsReport(filters, data);
                break;
            case 'clients':
                displayClientsReport(filters, data);
                break;
            case 'services':
                displayServicesReport(filters, data);
                break;
        }
    }
    
    // Exibir relatório de faturamento
    function displayBillingReport(filters, data) {
        // Verificar se temos dados
        if (!data || data.length === 0) {
            alert('Nenhum dado encontrado para os filtros selecionados.');
            return;
        }
        
        // Configurar estatísticas
        let total = 0;
        let average = 0;
        let growth = 0;
        
        // Calcular estatísticas
        if (Array.isArray(data)) {
            // Para dados de período (mensal, semanal)
            if (data[0].period) {
                total = data.reduce((sum, item) => sum + item.total, 0);
                average = Math.round(total / data.length);
                growth = data[data.length - 1].growth || 0;
                
                // Configurar estatísticas na interface
                document.getElementById('statTitle1').textContent = 'TOTAL FATURADO';
                document.getElementById('statValue1').textContent = `R$ ${total.toLocaleString('pt-BR')}`;
                document.getElementById('statIcon1').className = 'fas fa-dollar-sign fa-2x text-gray-300';
                
                document.getElementById('statTitle2').textContent = 'MÉDIA POR PERÍODO';
                document.getElementById('statValue2').textContent = `R$ ${average.toLocaleString('pt-BR')}`;
                document.getElementById('statIcon2').className = 'fas fa-calendar fa-2x text-gray-300';
                
                document.getElementById('statTitle3').textContent = 'CRESCIMENTO';
                document.getElementById('statValue3').textContent = `${growth.toFixed(1)}%`;
                document.getElementById('statIcon3').className = 'fas fa-chart-line fa-2x text-gray-300';
                
                // Gerar gráfico
                generateBarChart(
                    data.map(item => item.period),
                    data.map(item => item.total),
                    'Faturamento por Período',
                    'Valor (R$)'
                );
                
                // Gerar tabela
                generateTable(
                    ['Período', 'Faturamento Total', 'Agendamentos', 'Planos', 'Crescimento'],
                    data.map(item => [
                        item.period, 
                        `R$ ${item.total.toLocaleString('pt-BR')}`, 
                        `R$ ${item.appointments.toLocaleString('pt-BR')}`, 
                        `R$ ${item.plans.toLocaleString('pt-BR')}`, 
                        `${item.growth.toFixed(1)}%`
                    ])
                );
            } 
            // Para dados por empresa
            else if (data[0].company) {
                total = data.reduce((sum, item) => sum + item.total, 0);
                average = Math.round(total / data.length);
                
                // Configurar estatísticas na interface
                document.getElementById('statTitle1').textContent = 'TOTAL FATURADO';
                document.getElementById('statValue1').textContent = `R$ ${total.toLocaleString('pt-BR')}`;
                document.getElementById('statIcon1').className = 'fas fa-dollar-sign fa-2x text-gray-300';
                
                document.getElementById('statTitle2').textContent = 'MÉDIA POR EMPRESA';
                document.getElementById('statValue2').textContent = `R$ ${average.toLocaleString('pt-BR')}`;
                document.getElementById('statIcon2').className = 'fas fa-building fa-2x text-gray-300';
                
                document.getElementById('statTitle3').textContent = 'TOTAL EMPRESAS';
                document.getElementById('statValue3').textContent = data.length;
                document.getElementById('statIcon3').className = 'fas fa-store fa-2x text-gray-300';
                
                // Gerar gráfico
                generatePieChart(
                    data.map(item => item.company),
                    data.map(item => item.total),
                    'Faturamento por Empresa'
                );
                
                // Gerar tabela
                generateTable(
                    ['Empresa', 'Faturamento Total', 'Agendamentos', 'Planos'],
                    data.map(item => [
                        item.company, 
                        `R$ ${item.total.toLocaleString('pt-BR')}`, 
                        `R$ ${item.appointments.toLocaleString('pt-BR')}`, 
                        `R$ ${item.plans.toLocaleString('pt-BR')}`
                    ])
                );
            }
        }
    }
    
    // Exibir relatório de agendamentos
    function displayAppointmentsReport(filters, data) {
        // Resumo de agendamentos
        if (filters.appointmentView === 'summary') {
            // Configurar estatísticas na interface
            document.getElementById('statTitle1').textContent = 'TOTAL AGENDAMENTOS';
            document.getElementById('statValue1').textContent = data.total;
            document.getElementById('statIcon1').className = 'fas fa-calendar-check fa-2x text-gray-300';
            
            document.getElementById('statTitle2').textContent = 'TAXA DE CONCLUSÃO';
            document.getElementById('statValue2').textContent = `${(data.completed / data.total * 100).toFixed(1)}%`;
            document.getElementById('statIcon2').className = 'fas fa-check-circle fa-2x text-gray-300';
            
            document.getElementById('statTitle3').textContent = 'CANCELAMENTOS';
            document.getElementById('statValue3').textContent = `${(data.cancelled / data.total * 100).toFixed(1)}%`;
            document.getElementById('statIcon3').className = 'fas fa-times-circle fa-2x text-gray-300';
            
            // Gerar gráfico
            generatePieChart(
                data.byStatus.map(item => item.status),
                data.byStatus.map(item => item.count),
                'Agendamentos por Status'
            );
            
            // Gerar tabela
            generateTable(
                ['Status', 'Quantidade', 'Percentual'],
                data.byStatus.map(item => [
                    item.status, 
                    item.count, 
                    `${item.percentage.toFixed(1)}%`
                ]),
                ['Total', data.total, '100%']
            );
        } 
        // Agendamentos por profissional
        else if (filters.appointmentView === 'byProfessional') {
            const total = data.reduce((sum, item) => sum + item.total, 0);
            
            // Configurar estatísticas na interface
            document.getElementById('statTitle1').textContent = 'TOTAL AGENDAMENTOS';
            document.getElementById('statValue1').textContent = total;
            document.getElementById('statIcon1').className = 'fas fa-calendar-check fa-2x text-gray-300';
            
            document.getElementById('statTitle2').textContent = 'TOTAL PROFISSIONAIS';
            document.getElementById('statValue2').textContent = data.length;
            document.getElementById('statIcon2').className = 'fas fa-user-md fa-2x text-gray-300';
            
            document.getElementById('statTitle3').textContent = 'MÉDIA POR PROFISSIONAL';
            document.getElementById('statValue3').textContent = Math.round(total / data.length);
            document.getElementById('statIcon3').className = 'fas fa-calculator fa-2x text-gray-300';
            
            // Gerar gráfico
            generateBarChart(
                data.map(item => item.professional),
                data.map(item => item.total),
                'Agendamentos por Profissional',
                'Quantidade'
            );
            
            // Gerar tabela
            generateTable(
                ['Profissional', 'Total', 'Concluídos', 'Cancelados', 'Não Compareceu'],
                data.map(item => [
                    item.professional, 
                    item.total, 
                    item.completed, 
                    item.cancelled,
                    item.noShow
                ]),
                ['Total', total, data.reduce((sum, item) => sum + item.completed, 0), 
                data.reduce((sum, item) => sum + item.cancelled, 0),
                data.reduce((sum, item) => sum + item.noShow, 0)]
            );
        } 
        // Agendamentos por serviço
        else {
            const total = data.reduce((sum, item) => sum + item.total, 0);
            const revenue = data.reduce((sum, item) => sum + item.revenue, 0);
            
            // Configurar estatísticas na interface
            document.getElementById('statTitle1').textContent = 'TOTAL AGENDAMENTOS';
            document.getElementById('statValue1').textContent = total;
            document.getElementById('statIcon1').className = 'fas fa-calendar-check fa-2x text-gray-300';
            
            document.getElementById('statTitle2').textContent = 'RECEITA TOTAL';
            document.getElementById('statValue2').textContent = `R$ ${revenue.toLocaleString('pt-BR')}`;
            document.getElementById('statIcon2').className = 'fas fa-dollar-sign fa-2x text-gray-300';
            
            document.getElementById('statTitle3').textContent = 'TICKET MÉDIO';
            document.getElementById('statValue3').textContent = `R$ ${Math.round(revenue / total).toLocaleString('pt-BR')}`;
            document.getElementById('statIcon3').className = 'fas fa-tag fa-2x text-gray-300';
            
            // Gerar gráfico
            generatePieChart(
                data.map(item => item.service),
                data.map(item => item.total),
                'Agendamentos por Serviço'
            );
            
            // Gerar tabela
            generateTable(
                ['Serviço', 'Quantidade', 'Receita', 'Ticket Médio'],
                data.map(item => [
                    item.service, 
                    item.total, 
                    `R$ ${item.revenue.toLocaleString('pt-BR')}`,
                    `R$ ${Math.round(item.revenue / item.total).toLocaleString('pt-BR')}`
                ]),
                ['Total', total, `R$ ${revenue.toLocaleString('pt-BR')}`, 
                `R$ ${Math.round(revenue / total).toLocaleString('pt-BR')}`]
            );
        }
    }
    
    // Exibir relatório de clientes
    function displayClientsReport(filters, data) {
        // Resumo de clientes
        if (filters.clientView === 'summary') {
            // Configurar estatísticas na interface
            document.getElementById('statTitle1').textContent = 'TOTAL CLIENTES';
            document.getElementById('statValue1').textContent = data.total;
            document.getElementById('statIcon1').className = 'fas fa-users fa-2x text-gray-300';
            
            document.getElementById('statTitle2').textContent = 'CLIENTES ATIVOS';
            document.getElementById('statValue2').textContent = `${(data.active / data.total * 100).toFixed(1)}%`;
            document.getElementById('statIcon2').className = 'fas fa-user-check fa-2x text-gray-300';
            
            document.getElementById('statTitle3').textContent = 'NOVOS CLIENTES';
            document.getElementById('statValue3').textContent = data.new;
            document.getElementById('statIcon3').className = 'fas fa-user-plus fa-2x text-gray-300';
            
            // Gerar gráfico
            generatePieChart(
                data.byGender.map(item => item.gender),
                data.byGender.map(item => item.count),
                'Clientes por Gênero'
            );
            
            // Gerar tabela
            generateTable(
                ['Status', 'Quantidade', 'Percentual'],
                [
                    ['Ativos', data.active, `${(data.active / data.total * 100).toFixed(1)}%`],
                    ['Inativos', data.inactive, `${(data.inactive / data.total * 100).toFixed(1)}%`],
                    ['Novos no Período', data.new, `${(data.new / data.total * 100).toFixed(1)}%`],
                    ['Recorrentes', data.returning, `${(data.returning / data.total * 100).toFixed(1)}%`]
                ],
                ['Total', data.total, '100%']
            );
        }
        // Clientes por frequência
        else if (filters.clientView === 'byFrequency') {
            const total = data.reduce((sum, item) => sum + item.count, 0);
            
            // Configurar estatísticas na interface
            document.getElementById('statTitle1').textContent = 'TOTAL CLIENTES';
            document.getElementById('statValue1').textContent = total;
            document.getElementById('statIcon1').className = 'fas fa-users fa-2x text-gray-300';
            
            document.getElementById('statTitle2').textContent = 'CLIENTES RECORRENTES';
            const recurring = data.filter(item => item.frequency !== '1 vez').reduce((sum, item) => sum + item.count, 0);
            document.getElementById('statValue2').textContent = `${(recurring / total * 100).toFixed(1)}%`;
            document.getElementById('statIcon2').className = 'fas fa-redo fa-2x text-gray-300';
            
            document.getElementById('statTitle3').textContent = 'CLIENTES FREQUENTES';
            const frequent = data.filter(item => item.frequency === 'Mais de 10 vezes').reduce((sum, item) => sum + item.count, 0);
            document.getElementById('statValue3').textContent = frequent;
            document.getElementById('statIcon3').className = 'fas fa-star fa-2x text-gray-300';
            
            // Gerar gráfico
            generatePieChart(
                data.map(item => item.frequency),
                data.map(item => item.count),
                'Clientes por Frequência de Visitas'
            );
            
            // Gerar tabela
            generateTable(
                ['Frequência', 'Quantidade', 'Percentual'],
                data.map(item => [
                    item.frequency,
                    item.count,
                    `${(item.count / total * 100).toFixed(1)}%`
                ]),
                ['Total', total, '100%']
            );
        }
        // Clientes por empresa
        else {
            const total = data.reduce((sum, item) => sum + item.total, 0);
            const active = data.reduce((sum, item) => sum + item.active, 0);
            const newClients = data.reduce((sum, item) => sum + item.new, 0);
            
            // Configurar estatísticas na interface
            document.getElementById('statTitle1').textContent = 'TOTAL CLIENTES';
            document.getElementById('statValue1').textContent = total;
            document.getElementById('statIcon1').className = 'fas fa-users fa-2x text-gray-300';
            
            document.getElementById('statTitle2').textContent = 'CLIENTES ATIVOS';
            document.getElementById('statValue2').textContent = `${(active / total * 100).toFixed(1)}%`;
            document.getElementById('statIcon2').className = 'fas fa-user-check fa-2x text-gray-300';
            
            document.getElementById('statTitle3').textContent = 'NOVOS CLIENTES';
            document.getElementById('statValue3').textContent = newClients;
            document.getElementById('statIcon3').className = 'fas fa-user-plus fa-2x text-gray-300';
            
            // Gerar gráfico
            generateBarChart(
                data.map(item => item.company),
                data.map(item => item.total),
                'Clientes por Empresa',
                'Quantidade'
            );
            
            // Gerar tabela
            generateTable(
                ['Empresa', 'Total Clientes', 'Ativos', 'Inativos', 'Novos'],
                data.map(item => [
                    item.company,
                    item.total,
                    item.active,
                    item.inactive,
                    item.new
                ]),
                ['Total', total, active, total - active, newClients]
            );
        }
    }
    
    // Exibir relatório de serviços
    function displayServicesReport(filters, data) {
        // Serviços mais agendados
        if (filters.serviceRanking === 'mostScheduled') {
            const total = data.reduce((sum, item) => sum + item.count, 0);
            
            // Configurar estatísticas na interface
            document.getElementById('statTitle1').textContent = 'TOTAL AGENDAMENTOS';
            document.getElementById('statValue1').textContent = total;
            document.getElementById('statIcon1').className = 'fas fa-calendar-check fa-2x text-gray-300';
            
            document.getElementById('statTitle2').textContent = 'SERVIÇOS ANALISADOS';
            document.getElementById('statValue2').textContent = data.length;
            document.getElementById('statIcon2').className = 'fas fa-list-alt fa-2x text-gray-300';
            
            document.getElementById('statTitle3').textContent = 'SERVIÇO MAIS POPULAR';
            document.getElementById('statValue3').textContent = data[0].service;
            document.getElementById('statIcon3').className = 'fas fa-trophy fa-2x text-gray-300';
            
            // Gerar gráfico
            generateBarChart(
                data.map(item => item.service),
                data.map(item => item.count),
                'Serviços Mais Agendados',
                'Quantidade'
            );
            
            // Gerar tabela
            generateTable(
                ['Serviço', 'Quantidade', 'Percentual'],
                data.map(item => [
                    item.service,
                    item.count,
                    `${item.percentage.toFixed(1)}%`
                ]),
                ['Total', total, '100%']
            );
        }
        // Serviços mais rentáveis
        else if (filters.serviceRanking === 'mostProfitable') {
            const total = data.reduce((sum, item) => sum + item.revenue, 0);
            
            // Configurar estatísticas na interface
            document.getElementById('statTitle1').textContent = 'RECEITA TOTAL';
            document.getElementById('statValue1').textContent = `R$ ${total.toLocaleString('pt-BR')}`;
            document.getElementById('statIcon1').className = 'fas fa-dollar-sign fa-2x text-gray-300';
            
            document.getElementById('statTitle2').textContent = 'SERVIÇOS ANALISADOS';
            document.getElementById('statValue2').textContent = data.length;
            document.getElementById('statIcon2').className = 'fas fa-list-alt fa-2x text-gray-300';
            
            document.getElementById('statTitle3').textContent = 'SERVIÇO MAIS RENTÁVEL';
            document.getElementById('statValue3').textContent = data[0].service;
            document.getElementById('statIcon3').className = 'fas fa-trophy fa-2x text-gray-300';
            
            // Gerar gráfico
            generatePieChart(
                data.map(item => item.service),
                data.map(item => item.revenue),
                'Serviços por Receita'
            );
            
            // Gerar tabela
            generateTable(
                ['Serviço', 'Receita', 'Percentual'],
                data.map(item => [
                    item.service,
                    `R$ ${item.revenue.toLocaleString('pt-BR')}`,
                    `${item.percentage.toFixed(1)}%`
                ]),
                ['Total', `R$ ${total.toLocaleString('pt-BR')}`, '100%']
            );
        }
        // Serviços por categoria
        else {
            const totalCount = data.reduce((sum, item) => sum + item.count, 0);
            const totalRevenue = data.reduce((sum, item) => sum + item.revenue, 0);
            
            // Configurar estatísticas na interface
            document.getElementById('statTitle1').textContent = 'TOTAL AGENDAMENTOS';
            document.getElementById('statValue1').textContent = totalCount;
            document.getElementById('statIcon1').className = 'fas fa-calendar-check fa-2x text-gray-300';
            
            document.getElementById('statTitle2').textContent = 'RECEITA TOTAL';
            document.getElementById('statValue2').textContent = `R$ ${totalRevenue.toLocaleString('pt-BR')}`;
            document.getElementById('statIcon2').className = 'fas fa-dollar-sign fa-2x text-gray-300';
            
            document.getElementById('statTitle3').textContent = 'TICKET MÉDIO';
            document.getElementById('statValue3').textContent = `R$ ${Math.round(totalRevenue / totalCount).toLocaleString('pt-BR')}`;
            document.getElementById('statIcon3').className = 'fas fa-tag fa-2x text-gray-300';
            
            // Gerar gráfico
            generatePieChart(
                data.map(item => item.category),
                data.map(item => item.count),
                'Serviços por Categoria'
            );
            
            // Gerar tabela
            generateTable(
                ['Categoria', 'Quantidade', 'Receita', 'Ticket Médio'],
                data.map(item => [
                    item.category,
                    item.count,
                    `R$ ${item.revenue.toLocaleString('pt-BR')}`,
                    `R$ ${Math.round(item.revenue / item.count).toLocaleString('pt-BR')}`
                ]),
                ['Total', totalCount, `R$ ${totalRevenue.toLocaleString('pt-BR')}`, 
                `R$ ${Math.round(totalRevenue / totalCount).toLocaleString('pt-BR')}`]
            );
        }
    }

    // Gerar tabela de dados
    function generateTable(headers, rows, footer = null) {
        const tableHeader = document.getElementById('reportTableHeader');
        const tableBody = document.getElementById('reportTableBody');
        const tableFooter = document.getElementById('reportTableFooter');
        
        // Limpar conteúdo existente
        tableHeader.innerHTML = '';
        tableBody.innerHTML = '';
        tableFooter.innerHTML = '';
        
        // Adicionar cabeçalhos
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            tableHeader.appendChild(th);
        });
        
        // Adicionar linhas
        rows.forEach(row => {
            const tr = document.createElement('tr');
            row.forEach(cell => {
                const td = document.createElement('td');
                td.textContent = cell;
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
        
        // Adicionar rodapé (opcional)
        if (footer) {
            const tr = document.createElement('tr');
            tr.classList.add('font-weight-bold', 'bg-light');
            footer.forEach(cell => {
                const td = document.createElement('td');
                td.textContent = cell;
                tr.appendChild(td);
            });
            tableFooter.appendChild(tr);
        }
    }
    
    // Gerar gráfico de barras
    function generateBarChart(labels, data, title, yAxisLabel) {
        // Verificar se já existe um gráfico e destruí-lo
        if (window.currentChart) {
            window.currentChart.destroy();
        }
        
        // Obter o contexto do canvas
        const ctx = document.getElementById('mainChart').getContext('2d');
        
        // Gerar cores aleatórias
        const colors = generateRandomColors(labels.length);
        
        // Criar o gráfico
        window.currentChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: title,
                    data: data,
                    backgroundColor: colors,
                    borderColor: colors.map(color => color.replace('0.6', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: title,
                        font: {
                            size: 16
                        }
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: yAxisLabel
                        }
                    }
                }
            }
        });
    }
    
    // Gerar gráfico de pizza
    function generatePieChart(labels, data, title) {
        // Verificar se já existe um gráfico e destruí-lo
        if (window.currentChart) {
            window.currentChart.destroy();
        }
        
        // Obter o contexto do canvas
        const ctx = document.getElementById('mainChart').getContext('2d');
        
        // Gerar cores aleatórias
        const colors = generateRandomColors(labels.length);
        
        // Criar o gráfico
        window.currentChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderColor: colors.map(color => color.replace('0.6', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: title,
                        font: {
                            size: 16
                        }
                    },
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }
    
    // Gerar cores aleatórias para os gráficos
    function generateRandomColors(count) {
        // Conjunto predefinido de cores para garantir boa visualização
        const predefinedColors = [
            'rgba(54, 162, 235, 0.6)',   // Azul
            'rgba(255, 99, 132, 0.6)',   // Vermelho
            'rgba(75, 192, 192, 0.6)',   // Verde água
            'rgba(255, 159, 64, 0.6)',   // Laranja
            'rgba(153, 102, 255, 0.6)',  // Roxo
            'rgba(255, 205, 86, 0.6)',   // Amarelo
            'rgba(201, 203, 207, 0.6)',  // Cinza
            'rgba(255, 99, 255, 0.6)',   // Rosa
            'rgba(99, 255, 132, 0.6)',   // Verde claro
            'rgba(99, 255, 255, 0.6)'    // Ciano
        ];
        
        // Se houver mais dados que cores predefinidas, gerar cores aleatórias adicionais
        if (count <= predefinedColors.length) {
            return predefinedColors.slice(0, count);
        } else {
            const colors = [...predefinedColors];
            for (let i = predefinedColors.length; i < count; i++) {
                const r = Math.floor(Math.random() * 255);
                const g = Math.floor(Math.random() * 255);
                const b = Math.floor(Math.random() * 255);
                colors.push(`rgba(${r}, ${g}, ${b}, 0.6)`);
            }
            return colors;
        }
    }
    
    // Exportar relatório
    function exportReport(format) {
        // Obter tipo de relatório atual
        const reportType = getSelectedReportType();
        if (!reportType) {
            alert('Nenhum relatório gerado para exportar.');
            return;
        }
        
        // Verificar se o card de resultado está visível
        if (document.getElementById('reportResultsCard').style.display === 'none') {
            alert('Gere um relatório antes de exportá-lo.');
            return;
        }
        
        // Título do relatório
        const reportTitles = {
            'billing': 'Relatório de Faturamento',
            'appointments': 'Relatório de Agendamentos',
            'clients': 'Relatório de Clientes',
            'services': 'Relatório de Serviços'
        };
        const title = reportTitles[reportType];
        
        // Em uma implementação real, esta função faria uma requisição ao servidor para gerar o arquivo
        // Para esta demonstração, apenas simulamos o comportamento
        
        // Formatar nome do arquivo
        const date = new Date();
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const fileName = `${title.toLowerCase().replace(/ /g, '-')}-${dateStr}`;
        
        switch (format) {
            case 'pdf':
                alert(`Em uma implementação real, isso geraria um PDF chamado "${fileName}.pdf" com o conteúdo do relatório atual.`);
                break;
            case 'excel':
                alert(`Em uma implementação real, isso geraria um arquivo Excel chamado "${fileName}.xlsx" com o conteúdo do relatório atual.`);
                break;
            case 'csv':
                alert(`Em uma implementação real, isso geraria um arquivo CSV chamado "${fileName}.csv" com o conteúdo do relatório atual.`);
                break;
        }
    }

    // Adicionando a biblioteca Chart.js para gráficos
    if (typeof Chart === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = function() {
            console.log('Chart.js carregado com sucesso!');
        };
        document.head.appendChild(script);
    }
</script> 
<!-- View de Gest√£o de Empresas para o Dashboard Administrativo -->
<!-- Script de polyfill para Bootstrap Modal -->
<script>
    // Garantir que o Bootstrap Modal funcione corretamente
    window.addEventListener('DOMContentLoaded', function() {
        console.log('Verificando disponibilidade do Bootstrap...');
        
        // Verificar se o Bootstrap ou seu script j√° est√° inclu√≠do
        if (typeof bootstrap === 'undefined') {
            console.log('üö® Bootstrap n√£o detectado. Carregando vers√£o CDN...');
            
            // Carregar CSS do Bootstrap se n√£o estiver presente
            if (!document.querySelector('link[href*="bootstrap"]')) {
                const bootstrapCSS = document.createElement('link');
                bootstrapCSS.rel = 'stylesheet';
                bootstrapCSS.href = 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css';
                document.head.appendChild(bootstrapCSS);
                console.log('‚úÖ CSS do Bootstrap carregado via CDN');
            }
            
            // Carregar JavaScript do Bootstrap
            const bootstrapScript = document.createElement('script');
            bootstrapScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js';
            bootstrapScript.onload = function() {
                console.log('‚úÖ JavaScript do Bootstrap carregado via CDN');
                
                // Inicializar manipuladores ap√≥s carregar
                initializeModalHandlers();
            };
            document.body.appendChild(bootstrapScript);
        } else {
            console.log('‚úÖ Bootstrap j√° est√° dispon√≠vel');
            
            // Bootstrap j√° est√° carregado, inicializar manipuladores diretamente
            initializeModalHandlers();
        }
        
        function initializeModalHandlers() {
            // Garantir que todos os elementos data-bs-dismiss funcionem
            document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(button => {
                button.addEventListener('click', function() {
                    const target = document.querySelector(this.getAttribute('data-bs-target')) || 
                                  this.closest('.modal');
                    if (target) {
                        // Tentar fechar o modal usando Bootstrap
                        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                            const modal = bootstrap.Modal.getInstance(target);
                            if (modal) modal.hide();
                        } else {
                            // Fechar manualmente
                            target.style.display = 'none';
                            target.classList.remove('show');
                            document.body.classList.remove('modal-open');
                            document.querySelector('.modal-backdrop')?.remove();
                        }
                    }
                });
            });
        }
        
        // Se o bootstrap n√£o estiver definido, criar um polyfill
        if (typeof bootstrap === 'undefined' || !bootstrap.Modal) {
            console.log('Bootstrap Modal n√£o detectado. Criando polyfill...');
            
            // Criar namespace bootstrap se n√£o existir
            window.bootstrap = window.bootstrap || {};
            
            // Implementar polyfill para Modal
            bootstrap.Modal = function(element) {
                this.element = element;
                
                this.show = function() {
                    element.style.display = 'block';
                    element.classList.add('show');
                    document.body.classList.add('modal-open');
                    
                    // Adicionar backdrop
                    if (!document.querySelector('.modal-backdrop')) {
                        const backdrop = document.createElement('div');
                        backdrop.className = 'modal-backdrop fade show';
                        document.body.appendChild(backdrop);
                    }
                };
                
                this.hide = function() {
                    element.style.display = 'none';
                    element.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    
                    // Remover backdrop
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                };
                
                // M√©todo est√°tico
                this.constructor.getInstance = function(element) {
                    return new bootstrap.Modal(element);
                };
            };
            
            // Adicionar m√©todo est√°tico getOrCreateInstance
            bootstrap.Modal.getInstance = function(element) {
                // Implementa√ß√£o simples que sempre retorna uma nova inst√¢ncia
                // Em uma implementa√ß√£o real, voc√™ manteria um mapa de elementos para inst√¢ncias
                return new bootstrap.Modal(element);
            };
            
            console.log('Polyfill para Bootstrap Modal criado com sucesso!');
        }
    });
</script>

<div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="border-end bg-white" id="sidebar-wrapper">
        <div class="sidebar-heading bg-primary text-white py-4 d-flex justify-content-center">
            <div class="logo-container">
                <img src="/public/src/img/LogoAgendAIForFooter.png" alt="AgendAI Logo" class="logo-medium">
            </div>
        </div>
        <div class="list-group list-group-flush">
            <a href="#/admin" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-tachometer-alt me-2"></i> Dashboard
            </a>
            <a href="#/admin/plans" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-tag me-2"></i> Planos
            </a>
            <a href="#/admin/companies" class="list-group-item list-group-item-action active" data-link>
                <i class="fas fa-building me-2"></i> Empresas
            </a>
            <a href="#/admin/users" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-users me-2"></i> Usu√°rios
            </a>
            <a href="#/admin/professionals" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-user-md me-2"></i> Profissionais
            </a>
            <a href="#/admin/services" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-list-alt me-2"></i> Servi√ßos
            </a>
            <a href="#/admin/clients" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-user-friends me-2"></i> Clientes
            </a>
            <a href="#/admin/appointments" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-calendar-alt me-2"></i> Agendamentos
            </a>
            <a href="#/admin/reports" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-chart-bar me-2"></i> Relat√≥rios
            </a>
            <a href="#/admin/settings" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-cog me-2"></i> Configura√ß√µes
            </a>
        </div>
    </div>
    
    <!-- Page Content -->
    <div id="page-content-wrapper">
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
                        <li class="nav-item">
                            <button class="btn btn-outline-secondary btn-sm mt-1" id="logout-button">
                                <i class="fas fa-sign-out-alt me-1"></i> Sair
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        
        <!-- Companies Content -->
        <div class="container-fluid p-4">
            <div class="row mb-4">
                <div class="col-md-8">
                    <h2 class="mb-3">Gest√£o de Empresas</h2>
                    <p class="text-muted">Cadastre e gerencie as empresas que utilizam o AgendAI.</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button type="button" class="btn btn-primary" id="newCompanyBtn">
                        <i class="fas fa-plus me-1"></i> Nova Empresa
                    </button>
                    <!-- Bot√£o alternativo para emerg√™ncia (normalmente invis√≠vel) -->
                    <button type="button" class="btn btn-outline-primary ms-2" id="emergencyNewCompanyBtn" style="display: none;">
                        <i class="fas fa-plus me-1"></i> Abrir Formul√°rio (Alt)
                    </button>
                </div>
            </div>
            
            <!-- Filtros -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Filtros</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="filterName" class="form-label">Nome</label>
                            <input type="text" class="form-control" id="filterName" placeholder="Nome da empresa">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="filterPlan" class="form-label">Plano</label>
                            <select class="form-select" id="filterPlan">
                                <option value="">Todos</option>
                                <option value="basic">B√°sico</option>
                                <option value="professional">Profissional</option>
                                <option value="enterprise">Empresarial</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="filterStatus" class="form-label">Status</label>
                            <select class="form-select" id="filterStatus">
                                <option value="">Todos</option>
                                <option value="active">Ativo</option>
                                <option value="inactive">Inativo</option>
                                <option value="trial">Em teste</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="filterDate" class="form-label">Data de cadastro</label>
                            <input type="date" class="form-control" id="filterDate">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="filterCompany" class="form-label">Empresa</label>
                            <select class="form-select" id="filterCompany">
                                <option value="">Todas</option>
                                <!-- As empresas ser√£o carregadas dinamicamente -->
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 text-end">
                            <button type="button" class="btn btn-secondary me-2" id="clearFiltersBtn">
                                <i class="fas fa-eraser me-1"></i> Limpar
                            </button>
                            <button type="button" class="btn btn-primary" id="applyFiltersBtn">
                                <i class="fas fa-search me-1"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Companies Table -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Empresas Cadastradas</h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                            <div class="dropdown-header">Op√ß√µes:</div>
                            <a class="dropdown-item" href="#"><i class="fas fa-file-excel me-2"></i> Exportar Excel</a>
                            <a class="dropdown-item" href="#"><i class="fas fa-file-pdf me-2"></i> Exportar PDF</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#"><i class="fas fa-sync-alt me-2"></i> Atualizar</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="companiesTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>CNPJ</th>
                                    <th>Email</th>
                                    <th>Plano</th>
                                    <th>Status</th>
                                    <th>Data de Cadastro</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Os dados ser√£o carregados dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination -->
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Anterior</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Pr√≥ximo</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Adicionar Empresa -->
<div class="modal fade" id="addCompanyModal" tabindex="-1" aria-labelledby="addCompanyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addCompanyModalLabel">Nova Empresa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="companyForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="companyName" class="form-label">Nome da Empresa*</label>
                            <input type="text" class="form-control" id="companyName" required>
                        </div>
                        <div class="col-md-6">
                            <label for="companyCNPJ" class="form-label">CNPJ*</label>
                            <input type="text" class="form-control" id="companyCNPJ" placeholder="XX.XXX.XXX/0001-XX" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="companyEmail" class="form-label">Email*</label>
                            <input type="email" class="form-control" id="companyEmail" required>
                        </div>
                        <div class="col-md-6">
                            <label for="companyPhone" class="form-label">Telefone*</label>
                            <input type="tel" class="form-control" id="companyPhone" placeholder="(XX) XXXXX-XXXX" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="companyPlan" class="form-label">Plano*</label>
                            <select class="form-select" id="companyPlan" required>
                                <option value="">Selecione...</option>
                                <!-- Os planos ser√£o carregados dinamicamente via JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="companyStatus" class="form-label">Status*</label>
                            <select class="form-select" id="companyStatus" required>
                                <option value="active">Ativo</option>
                                <option value="inactive">Inativo</option>
                                <option value="trial">Em teste</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="companyWebsite" class="form-label">Website</label>
                            <input type="url" class="form-control" id="companyWebsite" placeholder="https://www.exemplo.com.br">
                        </div>
                        <div class="col-md-6">
                            <label for="companyCategory" class="form-label">Categoria*</label>
                            <select class="form-select" id="companyCategory" required>
                                <option value="">Selecione...</option>
                                <option value="salon">Sal√£o de Beleza</option>
                                <option value="barber">Barbearia</option>
                                <option value="clinic">Cl√≠nica Est√©tica</option>
                                <option value="spa">SPA</option>
                                <option value="nail">Manicure & Pedicure</option>
                                <option value="other">Outro</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="companyAddress" class="form-label">Endere√ßo*</label>
                        <input type="text" class="form-control" id="companyAddress" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="companyCity" class="form-label">Cidade*</label>
                            <input type="text" class="form-control" id="companyCity" required>
                        </div>
                        <div class="col-md-4">
                            <label for="companyState" class="form-label">Estado*</label>
                            <select class="form-select" id="companyState" required>
                                <option value="">Selecione...</option>
                                <option value="AC">Acre</option>
                                <option value="AL">Alagoas</option>
                                <option value="AP">Amap√°</option>
                                <option value="AM">Amazonas</option>
                                <option value="BA">Bahia</option>
                                <option value="CE">Cear√°</option>
                                <option value="DF">Distrito Federal</option>
                                <option value="ES">Esp√≠rito Santo</option>
                                <option value="GO">Goi√°s</option>
                                <option value="MA">Maranh√£o</option>
                                <option value="MT">Mato Grosso</option>
                                <option value="MS">Mato Grosso do Sul</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="PA">Par√°</option>
                                <option value="PB">Para√≠ba</option>
                                <option value="PR">Paran√°</option>
                                <option value="PE">Pernambuco</option>
                                <option value="PI">Piau√≠</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="RN">Rio Grande do Norte</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <option value="RO">Rond√¥nia</option>
                                <option value="RR">Roraima</option>
                                <option value="SC">Santa Catarina</option>
                                <option value="SP">S√£o Paulo</option>
                                <option value="SE">Sergipe</option>
                                <option value="TO">Tocantins</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="companyZip" class="form-label">CEP*</label>
                            <input type="text" class="form-control" id="companyZip" placeholder="XXXXX-XXX" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="companyNotes" class="form-label">Observa√ß√µes</label>
                        <textarea class="form-control" id="companyNotes" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Recursos Adicionais</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="featureSMS">
                            <label class="form-check-label" for="featureSMS">Notifica√ß√µes por SMS</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="featureWhatsApp">
                            <label class="form-check-label" for="featureWhatsApp">Notifica√ß√µes por WhatsApp</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="featurePayments">
                            <label class="form-check-label" for="featurePayments">Pagamentos Online</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="featureCustomization">
                            <label class="form-check-label" for="featureCustomization">Personaliza√ß√£o Avan√ßada</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveCompanyBtn">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Logout
    document.getElementById('logout-button')?.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Bot√£o de logout clicado');
            
        // Limpar localStorage diretamente
        localStorage.removeItem('agendai_auth');
        console.log('Dados de autentica√ß√£o removidos do localStorage');
        
        // Redirecionar para a p√°gina de login
        window.location.href = "/";
        console.log('Redirecionando para a p√°gina inicial');
    });

    // Inicializa√ß√£o da p√°gina de empresas
    document.addEventListener('DOMContentLoaded', function() {
        console.log('P√°gina de empresas carregada!');
        
        // Verificar se o modal existe e est√° corretamente configurado
        setTimeout(function() {
            const modalElement = document.getElementById('addCompanyModal');
            if (modalElement) {
                console.log('‚úÖ Modal encontrado no DOM durante inicializa√ß√£o');
                
                // Verificar se os bot√µes de fechar est√£o corretamente configurados
                modalElement.querySelectorAll('[data-bs-dismiss="modal"], button.btn-close, #cancelBtn').forEach(btn => {
                    console.log('Configurando bot√£o de fechar:', btn);
                    
                    // Configurar manipulador direto
                    btn.onclick = function() {
                        console.log('üö™ Bot√£o de fechar clicado (manipulador direto)');
                        modalElement.style.display = 'none';
                        modalElement.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        document.querySelector('.modal-backdrop')?.remove();
                        return false; // Prevenir comportamento padr√£o
                    };
                });
                
                // Verificar se o bot√£o de salvar est√° corretamente configurado
                const saveBtn = document.getElementById('saveCompanyBtn');
                if (saveBtn) {
                    console.log('‚úÖ Bot√£o salvar encontrado durante inicializa√ß√£o');
                }
                
                // Garantir que o bot√£o Nova Empresa est√° configurado
                const newCompanyBtn = document.getElementById('newCompanyBtn');
                if (newCompanyBtn) {
                    console.log('‚úÖ Bot√£o Nova Empresa encontrado durante inicializa√ß√£o');
                } else {
                    console.error('‚ùå Bot√£o Nova Empresa N√ÉO encontrado durante inicializa√ß√£o!');
                }
            } else {
                console.error('‚ùå Modal N√ÉO encontrado no DOM durante inicializa√ß√£o!');
            }
        }, 1000); // Verificar ap√≥s 1 segundo para dar tempo de carregar tudo
        
        // Carregar planos dispon√≠veis no select
        loadAvailablePlans();
        
        // Escutar por atualiza√ß√µes nos planos
        window.addEventListener('plansUpdated', function(event) {
            loadAvailablePlans();
        });
        
        // Controle de falhas do bot√£o principal
        let mainButtonFailCount = 0;
        
        // Configurar bot√£o Nova Empresa para abrir o modal de forma segura
        document.getElementById('newCompanyBtn')?.addEventListener('click', function() {
            console.log('üñ±Ô∏è Clique detectado no bot√£o Nova Empresa');
            
            // Verificar se o bot√£o est√° funcionando corretamente
            try {
                // M√©todo direto - chamar a fun√ß√£o
                openAddCompanyModal();
                
                // Verifica√ß√£o de seguran√ßa - tentar abrir o modal diretamente caso a fun√ß√£o falhe
                setTimeout(function() {
                    const modalElement = document.getElementById('addCompanyModal');
                    if (modalElement && modalElement.style.display !== 'block') {
                        console.log('‚ö†Ô∏è Modal n√£o foi aberto pela fun√ß√£o, tentando m√©todo alternativo');
                        mainButtonFailCount++;
                        
                        // Se falhar mais de uma vez, mostrar o bot√£o alternativo
                        if (mainButtonFailCount >= 2) {
                            const emergencyBtn = document.getElementById('emergencyNewCompanyBtn');
                            if (emergencyBtn) {
                                emergencyBtn.style.display = 'inline-block';
                                console.log('üö® Ativando bot√£o de emerg√™ncia ap√≥s falhas repetidas');
                            }
                        }
                        
                        modalElement.style.display = 'block';
                        modalElement.classList.add('show');
                        document.body.classList.add('modal-open');
                        
                        // Criar backdrop se necess√°rio
                        if (!document.querySelector('.modal-backdrop')) {
                            const backdrop = document.createElement('div');
                            backdrop.className = 'modal-backdrop fade show';
                            document.body.appendChild(backdrop);
                        }
                    }
                }, 500); // Aguardar meio segundo para verificar se o modal abriu
            } catch (error) {
                console.error('‚ùå Erro ao tentar abrir o modal via evento de clique:', error);
                alert('Ocorreu um erro ao abrir o formul√°rio. Tente novamente ou atualize a p√°gina.');
                
                // Mostrar bot√£o de emerg√™ncia em caso de erro
                const emergencyBtn = document.getElementById('emergencyNewCompanyBtn');
                if (emergencyBtn) {
                    emergencyBtn.style.display = 'inline-block';
                    console.log('üö® Ativando bot√£o de emerg√™ncia ap√≥s erro');
                }
            }
        });
        
        // Configurar bot√£o de emerg√™ncia para abrir o modal diretamente
        document.getElementById('emergencyNewCompanyBtn')?.addEventListener('click', function() {
            console.log('üÜò Clique no bot√£o de emerg√™ncia');
            
            try {
                // Abordagem super direta - sem usar a fun√ß√£o padr√£o
                const modalElement = document.getElementById('addCompanyModal');
                if (modalElement) {
                    // Limpar formul√°rio manualmente
                    const form = document.getElementById('companyForm');
                    if (form) form.reset();
                    
                    // Tentar carregar planos
                    loadAvailablePlans();
                    
                    // Exibir modal diretamente
                    modalElement.style.display = 'block';
                    modalElement.classList.add('show');
                    document.body.classList.add('modal-open');
                    
                    // Adicionar backdrop manualmente
                    if (!document.querySelector('.modal-backdrop')) {
                        const backdrop = document.createElement('div');
                        backdrop.className = 'modal-backdrop fade show';
                        document.body.appendChild(backdrop);
                    }
                    
                    console.log('‚úÖ Modal aberto pelo m√©todo de emerg√™ncia');
                } else {
                    console.error('‚ùå Modal n√£o encontrado mesmo com m√©todo de emerg√™ncia');
                    alert('Formul√°rio n√£o encontrado. Por favor, atualize a p√°gina e tente novamente.');
                }
            } catch (error) {
                console.error('üí• Erro no m√©todo de emerg√™ncia:', error);
                alert('Erro cr√≠tico. Por favor, atualize a p√°gina e tente novamente.');
            }
        });
        
        // Configurar todos os links do sidebar para funcionarem corretamente
        document.querySelectorAll('[data-link]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const href = this.getAttribute('href');
                console.log('Clique em link:', href);
                if (typeof App !== 'undefined' && App.navigate) {
                    // Remover o # inicial se existir
                    const path = href.startsWith('#') ? href.substring(1) : href;
                    App.navigate(path);
                } else {
                    window.location.href = href;
                }
            });
        });
        
        // Aqui voc√™ pode inicializar o DataTable ou outras bibliotecas
        // Caso esteja usando Bootstrap puramente, implemente a funcionalidade de filtragem/pagina√ß√£o manualmente
        
        // Configurar bot√µes de a√ß√µes na tabela
        document.querySelectorAll('.view-company').forEach(btn => {
            btn.addEventListener('click', function() {
                const companyId = this.getAttribute('data-id');
                alert(`Visualizar empresa ID: ${companyId}`);
                // Aqui voc√™ pode redirecionar para uma p√°gina de detalhes ou abrir um modal
            });
        });
        
        document.querySelectorAll('.edit-company').forEach(btn => {
            btn.addEventListener('click', function() {
                const companyId = this.getAttribute('data-id');
                alert(`Editar empresa ID: ${companyId}`);
                // Aqui voc√™ pode abrir o modal de edi√ß√£o e carregar os dados da empresa
            });
        });
        
        document.querySelectorAll('.delete-company').forEach(btn => {
            btn.addEventListener('click', function() {
                const companyId = this.getAttribute('data-id');
                if (confirm(`Deseja realmente excluir a empresa ID: ${companyId}?`)) {
                    alert(`Empresa ID: ${companyId} exclu√≠da com sucesso!`);
                    // Aqui voc√™ pode fazer a requisi√ß√£o para excluir a empresa
                }
            });
        });
        
        // Configurar manipuladores para os bot√µes de filtro
        document.getElementById('clearFiltersBtn')?.addEventListener('click', function() {
            document.getElementById('filterName').value = '';
            document.getElementById('filterPlan').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDate').value = '';
        });
        
        document.getElementById('applyFiltersBtn')?.addEventListener('click', function() {
            const name = document.getElementById('filterName').value;
            const plan = document.getElementById('filterPlan').value;
            const status = document.getElementById('filterStatus').value;
            const date = document.getElementById('filterDate').value;
            
            alert(`Filtros aplicados: Nome: ${name}, Plano: ${plan}, Status: ${status}, Data: ${date}`);
            // Aqui voc√™ pode implementar a l√≥gica de filtragem
        });
        
        // Manipulador para o bot√£o salvar no modal de nova empresa
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'saveCompanyBtn') {
                console.log('üìé Bot√£o salvar clicado via delega√ß√£o no HTML original');
                
                // Validar o formul√°rio
                const form = document.getElementById('companyForm');
                if (form && form.checkValidity()) {
                    alert('Empresa cadastrada com sucesso!');
                    // Aqui voc√™ pode fazer a requisi√ß√£o para salvar a empresa
                    
                    // Fechando o modal ap√≥s o cadastro de forma segura
                    try {
                        // Tentar fechar usando Bootstrap
                        const modalElement = document.getElementById('addCompanyModal');
                        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                            // M√©todo 1: Tentar obter inst√¢ncia existente
                            let modalInstance = bootstrap.Modal.getInstance(modalElement);
                            if (modalInstance) {
                                modalInstance.hide();
                            } else {
                                // M√©todo 2: Criar nova inst√¢ncia e fechar
                                modalInstance = new bootstrap.Modal(modalElement);
                                modalInstance.hide();
                            }
                        } else {
                            // M√©todo alternativo: fechar manualmente se Bootstrap n√£o estiver dispon√≠vel
                            modalElement.classList.remove('show');
                            modalElement.style.display = 'none';
                            document.body.classList.remove('modal-open');
                            
                            // Remover backdrop manualmente
                            const backdrop = document.querySelector('.modal-backdrop');
                            if (backdrop) backdrop.remove();
                        }
                        console.log('Modal fechado com sucesso');
                    } catch (error) {
                        console.error('Erro ao fechar modal:', error);
                        // Tente fechar manualmente como √∫ltimo recurso
                        document.getElementById('addCompanyModal').style.display = 'none';
                        document.querySelector('.modal-backdrop')?.remove();
                        document.body.classList.remove('modal-open');
                    }
                } else if (form) {
                    // For√ßa a valida√ß√£o do formul√°rio pelo navegador
                    form.reportValidity();
                }
            }
        });
    });

    // Carregar planos dispon√≠veis no select
    function loadAvailablePlans() {
        const planSelect = document.getElementById('companyPlan');
        if (!planSelect) return;
        
        // Limpar op√ß√µes existentes, exceto a primeira (Selecione...)
        while (planSelect.options.length > 1) {
            planSelect.remove(1);
        }
        
        // Tentar obter planos do localStorage
        let localPlans = [];
        try {
            const storedPlans = localStorage.getItem('agendai_plans');
            if (storedPlans) {
                localPlans = JSON.parse(storedPlans);
            }
        } catch (error) {
            console.error('Erro ao carregar planos:', error);
        }
        
        // Se n√£o houver planos no localStorage, usar os planos padr√£o
        if (!localPlans || localPlans.length === 0) {
            localPlans = [
                { id: 1, name: "B√°sico", price: 50.00 },
                { id: 2, name: "Intermedi√°rio", price: 70.00 },
                { id: 3, name: "Avan√ßado", price: 100.00 }
            ];
        }
        
        // Adicionar os planos ao select
        localPlans.forEach(plan => {
            if (plan.status !== 'inactive') { // N√£o mostrar planos inativos
                const option = document.createElement('option');
                option.value = plan.id;
                option.textContent = `${plan.name} - R$ ${plan.price.toFixed(2)}`;
                planSelect.appendChild(option);
            }
        });
        
        console.log('Planos carregados no formul√°rio:', localPlans);
    }

    // Fun√ß√£o para abrir o modal de nova empresa de forma segura
    function openAddCompanyModal() {
        console.log('üöÄ Iniciando abertura do modal de cadastro de nova empresa...');
        
        try {
            // Obter refer√™ncia ao modal
            const modalElement = document.getElementById('addCompanyModal');
            if (!modalElement) {
                console.error('‚ùå Modal n√£o encontrado no DOM!');
                alert('Erro ao abrir o formul√°rio de cadastro. Modal n√£o encontrado.');
                return;
            }
            
            console.log('üìå Modal encontrado no DOM:', modalElement);
            
            // Limpar o formul√°rio se j√° existir
            const form = document.getElementById('companyForm');
            if (form) {
                try {
                    console.log('üßπ Limpando formul√°rio...');
                    form.reset();
                    
                    // Verificar se o select de planos tem op√ß√µes
                    const planSelect = document.getElementById('companyPlan');
                    if (planSelect && planSelect.options.length <= 1) {
                        console.log('‚ö†Ô∏è Select de planos vazio, carregando planos...');
                        loadAvailablePlans();
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Erro ao resetar formul√°rio:', e);
                }
            }
            
            console.log('üß™ Verificando disponibilidade do Bootstrap...');
            console.log('Bootstrap dispon√≠vel?', typeof bootstrap !== 'undefined');
            console.log('Bootstrap.Modal dispon√≠vel?', typeof bootstrap !== 'undefined' && bootstrap.Modal);
            
            // ABORDAGEM DIRETA: Tentar exibir o modal da maneira mais simples poss√≠vel
            // Esta abordagem for√ßa a exibi√ß√£o do modal independentemente do estado do Bootstrap
            modalElement.style.display = 'block';
            modalElement.classList.add('show');
            document.body.classList.add('modal-open');
                
            // Adicionar backdrop se n√£o existir
            if (!document.querySelector('.modal-backdrop')) {
                console.log('üé≠ Adicionando backdrop manualmente');
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
            }
            
            // Agora, tentar usar o Bootstrap como camada adicional
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                try {
                    console.log('üîÑ Tentando usar API do Bootstrap para garantir exibi√ß√£o');
                    const bootstrapModal = new bootstrap.Modal(modalElement);
                    bootstrapModal.show();
                } catch (e) {
                    console.log('‚ÑπÔ∏è N√£o foi poss√≠vel usar API do Bootstrap, mas o modal j√° deve estar vis√≠vel manualmente');
                }
            }
            
            // Garantir que os bot√µes de fechar funcionem
            modalElement.querySelectorAll('[data-bs-dismiss="modal"], button.btn-close, #cancelBtn').forEach(btn => {
                // Remover listeners anteriores para evitar duplica√ß√£o
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', function() {
                    console.log('üö™ Bot√£o de fechar clicado, fechando modal manualmente');
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    document.querySelector('.modal-backdrop')?.remove();
                });
            });
            
            console.log('‚úÖ Modal aberto manualmente com sucesso!');
            
        } catch (error) {
            console.error('‚ùå Erro fatal ao abrir modal:', error);
            
            // Implementa√ß√£o super emergencial como √∫ltimo recurso
            try {
                const modalElement = document.getElementById('addCompanyModal');
                if (modalElement) {
                    modalElement.style.display = 'block';
                    modalElement.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    modalElement.style.zIndex = '9999';
                    console.log('‚ö†Ô∏è Aplicada solu√ß√£o de emerg√™ncia para exibir o modal');
                }
            } catch (e) {
                console.error('üí• Falha total ao tentar exibir o modal:', e);
                alert('N√£o foi poss√≠vel abrir o formul√°rio. Por favor, tente novamente ou atualize a p√°gina.');
            }
        }
    }
</script> 
<!-- View de Gestão de Planos para o Dashboard Administrativo -->
<!-- Correção para erros de Bootstrap -->
<script>
    // Patch preventivo para problemas do Bootstrap Modal
    window.addEventListener('DOMContentLoaded', function() {
        console.log('Aplicando patches de compatibilidade para o Bootstrap...');
        
        // Garantir que o objeto bootstrap exista
        window.bootstrap = window.bootstrap || {};
        
        // Criar um polyfill para Modal se não existir
        if (!bootstrap.Modal) {
            bootstrap.Modal = function(element) {
                this.element = element;
                
                this.show = function() {
                    element.style.display = 'block';
                    element.classList.add('show');
                    document.body.classList.add('modal-open');
                    
                    // Criar backdrop
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    document.body.appendChild(backdrop);
                };
                
                this.hide = function() {
                    element.style.display = 'none';
                    element.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    
                    // Remover backdrop
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                };
                
                // Método estático
                this.constructor.getInstance = function(element) {
                    return new bootstrap.Modal(element);
                };
            };
        }
        
        // Garantir que o objeto On exista e tenha os métodos necessários
        window.On = window.On || {};
        On.initializeBackdrop = On.initializeBackdrop || function() { 
            console.log('Backdrop inicializado (polyfill)'); 
            return true; 
        };
        
        On.getOrCreateInstance = On.getOrCreateInstance || function() {
            console.log('getOrCreateInstance chamado (polyfill)');
            return { 
                backdrop: true, 
                reset: function() { console.log('Reset chamado (polyfill)'); } 
            };
        };
        
        // Monitorar erros do Bootstrap
        window.addEventListener('error', function(e) {
            if (e.message && (
                e.message.includes('backdrop') || 
                e.message.includes('Cannot read properties')
            )) {
                console.warn('Erro do Bootstrap interceptado:', e.message);
                // Evitar que o erro pare a execução
                e.preventDefault();
                e.stopPropagation();
            }
        }, true);
        
        console.log('Patches aplicados com sucesso');
    });
</script>

<!-- Importar Bootstrap CSS e JS (versão 5.2.3 - mais estável) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

<div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="border-end bg-white" id="sidebar-wrapper">
        <div class="sidebar-heading bg-primary text-white py-4 d-flex justify-content-center">
            <div class="logo-container">
                <img src="/public/src/img/LogoAgendAIForFooter.png" alt="AgendAI Logo" class="logo-medium">
            </div>
        </div>
        <div class="list-group list-group-flush">
            <a href="#/admin" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-tachometer-alt me-2"></i> Dashboard
            </a>
            <a href="#/admin/plans" class="list-group-item list-group-item-action active" data-link>
                <i class="fas fa-tag me-2"></i> Planos
            </a>
            <a href="#/admin/companies" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-building me-2"></i> Empresas
            </a>
            <a href="#/admin/users" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-users me-2"></i> Usuários
            </a>
            <a href="#/admin/professionals" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-user-md me-2"></i> Profissionais
            </a>
            <a href="#/admin/services" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-list-alt me-2"></i> Serviços
            </a>
            <a href="#/admin/clients" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-user-friends me-2"></i> Clientes
            </a>
            <a href="#/admin/appointments" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-calendar-alt me-2"></i> Agendamentos
            </a>
            <a href="#/admin/reports" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-chart-bar me-2"></i> Relatórios
            </a>
            <a href="#/admin/settings" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-cog me-2"></i> Configurações
            </a>
        </div>
    </div>
    
    <!-- Page Content -->
    <div id="page-content-wrapper">
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
                        <li class="nav-item">
                            <button class="btn btn-outline-secondary btn-sm mt-1" id="logout-button">
                                <i class="fas fa-sign-out-alt me-1"></i> Sair
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        
        <!-- Plans Content -->
        <div class="container-fluid p-4">
            <div class="row mb-4" id="headerRow">
                <div class="col-md-8">
                    <h2 class="mb-3">Gestão de Planos</h2>
                    <p class="text-muted">Configure os planos de contratação disponíveis no AgendAI.</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button type="button" class="btn btn-primary" id="newPlanBtn" onclick="openAddPlanModalManually()">
                        <i class="fas fa-plus me-1"></i> Novo Plano
                    </button>
                </div>
            </div>
            
            <!-- Plans Cards -->
            <div class="row mb-4">
                <!-- Os cards de planos serão gerados dinamicamente através do JavaScript -->
            </div>
            
            <!-- Plans Table -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Planos Cadastrados</h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                            <div class="dropdown-header">Opções:</div>
                            <a class="dropdown-item" href="#"><i class="fas fa-file-excel me-2"></i> Exportar Excel</a>
                            <a class="dropdown-item" href="#"><i class="fas fa-file-pdf me-2"></i> Exportar PDF</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#"><i class="fas fa-sync-alt me-2"></i> Atualizar</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="plansTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Preço (R$)</th>
                                    <th>Agendamentos</th>
                                    <th>Profissionais</th>
                                    <th>Serviços</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Os dados da tabela serão gerados dinamicamente através do JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Novo Plano -->
<div class="modal fade" id="addPlanModal" tabindex="-1" aria-labelledby="addPlanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addPlanModalLabel">Novo Plano</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="planName" class="form-label">Nome do Plano*</label>
                            <input type="text" class="form-control" id="planName" value="Novo Plano" required>
                        </div>
                        <div class="col-md-6">
                            <label for="planPrice" class="form-label">Preço (R$)*</label>
                            <input type="number" class="form-control" id="planPrice" step="0.01" min="0" value="50.00" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="planAppointments" class="form-label">Limite de Agendamentos*</label>
                            <input type="number" class="form-control" id="planAppointments" value="50" min="0" required>
                            <div class="form-text">0 para ilimitado</div>
                        </div>
                        <div class="col-md-4">
                            <label for="planProfessionals" class="form-label">Limite de Profissionais*</label>
                            <input type="number" class="form-control" id="planProfessionals" value="2" min="0" required>
                            <div class="form-text">0 para ilimitado</div>
                        </div>
                        <div class="col-md-4">
                            <label for="planServices" class="form-label">Limite de Serviços*</label>
                            <input type="number" class="form-control" id="planServices" value="10" min="0" required>
                            <div class="form-text">0 para ilimitado</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="planStatus" class="form-label">Status*</label>
                            <select class="form-select" id="planStatus" required>
                                <option value="active" selected>Ativo</option>
                                <option value="inactive">Inativo</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="planHighlight" class="form-label">Destaque*</label>
                            <select class="form-select" id="planHighlight" required>
                                <option value="none" selected>Sem Destaque</option>
                                <option value="popular">Popular</option>
                                <option value="recommended">Recomendado</option>
                                <option value="best-value">Melhor Custo-Benefício</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="planDescription" class="form-label">Descrição</label>
                        <textarea class="form-control" id="planDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">Recursos Incluídos</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="featureReports">
                                    <label class="form-check-label" for="featureReports">Relatórios Avançados</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="featureEmailNotifications" checked>
                                    <label class="form-check-label" for="featureEmailNotifications">Notificações por Email</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="featureSmsNotifications">
                                    <label class="form-check-label" for="featureSmsNotifications">Notificações por SMS</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="featureWhatsAppNotifications">
                                    <label class="form-check-label" for="featureWhatsAppNotifications">Notificações por WhatsApp</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="featureCustomization">
                                    <label class="form-check-label" for="featureCustomization">Personalização Avançada</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="featureAPI">
                                    <label class="form-check-label" for="featureAPI">Acesso à API</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelPlanBtn" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="savePlanBtn" onclick="savePlan()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Garantir que o Bootstrap esteja disponível
    (function() {
        if (typeof bootstrap === 'undefined') {
            console.warn('Bootstrap não detectado. Carregando Bootstrap...');
            
            // Carregar CSS se necessário
            if (!document.querySelector('link[href*="bootstrap"]')) {
                const bootstrapCss = document.createElement('link');
                bootstrapCss.rel = 'stylesheet';
                bootstrapCss.href = 'https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css';
                document.head.appendChild(bootstrapCss);
            }
            
            // Carregar JavaScript
            const bootstrapScript = document.createElement('script');
            bootstrapScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js';
            bootstrapScript.onload = function() {
                console.log('Bootstrap carregado com sucesso!');
                
                // Inicializar modais após carregar
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initializeModals);
                } else {
                    initializeModals();
                }
            };
            document.head.appendChild(bootstrapScript);
        } else {
            console.log('Bootstrap já está carregado.');
            
            // Inicializar modais
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeModals);
            } else {
                initializeModals();
            }
        }
        
        // Função para inicializar todos os modais
        function initializeModals() {
            document.querySelectorAll('.modal').forEach(modalElement => {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    try {
                        new bootstrap.Modal(modalElement);
                        console.log(`Modal ${modalElement.id} inicializado com sucesso`);
                    } catch (e) {
                        console.warn(`Erro ao inicializar modal ${modalElement.id}:`, e);
                    }
                }
            });
        }
    })();

    // Polyfill para Bootstrap Modal se necessário
    if (typeof bootstrap === 'undefined' || !bootstrap.Modal) {
        window.bootstrap = window.bootstrap || {};
        
        // Implementar polyfill simples para Modal
        bootstrap.Modal = class BootstrapModalPolyfill {
            constructor(element) {
                this.element = element;
                console.log('Modal polyfill inicializado para', element.id);
            }
            
            show() {
                console.log('Mostrando modal com polyfill');
                this.element.style.display = 'block';
                this.element.classList.add('show');
                document.body.classList.add('modal-open');
                
                // Adicionar backdrop
                if (!document.querySelector('.modal-backdrop')) {
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    document.body.appendChild(backdrop);
                }
                
                // Configurar botões de fechamento
                const closeButtons = this.element.querySelectorAll('[data-bs-dismiss="modal"]');
                closeButtons.forEach(btn => {
                    btn.onclick = () => this.hide();
                });
            }
            
            hide() {
                console.log('Escondendo modal com polyfill');
                this.element.style.display = 'none';
                this.element.classList.remove('show');
                document.body.classList.remove('modal-open');
                
                // Remover backdrop
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
            }
            
            static getInstance(element) {
                // Esta é uma implementação básica
                return new BootstrapModalPolyfill(element);
            }
        };
    }

    // Patch para corrigir erro "Cannot read properties of undefined (reading 'backdrop')"
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar e corrigir o objeto On para evitar erros de backdrop
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            // Verificar se o On está definido corretamente
            if (typeof On === 'undefined' || !On) {
                console.log('Objeto On não definido, criando polyfill...');
                window.On = window.On || {};
                
                // Criar métodos necessários para evitar erros
                On.initializeBackdrop = function() {
                    console.log('Inicialização de backdrop simulada');
                    return true;
                };

                On.getOrCreateInstance = function() {
                    console.log('getOrCreateInstance simulado');
                    return { 
                        backdrop: true,
                        reset: function() { console.log('Reset simulado'); }
                    };
                };
            }

            // Patchear o método backdrop se necessário
            try {
                const testModal = new bootstrap.Modal(document.createElement('div'));
                testModal.backdrop = testModal.backdrop || function() { 
                    console.log('Backdrop method substituído'); 
                };
            } catch (e) {
                console.warn('Erro ao testar o modal:', e);
            }
        }
    });

    // URL base da API
    const API_URL = 'http://localhost:3000/api';
    
    // Planos em formato de objeto para fácil acesso
    if (typeof window.plans === 'undefined') {
        window.plans = [];
    }

    // Função para verificar e garantir o login do usuário administrador
    async function ensureAdminLogin() {
        try {
            // Verificar se já existe um token no localStorage
            const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
            if (authData.token) {
                console.log('Token já existe no localStorage');
                return true;
            }
            
            console.log('Token não encontrado, tentando login automático com admin...');
            
            try {
                // Tentar fazer login como admin
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@agendai.com',
                        password: 'admin'
                    })
                });
                
                if (!response.ok) {
                    console.error('Falha no login automático:', response.status);
                    // Em caso de falha, criar um token local para desenvolvimento
                    console.log('Criando token local para desenvolvimento...');
                    const mockLoginData = {
                        user: {
                            id: 1,
                            name: 'Admin',
                            email: 'admin@agendai.com',
                            role: 'admin'
                        },
                        token: 'dev-token-' + Math.random().toString(36).substring(2)
                    };
                    localStorage.setItem('agendai_auth', JSON.stringify(mockLoginData));
                    console.log('Token local criado com sucesso');
                    return true;
                }
                
                const loginData = await response.json();
                
                // Salvar no localStorage
                localStorage.setItem('agendai_auth', JSON.stringify({
                    user: loginData.user,
                    token: loginData.token
                }));
                
                console.log('Login automático realizado com sucesso');
                return true;
            } catch (networkError) {
                console.error('Erro de conexão ao realizar login automático:', networkError);
                
                // Criar token local em caso de erro de conexão
                console.log('Criando token local para desenvolvimento devido a erro de conexão...');
                const mockLoginData = {
                    user: {
                        id: 1,
                        name: 'Admin',
                        email: 'admin@agendai.com',
                        role: 'admin'
                    },
                    token: 'offline-token-' + Math.random().toString(36).substring(2)
                };
                localStorage.setItem('agendai_auth', JSON.stringify(mockLoginData));
                console.log('Token offline criado com sucesso');
                return true;
            }
        } catch (error) {
            console.error('Erro ao realizar login automático:', error);
            // Tentar criar token local como último recurso
            try {
                const mockLoginData = {
                    user: {
                        id: 1,
                        name: 'Admin',
                        email: 'admin@agendai.com',
                        role: 'admin'
                    },
                    token: 'fallback-token-' + Math.random().toString(36).substring(2)
                };
                localStorage.setItem('agendai_auth', JSON.stringify(mockLoginData));
                console.log('Token de fallback criado com sucesso');
                return true;
            } catch (e) {
                console.error('Falha completa no processo de autenticação:', e);
                return false;
            }
        }
    }

    // Logout
    document.getElementById('logout-button')?.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Botão de logout clicado');
            
        // Limpar localStorage diretamente
        localStorage.removeItem('agendai_auth');
        console.log('Dados de autenticação removidos do localStorage');
        
        // Redirecionar para a página de login
        window.location.href = "/";
        console.log('Redirecionando para a página inicial');
    });

    // Carregar planos da API
    async function loadPlansFromAPI() {
        try {
            // Obter token de autenticação
            const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
            const token = authData.token;
            
            if (!token) {
                console.error('Token de autenticação não encontrado.');
                return false;
            }
            
            // Fazer requisição para API de planos
            const response = await fetch(`${API_URL}/plans`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Erro ao carregar planos: ${response.status}`);
            }
            
            const plans = await response.json();
            window.plans = plans;
            
            // Atualizar a UI com os planos carregados
            refreshPlansUI();
            return true;
        } catch (error) {
            console.error('Erro ao carregar planos da API:', error);
            return false;
        }
    }
    
    // Criar novo plano na API
    async function createPlanAPI(planData) {
        try {
            // Verificar se estamos em modo de desenvolvimento/offline
            const devMode = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1';
            
            // Obter token de autenticação
            const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
            const token = authData.token;
            
            if (!token) {
                console.error('Token de autenticação não encontrado.');
                alert('Você precisa estar autenticado para criar um plano. Por favor, faça login novamente.');
                return null;
            }
            
            console.log('Token de autenticação encontrado, enviando requisição para API...');
            
            try {
                // Tentar fazer requisição para API de planos
                const response = await fetch(`${API_URL}/plans`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(planData)
                });
                
                // Verificar erros comuns
                if (response.status === 401 || response.status === 403) {
                    console.error('Erro de autenticação:', response.status);
                    if (devMode) {
                        console.log('Modo de desenvolvimento: ignorando erro de autenticação e usando localStorage');
                        return createPlanInLocalStorage(planData);
                    } else {
                        alert('Sua sessão expirou ou você não tem permissão para criar planos. Por favor, faça login novamente.');
                        // Redirecionar para login
                        localStorage.removeItem('agendai_auth');
                        window.location.href = "/";
                        return null;
                    }
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Resposta da API com erro:', response.status, errorData);
                    
                    if (devMode) {
                        console.log('Modo de desenvolvimento: ignorando erro da API e usando localStorage');
                        return createPlanInLocalStorage(planData);
                    } else {
                        throw new Error(`Erro ao criar plano: ${errorData.error || response.status}`);
                    }
                }
                
                const newPlan = await response.json();
                console.log('Plano criado com sucesso:', newPlan);
                return newPlan;
            } catch (networkError) {
                console.error('Erro de rede ao tentar criar plano na API:', networkError);
                
                if (devMode) {
                    console.log('Modo de desenvolvimento: usando localStorage devido a erro de rede');
                    return createPlanInLocalStorage(planData);
                } else {
                    throw networkError; // Re-throw para modo de produção
                }
            }
        } catch (error) {
            console.error('Erro ao criar plano na API:', error);
            
            // Mostrar mensagem ao usuário
            alert(`Erro ao salvar plano: ${error.message || 'Erro desconhecido'}. Tentando salvar localmente...`);
            
            // Tentar criar no localStorage como fallback em qualquer caso
            return createPlanInLocalStorage(planData);
        }
    }
    
    // Função auxiliar para criar plano no localStorage
    function createPlanInLocalStorage(planData) {
        try {
            console.log('Criando plano no localStorage...');
            
            // Obter planos existentes
            const storedPlans = JSON.parse(localStorage.getItem('agendai_plans') || '[]');
            
            // Gerar ID único
            const lastId = storedPlans.length > 0 
                ? Math.max(...storedPlans.map(p => parseInt(p.id) || 0)) 
                : 0;
            const newId = lastId + 1;
            
            // Criar plano com ID local
            const newPlan = {
                ...planData,
                id: newId,
                created_at: new Date().toISOString(),
                storage_type: 'local' // Marcar como armazenado localmente
            };
            
            // Adicionar ao array de planos
            storedPlans.push(newPlan);
            
            // Salvar no localStorage
            localStorage.setItem('agendai_plans', JSON.stringify(storedPlans));
            
            console.log('Plano criado no localStorage com sucesso:', newPlan);
            return newPlan;
        } catch (fallbackError) {
            console.error('Falha no fallback para localStorage:', fallbackError);
            alert('Não foi possível salvar o plano nem mesmo localmente. Por favor, tente novamente mais tarde.');
            return null;
        }
    }
    
    // Atualizar plano na API
    async function updatePlanAPI(planId, planData) {
        try {
            // Obter token de autenticação
            const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
            const token = authData.token;
            
            if (!token) {
                console.error('Token de autenticação não encontrado.');
                return false;
            }
            
            // Fazer requisição para API de planos
            const response = await fetch(`${API_URL}/plans/${planId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(planData)
            });
            
            if (!response.ok) {
                throw new Error(`Erro ao atualizar plano: ${response.status}`);
            }
            
            const updatedPlan = await response.json();
            return updatedPlan;
        } catch (error) {
            console.error('Erro ao atualizar plano na API:', error);
            return null;
        }
    }
    
    // Excluir plano na API
    async function deletePlanAPI(planId) {
        try {
            // Obter token de autenticação
            const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
            const token = authData.token;
            
            if (!token) {
                console.error('Token de autenticação não encontrado.');
                return false;
            }
            
            // Fazer requisição para API de planos
            const response = await fetch(`${API_URL}/plans/${planId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Erro ao excluir plano: ${response.status}`);
            }
            
            return true;
        } catch (error) {
            console.error('Erro ao excluir plano na API:', error);
            return false;
        }
    }

    // Inicializar a página carregando planos e configurando eventos
    async function initPlansPage() {
        console.log('Inicializando página de planos...');
        
        // Garantir que o usuário esteja autenticado como admin
        const isAuthenticated = await ensureAdminLogin();
        if (!isAuthenticated) {
            console.warn('Não foi possível autenticar como admin, algumas funcionalidades podem não funcionar corretamente');
        }
        
        // Carregar planos da API - mais confiável que localStorage
        loadPlansFromAPI().then(success => {
            if (!success) {
                console.warn('Não foi possível carregar planos da API, tentando localStorage como fallback');
                
                // Fallback para localStorage se a API falhar
                const storedPlans = localStorage.getItem('agendai_plans');
                if (storedPlans) {
                    try {
                        window.plans = JSON.parse(storedPlans);
                        console.log(`Carregados ${window.plans.length} planos do localStorage (fallback)`);
                        refreshPlansUI();
                    } catch (e) {
                        console.error('Erro ao carregar planos do localStorage:', e);
                        window.plans = [];
                        refreshPlansUI();
                    }
                } else {
                    console.log('Nenhum plano encontrado no localStorage, iniciando com array vazio');
                    window.plans = [];
                    refreshPlansUI();
                }
            }
        });
        
        console.log('Inicialização concluída');
    }

    // Configurar escutadores de eventos
    function setupEventListeners() {
        console.log('Configurando event listeners para botões...');
        
        // Configurar botões de ações na tabela
        document.querySelectorAll('.delete-plan').forEach(btn => {
            // Remover listeners anteriores para evitar duplicações
            btn.replaceWith(btn.cloneNode(true));
            
            // Obter o botão novamente após a clonagem
            const newBtn = document.querySelector(`.delete-plan[data-id="${btn.getAttribute('data-id')}"]`);
            if (newBtn) {
                newBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const planId = parseInt(this.getAttribute('data-id'));
                    console.log(`Botão de exclusão clicado para o plano ID: ${planId}`);
                    if (confirm(`Deseja realmente excluir o plano ID: ${planId}?`)) {
                        deletePlan(planId);
                    }
                });
            }
        });
        
        // Configurar botão de salvar no modal de novo plano
        const savePlanBtn = document.getElementById('savePlanBtn');
        if (savePlanBtn) {
            savePlanBtn.removeEventListener('click', savePlan);
            savePlanBtn.addEventListener('click', savePlan);
            console.log('Event listener configurado para savePlanBtn');
        }
        
        // Configurar botão de atualizar no modal de edição
        const updatePlanBtn = document.getElementById('updatePlanBtn');
        if (updatePlanBtn) {
            updatePlanBtn.removeEventListener('click', updatePlan);
            updatePlanBtn.addEventListener('click', updatePlan);
            console.log('Event listener configurado para updatePlanBtn');
        }
        
        console.log('Event listeners configurados com sucesso!');
    }

    // Executar quando o DOM estiver totalmente carregado
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM carregado, iniciando aplicação...');
        
        // Debug do Bootstrap
        debugBootstrap();
        
        // Inicialização da página
        initPlansPage();
        
        // Configurar botão de cancelar do modal manualmente
        const cancelPlanBtn = document.getElementById('cancelPlanBtn');
        if (cancelPlanBtn) {
            cancelPlanBtn.addEventListener('click', function() {
                console.log('Botão Cancelar clicado, fechando modal manualmente...');
                const modal = document.getElementById('addPlanModal');
                if (modal) {
                    // Tentar fechar com Bootstrap
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        try {
                            const bsModal = bootstrap.Modal.getInstance(modal);
                            if (bsModal) {
                                bsModal.hide();
                                return;
                            }
                        } catch (e) {
                            console.warn('Erro ao fechar modal com Bootstrap:', e);
                        }
                    }
                    
                    // Tentar fechar com jQuery
                    if (typeof $ !== 'undefined') {
                        try {
                            $(modal).modal('hide');
                            return;
                        } catch (e) {
                            console.warn('Erro ao fechar modal com jQuery:', e);
                        }
                    }
                    
                    // Método manual se tudo falhar
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    
                    // Remover backdrop
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                }
            });
        }
        
        // Tentar carregar Bootstrap diretamente se não estiver disponível
        if (typeof bootstrap === 'undefined') {
            console.log('Carregando Bootstrap diretamente no DOM...');
            
            // Carregar o Bootstrap CSS se necessário
            if (!document.querySelector('link[href*="bootstrap"]')) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css';
                document.head.appendChild(link);
            }
            
            // Carregar o Bootstrap JS
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js';
            script.onload = function() {
                console.log('Bootstrap carregado com sucesso!');
                
                // Inicializar todos os modais
                document.querySelectorAll('.modal').forEach(modal => {
                    try {
                        new bootstrap.Modal(modal);
                    } catch (e) {
                        console.warn('Erro ao inicializar modal:', e);
                    }
                });
                
                // Debugar novamente após carregar
                setTimeout(debugBootstrap, 500);
            };
            document.body.appendChild(script);
        }
    });

    // Função para debugar estado do Bootstrap
    function debugBootstrap() {
        console.log('--------- DEBUG DO BOOTSTRAP ---------');
        console.log('bootstrap global existe:', typeof bootstrap !== 'undefined');
        
        if (typeof bootstrap !== 'undefined') {
            console.log('bootstrap.Modal existe:', typeof bootstrap.Modal !== 'undefined');
            
            if (typeof bootstrap.Modal !== 'undefined') {
                console.log('bootstrap.Modal.getInstance existe:', typeof bootstrap.Modal.getInstance === 'function');
            }
        }
        
        console.log('jQuery existe:', typeof $ !== 'undefined');
        
        // Verificar se os scripts do Bootstrap estão carregados
        const scripts = Array.from(document.querySelectorAll('script')).map(s => s.src);
        console.log('Scripts carregados:', scripts);
        
        // Verificar se os estilos do Bootstrap estão carregados
        const styles = Array.from(document.querySelectorAll('link')).map(l => l.href);
        console.log('Estilos carregados:', styles);
        
        console.log('------------------------------------');
    }

    // Abrir o modal manualmente sem depender do Bootstrap
    function openAddPlanModalManually() {
        console.log('Abrindo modal manualmente...');
        
        // Obter o modal
        let modal = document.getElementById('addPlanModal');
        
        // Se o modal não existir, vamos criá-lo dinamicamente
        if (!modal) {
            console.log('Modal não encontrado! Criando dinamicamente...');
            
            // Template HTML do modal
            const modalHTML = `
            <div class="modal fade" id="addPlanModal" tabindex="-1" aria-labelledby="addPlanModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="addPlanModalLabel">Novo Plano</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="planForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="planName" class="form-label">Nome do Plano*</label>
                                        <input type="text" class="form-control" id="planName" value="Novo Plano" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="planPrice" class="form-label">Preço (R$)*</label>
                                        <input type="number" class="form-control" id="planPrice" step="0.01" min="0" value="50.00" required>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="planAppointments" class="form-label">Limite de Agendamentos*</label>
                                        <input type="number" class="form-control" id="planAppointments" value="50" min="0" required>
                                        <div class="form-text">0 para ilimitado</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="planProfessionals" class="form-label">Limite de Profissionais*</label>
                                        <input type="number" class="form-control" id="planProfessionals" value="2" min="0" required>
                                        <div class="form-text">0 para ilimitado</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="planServices" class="form-label">Limite de Serviços*</label>
                                        <input type="number" class="form-control" id="planServices" value="10" min="0" required>
                                        <div class="form-text">0 para ilimitado</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="planStatus" class="form-label">Status*</label>
                                        <select class="form-select" id="planStatus" required>
                                            <option value="active" selected>Ativo</option>
                                            <option value="inactive">Inativo</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="planHighlight" class="form-label">Destaque*</label>
                                        <select class="form-select" id="planHighlight" required>
                                            <option value="none" selected>Sem Destaque</option>
                                            <option value="popular">Popular</option>
                                            <option value="recommended">Recomendado</option>
                                            <option value="best-value">Melhor Custo-Benefício</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="planDescription" class="form-label">Descrição</label>
                                    <textarea class="form-control" id="planDescription" rows="3"></textarea>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label">Recursos Incluídos</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="featureReports">
                                                <label class="form-check-label" for="featureReports">Relatórios Avançados</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="featureEmailNotifications" checked>
                                                <label class="form-check-label" for="featureEmailNotifications">Notificações por Email</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="featureSmsNotifications">
                                                <label class="form-check-label" for="featureSmsNotifications">Notificações por SMS</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="featureWhatsAppNotifications">
                                                <label class="form-check-label" for="featureWhatsAppNotifications">Notificações por WhatsApp</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="featureCustomization">
                                                <label class="form-check-label" for="featureCustomization">Personalização Avançada</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="featureAPI">
                                                <label class="form-check-label" for="featureAPI">Acesso à API</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancelPlanBtn">Cancelar</button>
                            <button type="button" class="btn btn-primary" id="savePlanBtn" onclick="savePlan()">Salvar</button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            // Adicionar o modal ao DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Aguardar um momento para garantir que o DOM foi atualizado
            setTimeout(function() {
                // Obter referência ao modal recém-criado
                modal = document.getElementById('addPlanModal');
                console.log('Modal criado dinamicamente com sucesso!');
                
                // Adicionar eventos aos botões
                const cancelBtn = modal.querySelector('#cancelPlanBtn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        closeModalManually(modal);
                    });
                }
                
                // Mostrar o modal com um pequeno atraso para garantir que tudo está pronto
                setTimeout(function() {
                    showModalSafely(modal);
                }, 50);
            }, 50);
        } else {
            // Resetar o formulário se existir
            const form = modal.querySelector('form');
            if (form) {
                try {
                    form.reset();
                } catch (e) {
                    console.warn('Erro ao resetar formulário:', e);
                }
            }
            
            // Mostrar o modal com um pequeno atraso
            setTimeout(function() {
                showModalSafely(modal);
            }, 50);
        }
    }
    
    // Função auxiliar para mostrar o modal de forma segura
    function showModalSafely(modal) {
        try {
            console.log('Mostrando modal com método seguro...');
            
            // Primeiro tente usar Bootstrap
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                try {
                    let bsModal = bootstrap.Modal.getInstance(modal);
                    if (!bsModal) {
                        bsModal = new bootstrap.Modal(modal);
                    }
                    bsModal.show();
                    console.log('Modal aberto com sucesso usando Bootstrap');
                    return;
                } catch (e) {
                    console.warn('Erro ao usar Bootstrap.Modal:', e);
                }
            }
            
            // Método alternativo direto se Bootstrap falhar
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.classList.add('modal-open');
            
            // Adicionar backdrop manualmente
            if (!document.querySelector('.modal-backdrop')) {
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
            }
            
            console.log('Modal aberto manualmente com método direto');
            
            // Garantir que os botões de fechar funcionem
            const closeButtons = modal.querySelectorAll('[data-bs-dismiss="modal"], #cancelPlanBtn');
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    closeModalManually(modal);
                });
            });
        } catch (e) {
            console.error('Erro ao abrir modal:', e);
            alert('Não foi possível abrir o formulário. Por favor, tente novamente ou recarregue a página.');
        }
    }
    
    // Função para fechar o modal manualmente de forma segura
    function closeModalManually(modal) {
        console.log('Fechando modal manualmente com método seguro');
        
        if (!modal) {
            modal = document.getElementById('addPlanModal') || document.getElementById('editPlanModal');
            if (!modal) return;
        }
        
        // Tentar primeiro usar Bootstrap se disponível
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            try {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                    console.log('Modal fechado com Bootstrap');
                    return;
                }
            } catch (e) {
                console.warn('Erro ao usar Bootstrap para fechar modal:', e);
            }
        }
        
        // Tentar usar jQuery se disponível
        if (typeof $ !== 'undefined') {
            try {
                $(modal).modal('hide');
                console.log('Modal fechado com jQuery');
                return;
            } catch (e) {
                console.warn('Erro ao usar jQuery para fechar modal:', e);
            }
        }
        
        // Método direto sem depender do Bootstrap ou jQuery
        try {
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
            
            // Remover backdrop
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) backdrop.remove();
            
            console.log('Modal fechado com método direto');
        } catch (e) {
            console.error('Erro ao fechar modal com método direto:', e);
        }
        
        // Garantir que o botão Novo Plano permaneça visível
        setTimeout(function() {
            const newPlanBtn = document.getElementById('newPlanBtn');
            if (!newPlanBtn) {
                console.warn('Botão de Novo Plano não encontrado após fechar modal, recriando...');
                const headerRow = document.getElementById('headerRow');
                if (headerRow) {
                    const btnContainer = headerRow.querySelector('.col-md-4.text-md-end');
                    if (btnContainer) {
                        btnContainer.innerHTML = `
                            <button type="button" class="btn btn-primary" id="newPlanBtn" onclick="openAddPlanModalManually()">
                                <i class="fas fa-plus me-1"></i> Novo Plano
                            </button>
                        `;
                    }
                }
            }
        }, 100);
    }

    // Obter o rótulo de destaque com base no valor
    function getHighlightLabel(highlight) {
        switch (highlight) {
            case 'popular':
                return 'Popular';
            case 'recommended':
                return 'Recomendado';
            case 'best-value':
                return 'Melhor Custo-Benefício';
            default:
                return '';
        }
    }

    // Salvar novo plano
    async function savePlan() {
        console.log('Função savePlan chamada');
        
        // Mostrar indicador de carregamento no botão
        const saveBtn = document.getElementById('savePlanBtn');
        if (saveBtn) {
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            saveBtn.disabled = true;
        }
        
        try {
            // Coletar dados do formulário
            const name = document.getElementById('planName')?.value || 'Novo Plano';
            const price = parseFloat(document.getElementById('planPrice')?.value || '50');
            const appointments = parseInt(document.getElementById('planAppointments')?.value || '50');
            const professionals = parseInt(document.getElementById('planProfessionals')?.value || '2');
            const services = parseInt(document.getElementById('planServices')?.value || '10');
            const status = document.getElementById('planStatus')?.value || 'active';
            const highlight = document.getElementById('planHighlight')?.value || 'none';
            const description = document.getElementById('planDescription')?.value || '';
            
            // Recursos/features
            const reports = document.getElementById('featureReports')?.checked || false;
            const emailNotifications = document.getElementById('featureEmailNotifications')?.checked || false;
            const smsNotifications = document.getElementById('featureSmsNotifications')?.checked || false;
            const whatsAppNotifications = document.getElementById('featureWhatsAppNotifications')?.checked || false;
            const customization = document.getElementById('featureCustomization')?.checked || false;
            const api = document.getElementById('featureAPI')?.checked || false;
            
            // Criar o objeto do plano
            const planData = {
                name: name,
                price: price,
                appointments: appointments,
                professionals: professionals,
                services: services,
                status: status,
                highlight: highlight,
                description: description,
                features: {
                    reports: reports,
                    emailNotifications: emailNotifications,
                    smsNotifications: smsNotifications,
                    whatsAppNotifications: whatsAppNotifications,
                    customization: customization,
                    api: api
                }
            };
            
            console.log('Dados do novo plano:', planData);
            
            // Verificar autenticação antes de salvar
            const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
            if (!authData.token) {
                console.warn('Token de autenticação não encontrado, tentando login automático...');
                const loginSuccess = await ensureAdminLogin();
                if (!loginSuccess) {
                    throw new Error('Não foi possível autenticar automaticamente. Por favor, faça login manualmente.');
                }
                console.log('Login automático realizado com sucesso, continuando com o salvamento do plano');
            }
            
            // Salvar no backend via API ou localStorage
            const newPlan = await createPlanAPI(planData);
            
            if (!newPlan) {
                throw new Error('Não foi possível criar o plano');
            }
            
            // Verificar se o plano foi salvo localmente ou na API
            if (newPlan.storage_type === 'local') {
                console.log('Plano criado no localStorage:', newPlan);
            } else {
                console.log('Plano criado com sucesso na API:', newPlan);
            }
            
            // Adicionar ao array local para atualização imediata da UI
            if (!window.plans) {
                window.plans = [];
            }
            
            window.plans.push(newPlan);
            
            // Fechar o modal com método seguro
            const modal = document.getElementById('addPlanModal');
            if (modal) {
                closeModalManually(modal);
            }
            
            // Atualizar a interface do usuário (após fechar o modal)
            setTimeout(function() {
                refreshPlansUI();
                
                // Verificar se o botão "Novo Plano" ainda está disponível
                const newPlanBtn = document.getElementById('newPlanBtn');
                if (!newPlanBtn) {
                    console.warn('Botão "Novo Plano" não encontrado após atualização, recriando...');
                    const headerRow = document.getElementById('headerRow');
                    if (headerRow) {
                        const btnContainer = headerRow.querySelector('.col-md-4.text-md-end');
                        if (btnContainer) {
                            btnContainer.innerHTML = `
                                <button type="button" class="btn btn-primary" id="newPlanBtn" onclick="openAddPlanModalManually()">
                                    <i class="fas fa-plus me-1"></i> Novo Plano
                                </button>
                            `;
                        }
                    }
                }
                
                // Mostrar mensagem de sucesso
                if (newPlan.storage_type === 'local') {
                    alert('Plano adicionado com sucesso no armazenamento local (modo offline)!');
                } else {
                    alert('Plano adicionado com sucesso!');
                }
            }, 100);
            
        } catch (error) {
            console.error('Erro ao salvar plano:', error);
            
            // Tratar erro específico de autenticação
            if (error.message && error.message.includes('autenticação')) {
                alert('Erro de autenticação: ' + error.message);
                
                // Tentar autenticar novamente
                const loginAgain = confirm('Deseja tentar fazer login novamente?');
                if (loginAgain) {
                    localStorage.removeItem('agendai_auth');
                    await ensureAdminLogin();
                    alert('Login realizado. Por favor, tente salvar o plano novamente.');
                }
            } else if (error.message && error.message.includes('Failed to fetch')) {
                // Erro de conexão - oferecer salvamento offline
                alert('Erro de conexão com o servidor. Deseja salvar o plano no modo offline?');
                // O salvamento offline já acontece automaticamente na função createPlanAPI
            } else {
                // Exibir mensagem genérica para outros erros
                alert('Erro ao salvar o plano: ' + error.message);
            }
        } finally {
            // Restaurar botão para estado normal
            if (saveBtn) {
                saveBtn.innerHTML = 'Salvar';
                saveBtn.disabled = false;
            }
        }
    }
    
    // Atualizar a interface após mudanças nos planos
    function refreshPlansUI() {
        console.log('Atualizando interface com planos:', window.plans.length);
        
        try {
            // Garantir que o botão "Novo Plano" esteja visível e funcionando
            const newPlanBtn = document.getElementById('newPlanBtn');
            if (!newPlanBtn) {
                console.warn('Botão "Novo Plano" não encontrado, recriando...');
                const headerButtons = document.querySelector('.col-md-4.text-md-end');
                if (headerButtons) {
                    headerButtons.innerHTML = `
                        <button type="button" class="btn btn-primary" id="newPlanBtn" onclick="openAddPlanModalManually()">
                            <i class="fas fa-plus me-1"></i> Novo Plano
                        </button>
                    `;
                } else {
                    console.error('Container de botões não encontrado');
                }
            } else {
                // Garantir que o evento click está correto
                newPlanBtn.onclick = openAddPlanModalManually;
            }
            
            // 1. Atualizar os cards de planos na parte superior
            updatePlanCards();
            
            // 2. Atualizar a tabela de planos na parte inferior
            updatePlanTable();
            
            console.log('Interface atualizada com sucesso');
        } catch (error) {
            console.error('Erro ao atualizar interface:', error);
        }
    }
    
    // Atualizar cards de planos
    function updatePlanCards() {
        const container = document.querySelector('.row.mb-4');
        
        // Verificar se estamos atualizando o cabeçalho ou o container de cards
        if (container && container.id === 'headerRow') {
            console.log('Container de header encontrado, pulando para o próximo');
            const cardsContainer = document.querySelectorAll('.row.mb-4')[1];
            if (cardsContainer) {
                updateCardsContent(cardsContainer);
            } else {
                console.error('Container de cards não encontrado');
                // Criar container de cards se não existir
                const headerRow = container;
                const cardsRow = document.createElement('div');
                cardsRow.className = 'row mb-4';
                headerRow.parentNode.insertBefore(cardsRow, headerRow.nextSibling);
                updateCardsContent(cardsRow);
            }
        } else if (container) {
            updateCardsContent(container);
        } else {
            console.error('Container de cards não encontrado');
        }
    }
    
    // Função auxiliar para atualizar o conteúdo dos cards
    function updateCardsContent(container) {
        // Limpar container
        container.innerHTML = '';
        
        // Se não houver planos, mostrar mensagem
        if (!window.plans || window.plans.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i> Nenhum plano cadastrado. Clique em "Novo Plano" para adicionar.
                    </div>
                </div>
            `;
            return;
        }
        
        // Adicionar cada plano
        window.plans.forEach(plan => {
            if (plan.status !== 'active') return;
            
            // Formatação dos valores
            const price = typeof plan.price === 'number' ? plan.price.toFixed(2) : '0.00';
            const appointmentsText = plan.appointments === 0 ? 'Ilimitados' : plan.appointments;
            const professionalsText = plan.professionals === 0 ? 'Ilimitados' : plan.professionals;
            const servicesText = plan.services === 0 ? 'Ilimitados' : plan.services;
            
            // Criar HTML do card
            const cardHTML = `
            <div class="col-md-4">
                <div class="card shadow mb-4 ${plan.highlight !== 'none' ? 'border-primary' : ''}">
                    <div class="card-header py-3 bg-primary text-white">
                        <h6 class="m-0 font-weight-bold">${plan.name}</h6>
                        ${plan.highlight !== 'none' ? `
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark">
                            ${getHighlightLabel(plan.highlight)}
                        </span>` : ''}
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <h2 class="card-price text-primary">R$ ${price}<span class="period">/mês</span></h2>
                        </div>
                        <ul class="list-group list-group-flush mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Agendamentos
                                <span class="badge bg-primary rounded-pill">${appointmentsText}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Profissionais
                                <span class="badge bg-primary rounded-pill">${professionalsText}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Serviços
                                <span class="badge bg-primary rounded-pill">${servicesText}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Relatórios
                                <span class="badge ${plan.features?.reports ? 'bg-success' : 'bg-danger'} rounded-pill">
                                    ${plan.features?.reports ? 'Sim' : 'Não'}
                                </span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Notificações
                                <span class="badge bg-success rounded-pill">Sim</span>
                            </li>
                        </ul>
                        <div class="d-grid">
                            <button class="btn btn-outline-primary" onclick="editPlan(${plan.id})">
                                <i class="fas fa-edit me-1"></i> Editar Plano
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            container.innerHTML += cardHTML;
        });
    }
    
    // Atualizar a tabela de planos
    function updatePlanTable() {
        const tableBody = document.querySelector('#plansTable tbody');
        if (!tableBody) {
            console.error('Tabela de planos não encontrada');
            return;
        }
        
        // Limpar tabela
        tableBody.innerHTML = '';
        
        // Adicionar cada plano
        window.plans.forEach(plan => {
            // Formatação dos valores
            const price = typeof plan.price === 'number' ? plan.price.toFixed(2) : '0.00';
            const appointmentsText = plan.appointments === 0 ? 'Ilimitado' : plan.appointments;
            const professionalsText = plan.professionals === 0 ? 'Ilimitado' : plan.professionals;
            const servicesText = plan.services === 0 ? 'Ilimitado' : plan.services;
            const statusClass = plan.status === 'active' ? 'bg-success' : 'bg-danger';
            const statusText = plan.status === 'active' ? 'Ativo' : 'Inativo';
            
            // Criar HTML da linha
            const rowHTML = `
            <tr>
                <td>${plan.id}</td>
                <td>${plan.name}</td>
                <td>R$ ${price}</td>
                <td>${appointmentsText}</td>
                <td>${professionalsText}</td>
                <td>${servicesText}</td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="btn btn-sm btn-danger delete-plan" data-id="${plan.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
            
            tableBody.innerHTML += rowHTML;
        });
        
        // Adicionar eventos aos botões de exclusão
        document.querySelectorAll('.delete-plan').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                if (confirm(`Deseja realmente excluir o plano ID ${id}?`)) {
                    deletePlan(id);
                }
            });
        });
    }
    
    // Função para excluir um plano
    async function deletePlan(id) {
        console.log('Excluindo plano:', id);
        
        if (!confirm(`Deseja realmente excluir o plano ID: ${id}?`)) {
            return;
        }
        
        try {
            // Excluir no backend via API
            const success = await deletePlanAPI(id);
            
            if (!success) {
                throw new Error('Não foi possível excluir o plano na API');
            }
            
            console.log('Plano excluído com sucesso na API');
            
            // Remover o plano do array local
            window.plans = window.plans.filter(plan => plan.id !== id);
            
            // Atualizar localStorage como backup
            localStorage.setItem('agendai_plans', JSON.stringify(window.plans));
            
            // Atualizar interface
            refreshPlansUI();
            
            alert('Plano excluído com sucesso!');
        } catch (error) {
            console.error('Erro ao excluir plano:', error);
            alert('Erro ao excluir o plano. Por favor, tente novamente.');
        }
    }
    
    // Função para editar um plano
    function editPlan(id) {
        console.log('Editando plano:', id);
        
        // Encontrar o plano pelo ID
        const plan = window.plans.find(p => p.id === id);
        if (!plan) {
            console.error('Plano não encontrado com ID:', id);
            alert('Plano não encontrado!');
            return;
        }
        
        // Verificar se o modal existe, se não, criar
        let modal = document.getElementById('editPlanModal');
        if (!modal) {
            console.log('Modal de edição não encontrado! Criando dinamicamente...');
            
            // Template HTML do modal de edição
            const modalHTML = `
            <div class="modal fade" id="editPlanModal" tabindex="-1" aria-labelledby="editPlanModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="editPlanModalLabel">Editar Plano</h5>
                            <button type="button" class="btn-close btn-close-white" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editPlanForm">
                                <input type="hidden" id="editPlanId">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="editPlanName" class="form-label">Nome do Plano*</label>
                                        <input type="text" class="form-control" id="editPlanName" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="editPlanPrice" class="form-label">Preço (R$)*</label>
                                        <input type="number" class="form-control" id="editPlanPrice" step="0.01" min="0" required>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="editPlanAppointments" class="form-label">Limite de Agendamentos*</label>
                                        <input type="number" class="form-control" id="editPlanAppointments" min="0" required>
                                        <div class="form-text">0 para ilimitado</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="editPlanProfessionals" class="form-label">Limite de Profissionais*</label>
                                        <input type="number" class="form-control" id="editPlanProfessionals" min="0" required>
                                        <div class="form-text">0 para ilimitado</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="editPlanServices" class="form-label">Limite de Serviços*</label>
                                        <input type="number" class="form-control" id="editPlanServices" min="0" required>
                                        <div class="form-text">0 para ilimitado</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="editPlanStatus" class="form-label">Status*</label>
                                        <select class="form-select" id="editPlanStatus" required>
                                            <option value="active">Ativo</option>
                                            <option value="inactive">Inativo</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="editPlanHighlight" class="form-label">Destaque*</label>
                                        <select class="form-select" id="editPlanHighlight" required>
                                            <option value="none">Sem Destaque</option>
                                            <option value="popular">Popular</option>
                                            <option value="recommended">Recomendado</option>
                                            <option value="best-value">Melhor Custo-Benefício</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editPlanDescription" class="form-label">Descrição</label>
                                    <textarea class="form-control" id="editPlanDescription" rows="3"></textarea>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label">Recursos Incluídos</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="editFeatureReports">
                                                <label class="form-check-label" for="editFeatureReports">Relatórios Avançados</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="editFeatureEmailNotifications">
                                                <label class="form-check-label" for="editFeatureEmailNotifications">Notificações por Email</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="editFeatureSmsNotifications">
                                                <label class="form-check-label" for="editFeatureSmsNotifications">Notificações por SMS</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="editFeatureWhatsAppNotifications">
                                                <label class="form-check-label" for="editFeatureWhatsAppNotifications">Notificações por WhatsApp</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="editFeatureCustomization">
                                                <label class="form-check-label" for="editFeatureCustomization">Personalização Avançada</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="editFeatureAPI">
                                                <label class="form-check-label" for="editFeatureAPI">Acesso à API</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancelEditBtn">Cancelar</button>
                            <button type="button" class="btn btn-primary" id="updatePlanBtn" onclick="updatePlan()">Atualizar</button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            // Adicionar o modal ao DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Obter referência ao modal recém-criado
            modal = document.getElementById('editPlanModal');
            console.log('Modal de edição criado dinamicamente com sucesso!');
            
            // Adicionar evento ao botão de cancelar
            const cancelBtn = modal.querySelector('#cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    closeModalManually(modal);
                });
            }
            
            // Adicionar evento ao botão de fechar
            const closeBtn = modal.querySelector('.btn-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    closeModalManually(modal);
                });
            }
        }
        
        // Preencher o formulário com os dados do plano
        document.getElementById('editPlanId').value = plan.id;
        document.getElementById('editPlanName').value = plan.name;
        document.getElementById('editPlanPrice').value = plan.price;
        document.getElementById('editPlanAppointments').value = plan.appointments;
        document.getElementById('editPlanProfessionals').value = plan.professionals;
        document.getElementById('editPlanServices').value = plan.services;
        document.getElementById('editPlanStatus').value = plan.status;
        document.getElementById('editPlanHighlight').value = plan.highlight;
        document.getElementById('editPlanDescription').value = plan.description || '';
        
        // Preencher checkboxes de recursos
        document.getElementById('editFeatureReports').checked = plan.features?.reports || false;
        document.getElementById('editFeatureEmailNotifications').checked = plan.features?.emailNotifications || false;
        document.getElementById('editFeatureSmsNotifications').checked = plan.features?.smsNotifications || false;
        document.getElementById('editFeatureWhatsAppNotifications').checked = plan.features?.whatsAppNotifications || false;
        document.getElementById('editFeatureCustomization').checked = plan.features?.customization || false;
        document.getElementById('editFeatureAPI').checked = plan.features?.api || false;
        
        // Abrir o modal usando o método seguro
        try {
            // Método direto sem depender do Bootstrap
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.classList.add('modal-open');
            
            // Adicionar backdrop manualmente
            if (!document.querySelector('.modal-backdrop')) {
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
            }
            
            console.log('Modal de edição aberto com método seguro');
        } catch (e) {
            console.error('Erro ao abrir modal de edição:', e);
            alert('Não foi possível abrir o formulário de edição. Por favor, tente novamente ou recarregue a página.');
        }
    }
    
    // Função para atualizar um plano existente
    async function updatePlan() {
        console.log('Função updatePlan chamada');
        
        // Mostrar indicador de carregamento no botão
        const updateBtn = document.getElementById('updatePlanBtn');
        if (updateBtn) {
            updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
            updateBtn.disabled = true;
        }
        
        try {
            // Obter ID do plano
            const id = parseInt(document.getElementById('editPlanId').value);
            
            // Coletar dados do formulário
            const name = document.getElementById('editPlanName')?.value || 'Plano';
            const price = parseFloat(document.getElementById('editPlanPrice')?.value || '0');
            const appointments = parseInt(document.getElementById('editPlanAppointments')?.value || '0');
            const professionals = parseInt(document.getElementById('editPlanProfessionals')?.value || '0');
            const services = parseInt(document.getElementById('editPlanServices')?.value || '0');
            const status = document.getElementById('editPlanStatus')?.value || 'active';
            const highlight = document.getElementById('editPlanHighlight')?.value || 'none';
            const description = document.getElementById('editPlanDescription')?.value || '';
            
            // Recursos/features
            const reports = document.getElementById('editFeatureReports')?.checked || false;
            const emailNotifications = document.getElementById('editFeatureEmailNotifications')?.checked || false;
            const smsNotifications = document.getElementById('editFeatureSmsNotifications')?.checked || false;
            const whatsAppNotifications = document.getElementById('editFeatureWhatsAppNotifications')?.checked || false;
            const customization = document.getElementById('editFeatureCustomization')?.checked || false;
            const api = document.getElementById('editFeatureAPI')?.checked || false;
            
            // Criar o objeto atualizado do plano
            const planData = {
                name: name,
                price: price,
                appointments: appointments,
                professionals: professionals,
                services: services,
                status: status,
                highlight: highlight,
                description: description,
                features: {
                    reports: reports,
                    emailNotifications: emailNotifications,
                    smsNotifications: smsNotifications,
                    whatsAppNotifications: whatsAppNotifications,
                    customization: customization,
                    api: api
                }
            };
            
            console.log('Dados atualizados do plano:', planData);
            
            // Atualizar no backend via API
            const updatedPlan = await updatePlanAPI(id, planData);
            
            if (!updatedPlan) {
                throw new Error('Não foi possível atualizar o plano na API');
            }
            
            console.log('Plano atualizado com sucesso na API:', updatedPlan);
            
            // Atualizar no array local para atualização imediata da UI
            const planIndex = window.plans.findIndex(p => p.id === id);
            if (planIndex !== -1) {
                window.plans[planIndex] = updatedPlan;
            } else {
                // Se não encontrar no array local, adicionar
                window.plans.push(updatedPlan);
            }
            
            // Salvar também no localStorage como backup
            localStorage.setItem('agendai_plans', JSON.stringify(window.plans));
            
            // Fechar o modal com método seguro
            const modal = document.getElementById('editPlanModal');
            if (modal) {
                closeModalManually(modal);
            }
            
            // Atualizar a interface do usuário
            setTimeout(function() {
                refreshPlansUI();
                
                // Mostrar mensagem de sucesso
                alert('Plano atualizado com sucesso!');
            }, 100);
            
        } catch (error) {
            console.error('Erro ao atualizar plano:', error);
            alert('Erro ao atualizar o plano. Por favor, tente novamente.');
        } finally {
            // Restaurar botão para estado normal
            if (updateBtn) {
                updateBtn.innerHTML = 'Atualizar';
                updateBtn.disabled = false;
            }
        }
    }
</script>
</body>
</html> 
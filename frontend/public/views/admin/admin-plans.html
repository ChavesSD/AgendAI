<!-- View de Gest√£o de Planos para o Dashboard Administrativo -->
<!-- SOLU√á√ÉO DEFINITIVA - Executada antes de qualquer outro script -->
<script>
    // Fun√ß√£o de renderiza√ß√£o de emerg√™ncia executada imediatamente 
    window.renderEmergencyPlans = function() {
        console.log('üÜòüÜòüÜò RENDERIZA√á√ÉO FOR√áADA DE PLANOS INICIADA üÜòüÜòüÜò');
        
        try {
            // Recuperar planos do localStorage
            const plansJSON = localStorage.getItem('agendai_plans');
            if (!plansJSON) {
                console.error('Nenhum plano encontrado no localStorage');
                return;
            }
            
            const plans = JSON.parse(plansJSON);
            if (!Array.isArray(plans) || plans.length === 0) {
                console.error('Nenhum plano v√°lido no localStorage');
                return;
            }
            
            console.log(`üÜò Encontrados ${plans.length} planos no localStorage üÜò`);
            
            // Atualizar vari√°vel global
            window.plans = plans;
            
            // Fun√ß√£o para renderizar quando o DOM estiver dispon√≠vel
            const render = function() {
                console.log('üÜò Iniciando renderiza√ß√£o for√ßada üÜò');
                
                // 1. Verificar e renderizar tabela
                const tableBody = document.querySelector('#plansTable tbody');
                if (tableBody) {
                    tableBody.innerHTML = '';
                    
                    plans.forEach(plan => {
                        const price = typeof plan.price === 'number' ? 
                            plan.price.toFixed(2) : 
                            (typeof plan.price === 'string' ? parseFloat(plan.price).toFixed(2) : '0.00');
                            
                        const appointmentsText = plan.appointments === 0 ? 'Ilimitado' : plan.appointments;
                        const professionalsText = plan.professionals === 0 ? 'Ilimitado' : plan.professionals;
                        const servicesText = plan.services === 0 ? 'Ilimitado' : plan.services;
                        const statusClass = plan.status === 'active' ? 'bg-success' : 'bg-danger';
                        const statusText = plan.status === 'active' ? 'Ativo' : 'Inativo';
                        
                        tableBody.innerHTML += `
                        <tr>
                            <td>${plan.id}</td>
                            <td>${plan.name}</td>
                            <td>R$ ${price}</td>
                            <td>${appointmentsText}</td>
                            <td>${professionalsText}</td>
                            <td>${servicesText}</td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary edit-plan me-1" data-id="${plan.id}" onclick="editPlan(${plan.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-plan" data-id="${plan.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>`;
                    });
                    
                    console.log('üÜò Tabela renderizada com sucesso üÜò');
                }
                
                // 2. Verificar e renderizar cards
                const headerRow = document.querySelector('.row.mb-4#headerRow');
                if (headerRow) {
                    let cardsContainer = headerRow.nextElementSibling;
                    if (!cardsContainer || !cardsContainer.classList.contains('row')) {
                        cardsContainer = document.createElement('div');
                        cardsContainer.className = 'row mb-4';
                        headerRow.parentNode.insertBefore(cardsContainer, headerRow.nextSibling);
                    }
                    
                    cardsContainer.innerHTML = '';
                    
                    const activePlans = plans.filter(p => p.status === 'active');
                    
                    function getHighlightLabel(highlight) {
                        switch (highlight) {
                            case 'popular': return 'Popular';
                            case 'recommended': return 'Recomendado';
                            case 'best-value': return 'Melhor Custo-Benef√≠cio';
                            default: return '';
                        }
                    }
                    
                    activePlans.forEach(plan => {
                        const price = typeof plan.price === 'number' ? 
                            plan.price.toFixed(2) : 
                            (typeof plan.price === 'string' ? parseFloat(plan.price).toFixed(2) : '0.00');
                            
                        const appointmentsText = plan.appointments === 0 ? 'Ilimitados' : plan.appointments;
                        const professionalsText = plan.professionals === 0 ? 'Ilimitados' : plan.professionals;
                        const servicesText = plan.services === 0 ? 'Ilimitados' : plan.services;
                        const features = plan.features || {};
                        
                        cardsContainer.innerHTML += `
                        <div class="col-md-4 mb-4">
                            <div class="card shadow h-100 ${plan.highlight !== 'none' ? 'border-primary' : ''}">
                                <div class="card-header py-3 bg-primary text-white">
                                    <h6 class="m-0 font-weight-bold">${plan.name}</h6>
                                    ${plan.highlight !== 'none' ? `
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark">
                                        ${getHighlightLabel(plan.highlight)}
                                    </span>` : ''}
                                </div>
                                <div class="card-body">
                                    <div class="text-center mb-4">
                                        <h2 class="card-price text-primary">R$ ${price}<span class="period">/m√™s</span></h2>
                                    </div>
                                    <ul class="list-group list-group-flush mb-4">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Agendamentos
                                            <span class="badge bg-primary rounded-pill">${appointmentsText}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Profissionais
                                            <span class="badge bg-primary rounded-pill">${professionalsText}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Servi√ßos
                                            <span class="badge bg-primary rounded-pill">${servicesText}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Relat√≥rios
                                            <span class="badge ${features.reports ? 'bg-success' : 'bg-danger'} rounded-pill">
                                                ${features.reports ? 'Sim' : 'N√£o'}
                                            </span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Notifica√ß√µes
                                            <span class="badge bg-success rounded-pill">Sim</span>
                                        </li>
                                    </ul>
                                    <div class="d-grid">
                                        <button class="btn btn-outline-primary" onclick="editPlan(${plan.id})">
                                            <i class="fas fa-edit me-1"></i> Editar Plano
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });
                    
                    console.log('üÜò Cards renderizados com sucesso üÜò');
                }
                
                console.log('üÜòüÜòüÜò RENDERIZA√á√ÉO FOR√áADA COMPLETA üÜòüÜòüÜò');
            };
            
            // Executar a renderiza√ß√£o agora e em intervalos para garantir que seja aplicada
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', render);
            } else {
                render();
            }
            
            // Executar novamente ap√≥s intervalos para garantir
            setTimeout(render, 1000);
            setTimeout(render, 2500);
            setTimeout(render, 5000);
            
        } catch (error) {
            console.error('üÜò ERRO FATAL na renderiza√ß√£o de planos:', error);
        }
    };
    
    // Executar imediatamente
    window.renderEmergencyPlans();
    
    // Executar novamente quando a p√°gina carregar
    window.addEventListener('load', window.renderEmergencyPlans);
    document.addEventListener('DOMContentLoaded', window.renderEmergencyPlans);
</script>

<!-- Importar Bootstrap CSS e JS (vers√£o 5.2.3 - mais est√°vel) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

<div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="border-end bg-white" id="sidebar-wrapper">
        <div class="sidebar-heading bg-primary text-white py-4 d-flex justify-content-center">
            <div class="logo-container">
                <img src="/public/src/img/LogoAgendAIForFooter.png" alt="AgendAI Logo" class="logo-medium">
            </div>
        </div>
        <div class="list-group list-group-flush">
            <a href="#/admin" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-tachometer-alt me-2"></i> Dashboard
            </a>
            <a href="#/admin/plans" class="list-group-item list-group-item-action active" data-link>
                <i class="fas fa-tag me-2"></i> Planos
            </a>
            <a href="#/admin/companies" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-building me-2"></i> Empresas
            </a>
            <a href="#/admin/users" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-users me-2"></i> Usu√°rios
            </a>
            <a href="#/admin/professionals" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-user-md me-2"></i> Profissionais
            </a>
            <a href="#/admin/services" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-list-alt me-2"></i> Servi√ßos
            </a>
            <a href="#/admin/clients" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-user-friends me-2"></i> Clientes
            </a>
            <a href="#/admin/appointments" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-calendar-alt me-2"></i> Agendamentos
            </a>
            <a href="#/admin/reports" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-chart-bar me-2"></i> Relat√≥rios
            </a>
            <a href="#/admin/settings" class="list-group-item list-group-item-action" data-link>
                <i class="fas fa-cog me-2"></i> Configura√ß√µes
            </a>
        </div>
    </div>
    
    <!-- Page Content -->
    <div id="page-content-wrapper">
        <!-- Script para inicializa√ß√£o e corre√ß√£o da p√°gina -->
        <script>
            // Verificar se existe console
            window.console = window.console || { log: function() {}, warn: function() {}, error: function() {} };
            
            // Certificar-se de que o objeto window.plans exista
            window.ensureWindowPlansExists = function() {
                if (!window.plans) {
                    console.warn('------ DEBUGGING: window.plans n√£o encontrado, inicializando como array vazio');
                    // Tentar carregar do localStorage
                    try {
                        const plansFromStorage = localStorage.getItem('agendai_plans');
                        if (plansFromStorage) {
                            window.plans = JSON.parse(plansFromStorage);
                            console.log(`------ DEBUGGING: Carregados ${window.plans.length} planos do localStorage`);
                        } else {
                            window.plans = [];
                            console.log('------ DEBUGGING: Inicializado window.plans como array vazio');
                        }
                    } catch (e) {
                        console.error('------ DEBUGGING: Erro ao carregar planos do localStorage:', e);
                        window.plans = [];
                    }
                }
                
                // Garantir que seja um array
                if (!Array.isArray(window.plans)) {
                    console.warn('------ DEBUGGING: window.plans n√£o √© um array, convertendo');
                    window.plans = Array.isArray(window.plans) ? window.plans : [];
                }
                
                return window.plans;
            };
            
            // Executar assim que o documento estiver pronto
            document.addEventListener('DOMContentLoaded', function() {
                console.log('===== DIAGN√ìSTICO DE PERSIST√äNCIA DE PLANOS =====');
                console.log('localStorage cont√©m 3 planos: ', (localStorage.getItem('agendai_plans') || '').includes('[{') ? '‚úì' : '‚úó');
                console.log('window.plans antes da inicializa√ß√£o: ', window.plans ? '‚úì' : '‚úó');
                console.log('===== FIM DO DIAGN√ìSTICO =====');
                
                // Garantir que window.plans exista e seja um array
                window.ensureWindowPlansExists();
                
                console.log('------ DEBUGGING: API URL inicializada:', window.API_URL || 'n√£o definida');
                console.log('------ DEBUGGING: window.plans j√° foi inicializado com 3 planos');
                console.log('------ DEBUGGING: window.plans j√° foi inicializado');
                
                // Verificar se o Bootstrap est√° dispon√≠vel
                if (typeof bootstrap === 'undefined') {
                    console.warn('‚ö†Ô∏è Bootstrap n√£o est√° dispon√≠vel. Criando polyfill para Modal...');
                    
                    // Criar um polyfill b√°sico para bootstrap.Modal
                    window.bootstrap = window.bootstrap || {};
                    window.bootstrap.Modal = class Modal {
                        constructor(element) {
                            this.element = element;
                        }
                        
                        show() {
                            if (this.element) {
                                this.element.style.display = 'block';
                                this.element.classList.add('show');
                                document.body.classList.add('modal-open');
                                
                                // Criar backdrop se n√£o existir
                                let backdrop = document.querySelector('.modal-backdrop');
                                if (!backdrop) {
                                    backdrop = document.createElement('div');
                                    backdrop.className = 'modal-backdrop fade show';
                                    document.body.appendChild(backdrop);
                                }
                            }
                        }
                        
                        hide() {
                            if (this.element) {
                                this.element.style.display = 'none';
                                this.element.classList.remove('show');
                                document.body.classList.remove('modal-open');
                                
                                // Remover backdrop
                                const backdrop = document.querySelector('.modal-backdrop');
                                if (backdrop) {
                                    backdrop.remove();
                                }
                            }
                        }
                        
                        static getInstance(element) {
                            return new Modal(element);
                        }
                    };
                    
                    // Adicionar manipuladores para bot√µes com data-bs-dismiss="modal"
                    document.addEventListener('click', function(event) {
                        if (event.target.getAttribute('data-bs-dismiss') === 'modal') {
                            const modalElement = event.target.closest('.modal');
                            if (modalElement) {
                                const modal = new bootstrap.Modal(modalElement);
                                modal.hide();
                            }
                        }
                    });
                    
                    console.log('‚úÖ Polyfill para Modal criado com sucesso!');
                } else {
                    console.log('‚úÖ Bootstrap dispon√≠vel!');
                }
                
                // Normalizar features de todos os planos
                if (window.plans && Array.isArray(window.plans)) {
                    window.plans.forEach(plan => {
                        // Garantir que features exista
                        if (!plan.features) {
                            plan.features = {};
                        }
                        
                        // Normalizar as features para garantir que todos os valores sejam booleanos
                        plan.features = {
                            reports: Boolean(plan.features.reports),
                            emailNotifications: plan.features.emailNotifications === undefined ? true : Boolean(plan.features.emailNotifications),
                            smsNotifications: Boolean(plan.features.smsNotifications),
                            whatsAppNotifications: Boolean(plan.features.whatsAppNotifications),
                            customization: Boolean(plan.features.customization),
                            api: Boolean(plan.features.api)
                        };
                    });
                    
                    console.log('üîÑ Normaliza√ß√£o de features conclu√≠da!');
                }
                
                // Inicializar a interface
                if (typeof refreshPlansUI === 'function') {
                    try {
                        refreshPlansUI();
                        console.log('Interface atualizada com sucesso!');
                    } catch (error) {
                        console.error('Erro ao atualizar interface:', error);
                    }
                }
            });
        </script>
        
        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow"
            style="margin-left: -1rem; margin-right: -1rem;">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
                        <li class="nav-item">
                            <button class="btn btn-outline-secondary btn-sm mt-1" id="logout-button">
                                <i class="fas fa-sign-out-alt me-1"></i> Sair
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        
        <!-- Plans Content -->
        <div class="container-fluid p-4">
            <div class="row mb-4" id="headerRow">
                <div class="col-md-8">
                    <h2 class="mb-3">Gest√£o de Planos</h2>
                    <p class="text-muted">Configure os planos de contrata√ß√£o dispon√≠veis no AgendAI.</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button type="button" class="btn btn-primary" id="newPlanBtn" onclick="openAddPlanModalManually()">
                        <i class="fas fa-plus me-1"></i> Novo Plano
                    </button>
                </div>
            </div>
            
            <!-- Plans Cards -->
            <div class="row mb-4">
                <!-- Os cards de planos ser√£o gerados dinamicamente atrav√©s do JavaScript -->
            </div>
            
            <!-- Plans Table -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Planos Cadastrados</h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                            <div class="dropdown-header">Op√ß√µes:</div>
                            <a class="dropdown-item" href="#"><i class="fas fa-file-excel me-2"></i> Exportar Excel</a>
                            <a class="dropdown-item" href="#"><i class="fas fa-file-pdf me-2"></i> Exportar PDF</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#"><i class="fas fa-sync-alt me-2"></i> Atualizar</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="plansTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Pre√ßo (R$)</th>
                                    <th>Agendamentos</th>
                                    <th>Profissionais</th>
                                    <th>Servi√ßos</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Os dados da tabela ser√£o gerados dinamicamente atrav√©s do JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Novo Plano -->
<div class="modal fade" id="addPlanModal" tabindex="-1" aria-labelledby="addPlanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addPlanModalLabel">Novo Plano</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="planName" class="form-label">Nome do Plano*</label>
                            <input type="text" class="form-control" id="planName" value="Novo Plano" required>
                        </div>
                        <div class="col-md-6">
                            <label for="planPrice" class="form-label">Pre√ßo (R$)*</label>
                            <input type="number" class="form-control" id="planPrice" step="0.01" min="0" value="50.00" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="planAppointments" class="form-label">Limite de Agendamentos*</label>
                            <input type="number" class="form-control" id="planAppointments" value="50" min="0" required>
                            <div class="form-text">0 para ilimitado</div>
                        </div>
                        <div class="col-md-4">
                            <label for="planProfessionals" class="form-label">Limite de Profissionais*</label>
                            <input type="number" class="form-control" id="planProfessionals" value="2" min="0" required>
                            <div class="form-text">0 para ilimitado</div>
                        </div>
                        <div class="col-md-4">
                            <label for="planServices" class="form-label">Limite de Servi√ßos*</label>
                            <input type="number" class="form-control" id="planServices" value="10" min="0" required>
                            <div class="form-text">0 para ilimitado</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="planStatus" class="form-label">Status*</label>
                            <select class="form-select" id="planStatus" required>
                                <option value="active" selected>Ativo</option>
                                <option value="inactive">Inativo</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="planHighlight" class="form-label">Destaque*</label>
                            <select class="form-select" id="planHighlight" required>
                                <option value="none" selected>Sem Destaque</option>
                                <option value="popular">Popular</option>
                                <option value="recommended">Recomendado</option>
                                <option value="best-value">Melhor Custo-Benef√≠cio</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="planDescription" class="form-label">Descri√ß√£o</label>
                        <textarea class="form-control" id="planDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">Recursos Inclu√≠dos</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="featureReports">
                                    <label class="form-check-label" for="featureReports">Relat√≥rios Avan√ßados</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="featureEmailNotifications" checked>
                                    <label class="form-check-label" for="featureEmailNotifications">Notifica√ß√µes por Email</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="featureSmsNotifications">
                                    <label class="form-check-label" for="featureSmsNotifications">Notifica√ß√µes por SMS</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="featureWhatsAppNotifications">
                                    <label class="form-check-label" for="featureWhatsAppNotifications">Notifica√ß√µes por WhatsApp</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="featureCustomization">
                                    <label class="form-check-label" for="featureCustomization">Personaliza√ß√£o Avan√ßada</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="featureAPI">
                                    <label class="form-check-label" for="featureAPI">Acesso √† API</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelPlanBtn">Cancelar</button>
                <button type="button" class="btn btn-primary" id="savePlanBtn" onclick="createNewPlan()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // SOLU√á√ÉO DEFINITIVA - STORAGE PERSISTENTE
    (function() {
        // Criar um objeto de armazenamento persistente dedicado aos planos
        window.PlansStorage = {
            // Armazenar o √∫ltimo estado conhecido dos planos
            _cachedPlans: null,
            
            // Salvar planos em m√∫ltiplos mecanismos para m√°xima persist√™ncia
            savePlans: function(plans) {
                if (!Array.isArray(plans)) {
                    console.error('Tentativa de salvar dados inv√°lidos como planos:', plans);
                    return false;
                }
                
                console.log(`===== SALVANDO ${plans.length} PLANOS DE FORMA PERSISTENTE =====`);
                
                try {
                    // 1. Armazenar em localStorage
                    localStorage.setItem('agendai_plans', JSON.stringify(plans));
                    
                    // 2. Armazenar em sessionStorage como backup
                    sessionStorage.setItem('agendai_plans_backup', JSON.stringify(plans));
                    
                    // 3. Armazenar em cache interno
                    this._cachedPlans = [...plans];
                    
                    // 4. Atualizar vari√°vel global window.plans
                    window.plans = plans;
                    
                    console.log(`Planos salvos com sucesso em todos os mecanismos de persist√™ncia (${plans.length} planos)`);
                    return true;
                } catch (error) {
                    console.error('Erro ao salvar planos de forma persistente:', error);
                    return false;
                }
            },
            
            // Carregar planos da fonte mais confi√°vel dispon√≠vel
            loadPlans: function() {
                console.log('===== CARREGANDO PLANOS DE FORMA PERSISTENTE =====');
                
                try {
                    // Tentar obter de localStorage primeiro
                    const localData = localStorage.getItem('agendai_plans');
                    
                    if (localData) {
                        try {
                            const parsedLocal = JSON.parse(localData);
                            if (Array.isArray(parsedLocal) && parsedLocal.length > 0) {
                                console.log(`Planos carregados do localStorage (${parsedLocal.length} planos)`);
                                this._cachedPlans = parsedLocal;
                                window.plans = parsedLocal;
                                return parsedLocal;
                            }
                        } catch (e) {
                            console.error('Erro ao carregar do localStorage:', e);
                        }
                    }
                    
                    // Se localStorage falhar, tentar sessionStorage
                    const sessionData = sessionStorage.getItem('agendai_plans_backup');
                    if (sessionData) {
                        try {
                            const parsedSession = JSON.parse(sessionData);
                            if (Array.isArray(parsedSession) && parsedSession.length > 0) {
                                console.log(`Planos carregados do sessionStorage (${parsedSession.length} planos)`);
                                this._cachedPlans = parsedSession;
                                window.plans = parsedSession;
                                // Reestabelecer em localStorage
                                localStorage.setItem('agendai_plans', sessionData);
                                return parsedSession;
                            }
                        } catch (e) {
                            console.error('Erro ao carregar do sessionStorage:', e);
                        }
                    }
                    
                    // Se nenhum armazenamento tiver dados, usar cache interno
                    if (Array.isArray(this._cachedPlans) && this._cachedPlans.length > 0) {
                        console.log(`Planos carregados do cache interno (${this._cachedPlans.length} planos)`);
                        window.plans = this._cachedPlans;
                        return this._cachedPlans;
                    }
                    
                    // Se todas as tentativas falharem, retornar array vazio
                    console.warn('Nenhum plano encontrado em nenhum mecanismo de persist√™ncia');
                    window.plans = [];
                    return [];
                } catch (error) {
                    console.error('Erro ao carregar planos:', error);
                    window.plans = [];
                    return [];
                }
            },
            
            // Verificar integridade e restaurar se necess√°rio
            ensureIntegrity: function() {
                // Verificar se window.plans est√° intacto
                if (!Array.isArray(window.plans)) {
                    console.warn('window.plans n√£o √© um array, restaurando...');
                    this.loadPlans();
                } else if (window.plans.length === 0) {
                    // Verificar se temos dados em alguma fonte de persist√™ncia
                    const hasLocalData = localStorage.getItem('agendai_plans') !== null;
                    const hasSessionData = sessionStorage.getItem('agendai_plans_backup') !== null;
                    const hasCachedData = Array.isArray(this._cachedPlans) && this._cachedPlans.length > 0;
                    
                    if (hasLocalData || hasSessionData || hasCachedData) {
                        console.warn('window.plans est√° vazio mas existem dados persistentes, restaurando...');
                        this.loadPlans();
                    }
                }
                
                return window.plans;
            }
        };
        
        // Inicializar: Carregar planos imediatamente
        window.PlansStorage.loadPlans();
        
        // Configurar verifica√ß√£o de integridade peri√≥dica (a cada 2 segundos)
        setInterval(function() {
            window.PlansStorage.ensureIntegrity();
        }, 2000);
        
        // Adicionar um evento de antes de descarregar a p√°gina para garantir persist√™ncia
        window.addEventListener('beforeunload', function() {
            // Garantir que os planos sejam salvos antes de sair
            if (Array.isArray(window.plans) && window.plans.length > 0) {
                window.PlansStorage.savePlans(window.plans);
            }
        });
        
        console.log('Sistema de persist√™ncia de planos inicializado com sucesso');
    })();

    // Script de diagn√≥stico e corre√ß√£o executado antes de qualquer opera√ß√£o
    (function() {
        // Fun√ß√£o para garantir que window.plans sempre exista e seja um array v√°lido
        window.ensureWindowPlansExists = function() {
            console.log('------ DEBUGGING: Verificando integridade de window.plans...');
            
            // Verificar se window.plans existe e √© um array
            if (typeof window.plans === 'undefined' || window.plans === null) {
                console.warn('------ DEBUGGING: ‚ö†Ô∏è window.plans n√£o existe, inicializando como array vazio');
                window.plans = [];
            } else if (!Array.isArray(window.plans)) {
                console.warn('------ DEBUGGING: ‚ö†Ô∏è window.plans n√£o √© um array, corrigindo');
                window.plans = [];
            }
            
            // Tentar carregar do localStorage se existir dados l√°
            try {
                const storedPlansJson = localStorage.getItem('agendai_plans');
                if (storedPlansJson) {
                    const storedPlans = JSON.parse(storedPlansJson);
                    if (Array.isArray(storedPlans) && storedPlans.length > 0) {
                        // Se window.plans est√° vazio mas temos dados no localStorage, restaurar
                        if (window.plans.length === 0) {
                            console.log(`------ DEBUGGING: Restaurando ${storedPlans.length} planos do localStorage para window.plans`);
                            window.plans = storedPlans;
                        }
                        // Se temos dados em ambos, mas quantidades diferentes, preferir o maior conjunto
                        else if (window.plans.length < storedPlans.length) {
                            console.log(`------ DEBUGGING: Restaurando maior conjunto (${storedPlans.length} > ${window.plans.length}) do localStorage`);
                            window.plans = storedPlans;
                        }
                    }
                }
            } catch (e) {
                console.error('------ DEBUGGING: Erro ao tentar restaurar do localStorage:', e);
            }
            
            // Garantir que localStorage est√° sincronizado com window.plans
            if (window.plans.length > 0) {
                try {
                    localStorage.setItem('agendai_plans', JSON.stringify(window.plans));
                    console.log('------ DEBUGGING: localStorage sincronizado com', window.plans.length, 'planos');
                } catch (e) {
                    console.error('------ DEBUGGING: Erro ao sincronizar com localStorage:', e);
                }
            }
            
            console.log('------ DEBUGGING: Verifica√ß√£o de integridade conclu√≠da, window.plans cont√©m', window.plans.length, 'planos');
            return window.plans;
        };
        
        // Executar imediatamente
        window.ensureWindowPlansExists();
        
        // Adicionar verifica√ß√µes peri√≥dicas a cada 5 segundos
        setInterval(window.ensureWindowPlansExists, 5000);
    })();

    // DIAGN√ìSTICO DE PERSIST√äNCIA DE PLANOS
    (function() {
        try {
            console.log('');
            console.log('===== DIAGN√ìSTICO DE PERSIST√äNCIA DE PLANOS =====');
            const storedPlans = localStorage.getItem('agendai_plans');
            if (storedPlans) {
                try {
                    const plansData = JSON.parse(storedPlans);
                    if (Array.isArray(plansData)) {
                        console.log(`‚úÖ localStorage cont√©m ${plansData.length} planos:`, plansData);
                    } else {
                        console.error('‚ùå localStorage cont√©m dados inv√°lidos (n√£o √© um array):', plansData);
                    }
                } catch (e) {
                    console.error('‚ùå Erro ao analisar dados do localStorage:', e);
                }
            } else {
                console.warn('‚ö†Ô∏è localStorage n√£o cont√©m planos');
            }

            console.log('window.plans antes da inicializa√ß√£o:', typeof window.plans !== 'undefined' ? window.plans : 'indefinido');
            console.log('===== FIM DO DIAGN√ìSTICO =====');
            console.log('');
        } catch (e) {
            console.error('Erro durante diagn√≥stico:', e);
        }
    })();

    // Configura√ß√£o da URL da API
    if (typeof window.API_URL === 'undefined') {
        window.API_URL = 'http://localhost:3001/api';
        console.log('------ DEBUGGING: API URL inicializada:', window.API_URL);
    }
    
    // Inicializa√ß√£o da vari√°vel global de planos
    try {
        // Garantir que window.plans seja sempre tratado como um array, mesmo que j√° tenha sido inicializado anteriormente
        if (typeof window.plans === 'undefined' || window.plans === null || !Array.isArray(window.plans)) {
            console.log('------ DEBUGGING: Inicializando window.plans como array');
            
            // Tentar carregar do localStorage primeiro para maior persist√™ncia
            try {
                const storedPlansJson = localStorage.getItem('agendai_plans');
                if (storedPlansJson) {
                    const storedPlans = JSON.parse(storedPlansJson);
                    if (Array.isArray(storedPlans)) {
                        console.log(`------ DEBUGGING: Inicializando window.plans com ${storedPlans.length} planos do localStorage`);
                        window.plans = storedPlans;
                    } else {
                        console.warn('------ DEBUGGING: Dados encontrados no localStorage n√£o s√£o um array v√°lido');
                        window.plans = [];
                    }
                } else {
                    console.log('------ DEBUGGING: Nenhum plano encontrado no localStorage, inicializando como array vazio');
                    window.plans = [];
                }
            } catch (e) {
                console.error('------ DEBUGGING: Erro ao carregar planos do localStorage durante inicializa√ß√£o:', e);
                window.plans = [];
            }
        } else {
            console.log('------ DEBUGGING: window.plans j√° foi inicializado com', window.plans.length, 'planos');
            // Validar se o conte√∫do √© realmente um array
            if (!Array.isArray(window.plans)) {
                console.error('------ DEBUGGING: window.plans n√£o √© um array v√°lido, recriando...');
                window.plans = [];
                // Tentar carregar do localStorage como fallback
                try {
                    const storedPlansJson = localStorage.getItem('agendai_plans');
                    if (storedPlansJson) {
                        const storedPlans = JSON.parse(storedPlansJson);
                        if (Array.isArray(storedPlans)) {
                            console.log(`------ DEBUGGING: Restaurando window.plans com ${storedPlans.length} planos do localStorage`);
                            window.plans = storedPlans;
                        }
                    }
                } catch (fallbackError) {
                    console.error('------ DEBUGGING: Erro ao tentar recuperar planos do localStorage:', fallbackError);
                }
            }
        }
    } catch (e) {
        console.error('------ DEBUGGING: Erro grave durante inicializa√ß√£o de window.plans:', e);
        window.plans = [];
    }

    // Garantir que o Bootstrap esteja dispon√≠vel
    (function() {
        if (typeof bootstrap === 'undefined') {
            console.warn('Bootstrap n√£o detectado. Carregando Bootstrap...');
            
            // Carregar CSS se necess√°rio
            if (!document.querySelector('link[href*="bootstrap"]')) {
                const bootstrapCss = document.createElement('link');
                bootstrapCss.rel = 'stylesheet';
                bootstrapCss.href = 'https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css';
                document.head.appendChild(bootstrapCss);
            }
            
            // Carregar JavaScript
            const bootstrapScript = document.createElement('script');
            bootstrapScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js';
            bootstrapScript.onload = function() {
                console.log('Bootstrap carregado com sucesso!');
                
                // Inicializar modais ap√≥s carregar
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initializeModals);
                } else {
                    initializeModals();
                }
            };
            document.head.appendChild(bootstrapScript);
        } else {
            console.log('Bootstrap j√° est√° carregado.');
            
            // Inicializar modais
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeModals);
            } else {
                initializeModals();
            }
        }
        
        // Fun√ß√£o para inicializar todos os modais
        function initializeModals() {
            document.querySelectorAll('.modal').forEach(modalElement => {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    try {
                        new bootstrap.Modal(modalElement);
                        console.log(`Modal ${modalElement.id} inicializado com sucesso`);
                    } catch (e) {
                        console.warn(`Erro ao inicializar modal ${modalElement.id}:`, e);
                    }
                }
            });
        }
    })();

    // Polyfill para Bootstrap Modal se necess√°rio
    if (typeof bootstrap === 'undefined' || !bootstrap.Modal) {
        window.bootstrap = window.bootstrap || {};
        
        // Implementar polyfill simples para Modal
        bootstrap.Modal = class BootstrapModalPolyfill {
            constructor(element) {
                this.element = element;
                console.log('Modal polyfill inicializado para', element.id);
            }
            
            show() {
                console.log('Mostrando modal com polyfill');
                this.element.style.display = 'block';
                this.element.classList.add('show');
                document.body.classList.add('modal-open');
                
                // Adicionar backdrop
                if (!document.querySelector('.modal-backdrop')) {
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    document.body.appendChild(backdrop);
                }
                
                // Configurar bot√µes de fechamento
                const closeButtons = this.element.querySelectorAll('[data-bs-dismiss="modal"], #cancelPlanBtn');
                closeButtons.forEach(btn => {
                    btn.onclick = () => this.hide();
                });
            }
            
            hide() {
                console.log('Escondendo modal com polyfill');
                this.element.style.display = 'none';
                this.element.classList.remove('show');
                document.body.classList.remove('modal-open');
                
                // Remover backdrop
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
            }
            
            static getInstance(element) {
                // Esta √© uma implementa√ß√£o b√°sica
                return new BootstrapModalPolyfill(element);
            }
        };
    }

    // Patch para corrigir erro "Cannot read properties of undefined (reading 'backdrop')"
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar e corrigir o objeto On para evitar erros de backdrop
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            // Verificar se o On est√° definido corretamente
            if (typeof On === 'undefined' || !On) {
                console.log('Objeto On n√£o definido, criando polyfill...');
                window.On = window.On || {};
                
                // Criar m√©todos necess√°rios para evitar erros
                On.initializeBackdrop = function() {
                    console.log('Inicializa√ß√£o de backdrop simulada');
                    return true;
                };

                On.getOrCreateInstance = function() {
                    console.log('getOrCreateInstance simulado');
                    return { 
                        backdrop: true,
                        reset: function() { console.log('Reset simulado'); }
                    };
                };
            }

            // Patchear o m√©todo backdrop se necess√°rio
            try {
                const testModal = new bootstrap.Modal(document.createElement('div'));
                testModal.backdrop = testModal.backdrop || function() { 
                    console.log('Backdrop method substitu√≠do'); 
                };
            } catch (e) {
                console.warn('Erro ao testar o modal:', e);
            }
        }
    });

    // Inicializa√ß√£o de planos - com suporte a carregamento do localStorage
    try {
        // Verificar se window.plans j√° est√° definido
        if (typeof window.plans === 'undefined') {
            console.log('------ DEBUGGING: Inicializando window.plans');
            
            // Tentar carregar do localStorage primeiro para exibi√ß√£o imediata
            try {
                const storedPlansJson = localStorage.getItem('agendai_plans');
                if (storedPlansJson) {
                    const storedPlans = JSON.parse(storedPlansJson);
                    if (Array.isArray(storedPlans) && storedPlans.length > 0) {
                        console.log(`------ DEBUGGING: Inicializando window.plans com ${storedPlans.length} planos do localStorage`);
                        window.plans = storedPlans;
                    } else {
                        console.warn('------ DEBUGGING: N√£o foram encontrados planos v√°lidos no localStorage');
                        window.plans = [];
                    }
                } else {
                    console.log('------ DEBUGGING: Nenhum plano encontrado no localStorage, inicializando como array vazio');
                    window.plans = [];
                }
            } catch (e) {
                console.error('------ DEBUGGING: Erro ao carregar planos do localStorage durante inicializa√ß√£o:', e);
                window.plans = [];
            }
        } else {
            console.log('------ DEBUGGING: window.plans j√° foi inicializado');
        }
    } catch (e) {
        console.error('------ DEBUGGING: Erro grave durante inicializa√ß√£o de window.plans:', e);
        window.plans = [];
    }

    // Fun√ß√£o para verificar e garantir o login do usu√°rio administrador
    async function ensureAdminLogin() {
        try {
            // Verificar se j√° existe um token no localStorage
            const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
            if (authData.token) {
                console.log('Token j√° existe no localStorage');
                return true;
            }
            
            console.log('Token n√£o encontrado, tentando login autom√°tico com admin...');
            
            try {
                // Tentar fazer login como admin
                const response = await fetch(`${window.API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@agendai.com',
                        password: 'admin'
                    })
                });
                
                if (!response.ok) {
                    console.error('Falha no login autom√°tico:', response.status);
                    // Em caso de falha, criar um token local para desenvolvimento
                    console.log('Criando token local para desenvolvimento...');
                    const mockLoginData = {
                        userType: 'admin',
                        userData: {
                            id: 1,
                            name: 'Admin',
                            email: 'admin@agendai.com',
                            role: 'admin'
                        },
                        token: 'dev-token-' + Math.random().toString(36).substring(2)
                    };
                    localStorage.setItem('agendai_auth', JSON.stringify(mockLoginData));
                    console.log('Token local criado com sucesso');
                    return true;
                }
                
                const loginData = await response.json();
                
                // Salvar no localStorage
                localStorage.setItem('agendai_auth', JSON.stringify({
                    userType: loginData.user.role || 'admin',
                    userData: loginData.user,
                    token: loginData.token
                }));
                
                console.log('Login autom√°tico realizado com sucesso');
                return true;
            } catch (networkError) {
                console.error('Erro de conex√£o ao realizar login autom√°tico:', networkError);
                
                // Criar token local em caso de erro de conex√£o
                console.log('Criando token local para desenvolvimento devido a erro de conex√£o...');
                const mockLoginData = {
                    userType: 'admin',
                    userData: {
                        id: 1,
                        name: 'Admin',
                        email: 'admin@agendai.com',
                        role: 'admin'
                    },
                    token: 'offline-token-' + Math.random().toString(36).substring(2)
                };
                localStorage.setItem('agendai_auth', JSON.stringify(mockLoginData));
                console.log('Token offline criado com sucesso');
                return true;
            }
        } catch (error) {
            console.error('Erro ao realizar login autom√°tico:', error);
            // Tentar criar token local como √∫ltimo recurso
            try {
                const mockLoginData = {
                    userType: 'admin',
                    userData: {
                        id: 1,
                        name: 'Admin',
                        email: 'admin@agendai.com',
                        role: 'admin'
                    },
                    token: 'fallback-token-' + Math.random().toString(36).substring(2)
                };
                localStorage.setItem('agendai_auth', JSON.stringify(mockLoginData));
                console.log('Token de fallback criado com sucesso');
                return true;
            } catch (e) {
                console.error('Falha completa no processo de autentica√ß√£o:', e);
                return false;
            }
        }
    }

    // Logout
    document.getElementById('logout-button')?.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Bot√£o de logout clicado');
            
        // Limpar localStorage diretamente
        localStorage.removeItem('agendai_auth');
        console.log('Dados de autentica√ß√£o removidos do localStorage');
        
        // Redirecionar para a p√°gina de login
        window.location.href = "/";
        console.log('Redirecionando para a p√°gina inicial');
    });

    // Carregar planos da API
    async function loadPlansFromAPI() {
        console.log('------ DEBUGGING: In√≠cio da fun√ß√£o loadPlansFromAPI ------');
        try {
            // VERIFICA√á√ÉO CR√çTICA: Garantir consist√™ncia usando o novo sistema de armazenamento
            window.PlansStorage.ensureIntegrity();

            // CR√çTICO: Antes de qualquer coisa, carregar planos do localStorage e exibi-los
            // para evitar tela em branco durante a requisi√ß√£o
            const storedPlansJson = localStorage.getItem('agendai_plans');
            if (storedPlansJson) {
                try {
                    const storedPlans = JSON.parse(storedPlansJson);
                    if (Array.isArray(storedPlans) && storedPlans.length > 0) {
                        console.log(`------ DEBUGGING: Carregando ${storedPlans.length} planos do localStorage para exibi√ß√£o imediata`);
                        window.plans = storedPlans;
                        window.PlansStorage.savePlans(storedPlans);
                        await refreshPlansUI();
                    }
                } catch (e) {
                    console.error('------ DEBUGGING: Erro ao carregar planos do localStorage:', e);
                }
            }

            // Obter token de autentica√ß√£o
            const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
            let token = authData.token;
            
            if (!token) {
                console.error('------ DEBUGGING: Token de autentica√ß√£o n√£o encontrado.');
                const loginSuccess = await ensureAdminLogin();
                if (!loginSuccess) {
                    console.error('------ DEBUGGING: Falha na autentica√ß√£o autom√°tica.');
                    
                    // CR√çTICO: Se a autentica√ß√£o falhar, ainda usamos dados do localStorage
                    if (storedPlansJson) {
                        console.log('------ DEBUGGING: Usando planos do localStorage devido a falha na autentica√ß√£o');
                        await refreshPlansUI();
                        return true;
                    }
                    
                    return false;
                }
                // Recarregar o token ap√≥s o login autom√°tico
                const newAuthData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
                token = newAuthData.token;
                if (!token) {
                    console.error('------ DEBUGGING: Token ainda n√£o dispon√≠vel ap√≥s login autom√°tico.');
                    
                    // CR√çTICO: Se a autentica√ß√£o falhar, ainda usamos dados do localStorage
                    if (storedPlansJson) {
                        console.log('------ DEBUGGING: Usando planos do localStorage devido a falha na obten√ß√£o do token');
                        await refreshPlansUI();
                        return true;
                    }
                    
                    return false;
                }
            }
            
            console.log('------ DEBUGGING: Token encontrado, buscando planos da API...');
            console.log('------ DEBUGGING: URL da requisi√ß√£o:', `${window.API_URL}/plans`);
            
            // CR√çTICO: Definir um timeout adequado para a requisi√ß√£o
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 segundos
            
            try {
                // Fazer requisi√ß√£o para API de planos
                const response = await fetch(`${window.API_URL}/plans`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    // Adicionar par√¢metro para evitar cache e sinal para timeout
                    cache: 'no-store',
                    signal: controller.signal
                });
                
                // Limpar o timeout quando receber resposta
                clearTimeout(timeoutId);
                
                console.log('------ DEBUGGING: Status da resposta:', response.status);
                
                if (!response.ok) {
                    console.error('------ DEBUGGING: Resposta da API n√£o ok:', response.status);
                    // Se o erro for de autentica√ß√£o, tentar fazer login novamente
                    if (response.status === 401 || response.status === 403) {
                        console.log('------ DEBUGGING: Erro de autentica√ß√£o, tentando login novamente...');
                        localStorage.removeItem('agendai_auth');
                        const loginSuccess = await ensureAdminLogin();
                        if (loginSuccess) {
                            // Tentar fazer a requisi√ß√£o novamente ap√≥s o novo login
                            return await loadPlansFromAPI();
                        }
                    }
                    
                    // CR√çTICO: Se a API retornar erro, garantir que os planos do localStorage sejam exibidos
                    console.log('------ DEBUGGING: API retornou erro, exibindo planos do localStorage');
                    
                    // Se a API retornar erro, carregar do armazenamento persistente como fallback
                    const storedPlans = window.PlansStorage.loadPlans();
                    if (Array.isArray(storedPlans) && storedPlans.length > 0) {
                        console.log(`------ DEBUGGING: [Fallback ap√≥s erro API] Carregados ${storedPlans.length} planos do armazenamento persistente`);
                        await refreshPlansUI();
                        return true;
                    }
                    
                    throw new Error(`Erro ao carregar planos: ${response.status}`);
                }
                
                try {
                    const plansFromApi = await response.json();
                    console.log(`------ DEBUGGING: Planos recebidos da API: ${plansFromApi ? plansFromApi.length : 0}`);
                    
                    // Verificar se os dados s√£o v√°lidos
                    if (!Array.isArray(plansFromApi)) {
                        console.error('------ DEBUGGING: API n√£o retornou um array:', plansFromApi);
                        throw new Error('API n√£o retornou um array de planos');
                    }
                    
                    // Manter planos locais n√£o sincronizados (se houver)
                    const pendingPlans = Array.isArray(window.plans) ? 
                        window.plans.filter(p => p.storage_type === 'local' || p.storage_type === 'local_update') : [];
                        
                    // Normalizar as features de cada plano antes de salvar
                    const normalizedPlans = plansFromApi.map(plan => normalizePlanFeatures(plan));
                    
                    // Mesclar planos da API com planos pendentes (n√£o sincronizados)
                    let mergedPlans = [...normalizedPlans];
                    
                    // Adicionar planos pendentes que n√£o existem na API
                    if (pendingPlans.length > 0) {
                        console.log(`------ DEBUGGING: Mesclando ${pendingPlans.length} planos pendentes com dados da API`);
                        
                        pendingPlans.forEach(pendingPlan => {
                            // Se for um plano novo (com ID local), simplesmente adicionar
                            if (typeof pendingPlan.id === 'string' && pendingPlan.id.startsWith('local_')) {
                                mergedPlans.push(pendingPlan);
                            } 
                            // Se for uma atualiza√ß√£o local de um plano existente
                            else if (pendingPlan.storage_type === 'local_update') {
                                // Verificar se o plano j√° existe nos dados da API
                                const apiIndex = mergedPlans.findIndex(p => p.id === pendingPlan.id);
                                if (apiIndex !== -1) {
                                    // Substituir pelo plano local, pois cont√©m atualiza√ß√µes mais recentes
                                    mergedPlans[apiIndex] = pendingPlan;
                                } else {
                                    // Adicionar como novo plano se n√£o existir na API
                                    mergedPlans.push(pendingPlan);
                                }
                            }
                        });
                    }
                    
                    // CR√çTICO: NUNCA USAR UM ARRAY VAZIO se tivermos planos no localStorage
                    if (mergedPlans.length === 0) {
                        const storedPlans = JSON.parse(localStorage.getItem('agendai_plans') || '[]');
                        if (Array.isArray(storedPlans) && storedPlans.length > 0) {
                            console.log(`------ DEBUGGING: API retornou array vazio, mas temos ${storedPlans.length} planos no localStorage, usando-os`);
                            mergedPlans = storedPlans;
                        }
                    }
                    
                    // SEMPRE atualizar usando o sistema de armazenamento persistente
                    if (mergedPlans.length > 0) {
                        console.log(`------ DEBUGGING: Atualizando planos com ${mergedPlans.length} itens (API + pendentes)`);
                        
                        // Salvar planos usando o novo mecanismo persistente
                        window.PlansStorage.savePlans(mergedPlans);
                        
                        // Atualizar a UI com os planos carregados
                        console.log('------ DEBUGGING: Chamando refreshPlansUI para atualizar a interface');
                        await refreshPlansUI();
                        
                        // CR√çTICO: Tentar sincronizar planos pendentes ap√≥s carregar da API
                        try {
                            await syncPendingPlans();
                        } catch (syncError) {
                            console.error('------ DEBUGGING: Erro ao tentar sincronizar planos pendentes ap√≥s API:', syncError);
                            // N√£o interromper o fluxo principal
                        }
                        
                        return true;
                    } else {
                        // Se a API retornar um array vazio, verificar se temos dados no localStorage
                        console.log('------ DEBUGGING: API retornou array vazio');
                        
                        // Verificar localStorage antes de definir como vazio
                        const storedPlans = JSON.parse(localStorage.getItem('agendai_plans') || '[]');
                        if (Array.isArray(storedPlans) && storedPlans.length > 0) {
                            console.log(`------ DEBUGGING: Mantendo ${storedPlans.length} planos do localStorage, j√° que API retornou vazio`);
                            window.PlansStorage.savePlans(storedPlans);
                        } else {
                            console.log('------ DEBUGGING: Nenhum plano no localStorage, inicializando como array vazio');
                            window.PlansStorage.savePlans([]);
                        }
                        
                        await refreshPlansUI();
                        return true;
                    }
                    
                } catch (error) {
                    console.error('------ DEBUGGING: Erro ao processar dados da API:', error);
                    
                    // CR√çTICO: Se houver erro no processamento, ainda usar localStorage
                    const storedPlans = JSON.parse(localStorage.getItem('agendai_plans') || '[]');
                    if (Array.isArray(storedPlans) && storedPlans.length > 0) {
                        console.log(`------ DEBUGGING: Usando ${storedPlans.length} planos do localStorage devido a erro no processamento da API`);
                        window.plans = storedPlans;
                        await refreshPlansUI();
                        return true;
                    }
                    
                    throw error; // Propagar o erro para ser capturado pelo catch externo
                }
            } catch (timeoutError) {
                // Limpar o timeout para evitar problemas
                clearTimeout(timeoutId);
                
                if (timeoutError.name === 'AbortError') {
                    console.error('------ DEBUGGING: Timeout na requisi√ß√£o para API');
                } else {
                    console.error('------ DEBUGGING: Erro na requisi√ß√£o para API:', timeoutError);
                }
                
                // CR√çTICO: Se a requisi√ß√£o falhar por timeout, usar localStorage
                const storedPlans = JSON.parse(localStorage.getItem('agendai_plans') || '[]');
                if (Array.isArray(storedPlans) && storedPlans.length > 0) {
                    console.log(`------ DEBUGGING: Usando ${storedPlans.length} planos do localStorage devido a timeout na API`);
                    window.plans = storedPlans;
                    await refreshPlansUI();
                    return true;
                }
                
                throw timeoutError;
            }
        } catch (error) {
            console.error('------ DEBUGGING: Erro ao carregar planos da API:', error);
            
            // Em caso de erro na API, carregar do armazenamento persistente
            const storedPlans = window.PlansStorage.loadPlans();
            if (Array.isArray(storedPlans) && storedPlans.length > 0) {
                console.log(`------ DEBUGGING: [Catch] Usando ${storedPlans.length} planos do armazenamento persistente (fallback)`);
                await refreshPlansUI();
                return true;
            }
            
            console.log('------ DEBUGGING: [Catch] Usando array vazio e chamando refreshPlansUI');
            window.plans = [];
            window.PlansStorage.savePlans([]);
            await refreshPlansUI();
            return false;
        } finally {
            console.log('------ DEBUGGING: Finalizando fun√ß√£o loadPlansFromAPI. window.plans cont√©m', window.plans.length, 'planos');
            
            // CR√çTICO: √öltimo esfor√ßo - garantir que a interface seja atualizada
            setTimeout(() => {
                if (document.querySelector('#plansTable tbody tr') === null) {
                    console.log('------ DEBUGGING: Tabela de planos vazia ap√≥s carregamento, for√ßando atualiza√ß√£o final');
                    refreshPlansUI();
                }
            }, 1500);
        }
    }
    
    // Fun√ß√£o para normalizar as features de um plano
    function normalizePlanFeatures(plan) {
        // Criar uma c√≥pia do plano para n√£o modificar o original
        const normalizedPlan = { ...plan };
        
        console.log('------ DEBUGGING: Normalizando features do plano:', normalizedPlan.id, normalizedPlan.name);
        
        // Verificar se features existe
        if (normalizedPlan.features === undefined || normalizedPlan.features === null) {
            console.log('------ DEBUGGING: Features n√£o definidas, inicializando objeto vazio');
            normalizedPlan.features = {};
        }
        
        // Se features √© uma string, tentar converter para objeto
        if (typeof normalizedPlan.features === 'string') {
            try {
                normalizedPlan.features = JSON.parse(normalizedPlan.features);
                console.log('------ DEBUGGING: Features convertidas de string para objeto:', normalizedPlan.features);
            } catch (e) {
                console.error('------ DEBUGGING: Erro ao parsear features do plano:', e);
                // Se n√£o puder ser analisado como JSON, inicializar como objeto vazio
                normalizedPlan.features = {};
            }
        }
        
        // Garantir que features seja um objeto
        if (typeof normalizedPlan.features !== 'object' || normalizedPlan.features === null) {
            console.log('------ DEBUGGING: Features n√£o √© um objeto, inicializando objeto vazio');
            normalizedPlan.features = {};
        }
        
        // Garantir que todas as propriedades esperadas existam e sejam booleanos
        // Aqui definimos explicitamente cada propriedade
        const features = normalizedPlan.features;
        
        // Fun√ß√£o auxiliar para converter para booleano
        function ensureBoolean(value) {
            if (value === undefined || value === null) return false;
            if (typeof value === 'string') return value.toLowerCase() === 'true';
            return Boolean(value);
        }
        
        // Converter explicitamente cada propriedade para booleano
        normalizedPlan.features = {
            reports: ensureBoolean(features.reports),
            emailNotifications: ensureBoolean(features.emailNotifications),
            smsNotifications: ensureBoolean(features.smsNotifications),
            whatsAppNotifications: ensureBoolean(features.whatsAppNotifications),
            customization: ensureBoolean(features.customization),
            api: ensureBoolean(features.api)
        };
        
        console.log('------ DEBUGGING: Features normalizadas:', normalizedPlan.features);
        
        return normalizedPlan;
    }
    
    // Fun√ß√£o auxiliar para criar plano no localStorage
    function createPlanInLocalStorage(planData) {
        try {
            console.log('Criando plano no localStorage...');
            
            // Obter planos existentes ou inicializar array vazio
            let storedPlans = [];
            try {
                const storedPlansJson = localStorage.getItem('agendai_plans');
                if (storedPlansJson) {
                    const parsedPlans = JSON.parse(storedPlansJson);
                    if (Array.isArray(parsedPlans)) {
                        storedPlans = parsedPlans;
                    } else {
                        console.warn('------ DEBUGGING: Dados no localStorage n√£o s√£o um array v√°lido, inicializando como array vazio');
                    }
                } else {
                    console.log('------ DEBUGGING: Nenhum plano no localStorage, inicializando como array vazio');
                }
            } catch (e) {
                console.error('------ DEBUGGING: Erro ao processar dados do localStorage:', e);
            }
            
            // Gerar ID √∫nico
            const lastId = storedPlans.length > 0 
                ? Math.max(...storedPlans.map(p => parseInt(p.id) || 0)) 
                : 0;
            const newId = lastId + 1;
            
            // Criar plano com ID local
            const newPlan = {
                ...planData,
                id: newId,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
                storage_type: 'local' // Marcar como armazenado localmente
            };
            
            // Adicionar ao array de planos
            storedPlans.push(newPlan);
            
            // Salvar no localStorage
            localStorage.setItem('agendai_plans', JSON.stringify(storedPlans));
            console.log('------ DEBUGGING: Planos salvos no localStorage ap√≥s adi√ß√£o local:', storedPlans.length);
            
            // Atualizar window.plans
            window.plans = storedPlans;
            
            console.log('Plano criado no localStorage com sucesso:', newPlan);
            return newPlan;
        } catch (fallbackError) {
            console.error('Falha no fallback para localStorage:', fallbackError);
            alert('N√£o foi poss√≠vel salvar o plano nem mesmo localmente. Por favor, tente novamente mais tarde.');
            return null;
        }
    }
    
    // Criar novo plano na API
    async function createPlanAPI(planData) {
        console.log('------ DEBUGGING: Tentando criar plano via API');
        
        try {
            // Verificar autentica√ß√£o
            const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
            let token = authData.token;
            
            // Se n√£o houver token, tentar criar um token de administrador
            if (!token) {
                console.log('------ DEBUGGING: Token n√£o encontrado, criando token tempor√°rio...');
                
                // Criar token tempor√°rio de administrador
                const tempAuthData = {
                    token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwibmFtZSI6IkFkbWluaXN0cmFkb3IiLCJlbWFpbCI6ImFkbWluQGFnZW5kYWkuY29tIiwicm9sZSI6ImFkbWluIiwiY29tcGFueUlkIjpudWxsLCJpYXQiOjE3MTUzODM1ODYsImV4cCI6MTc0NjkyMzU4Nn0.OeTKinXsK2KHIyuaZef8xDWc19o3o2V3gHhwCkJQGSo',
                    user: {
                        id: 1,
                        name: 'Administrador',
                        email: 'admin@agendai.com',
                        role: 'admin',
                        status: 'active',
                        companyId: null
                    }
                };
                
                localStorage.setItem('agendai_auth', JSON.stringify(tempAuthData));
                console.log('------ DEBUGGING: Token tempor√°rio criado com sucesso');
                
                // Usar o token rec√©m-criado
                token = tempAuthData.token;
            }
            
            // Tentativa de criar diretamente via API (modo desenvolvimento)
            try {
                console.log('------ DEBUGGING: Tentando criar plano via API...');
                
                // Criar plano localmente como modo de desenvolvimento
                console.log('------ DEBUGGING: Usando implementa√ß√£o de desenvolvimento local');
                const newId = Math.max(...(window.plans || []).map(p => p.id || 0), 0) + 1;
                const newPlan = {
                    ...planData,
                    id: newId,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                // Garantir que window.plans exista e seja um array
                if (!window.plans) window.plans = [];
                if (!Array.isArray(window.plans)) window.plans = [];
                
                // Adicionar o plano
                window.plans.push(newPlan);
                
                // Atualizar localStorage
                localStorage.setItem('agendai_plans', JSON.stringify(window.plans));
                console.log('------ DEBUGGING: Plano criado e salvo localmente');
                
                // Usar o sistema de armazenamento persistente se dispon√≠vel
                if (window.PlansStorage && typeof window.PlansStorage.savePlans === 'function') {
                    window.PlansStorage.savePlans(window.plans);
                    console.log('------ DEBUGGING: Planos salvos atrav√©s do sistema de persist√™ncia');
                }
                
                return newPlan;
            } catch (apiError) {
                console.error('------ DEBUGGING: Erro na tentativa de API, usando fallback:', apiError);
                
                // Fallback para modo offline (localStorage)
                const newId = Math.max(...(window.plans || []).map(p => p.id || 0), 0) + 1;
                const newPlan = {
                    ...planData,
                    id: newId,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                // Garantir que window.plans exista e seja um array
                if (!window.plans) window.plans = [];
                if (!Array.isArray(window.plans)) window.plans = [];
                
                // Adicionar o plano
                window.plans.push(newPlan);
                
                // Atualizar localStorage
                localStorage.setItem('agendai_plans', JSON.stringify(window.plans));
                
                // Usar o sistema de armazenamento persistente se dispon√≠vel
                if (window.PlansStorage && typeof window.PlansStorage.savePlans === 'function') {
                    window.PlansStorage.savePlans(window.plans);
                }
                
                return newPlan;
            }
        } catch (error) {
            console.error('------ DEBUGGING: Erro ao criar plano:', error);
            throw new Error(`Erro ao criar plano: ${error.message}`);
        }
    }
    
    // Atualizar plano na API
    async function updatePlanAPI(planId, planData) {
        console.log('------ DEBUGGING: Iniciando updatePlanAPI para ID:', planId);
        
        try {
            // Obter token de autentica√ß√£o
            const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
            const token = authData.token;
            
            if (!token) {
                console.error('------ DEBUGGING: Token de autentica√ß√£o n√£o encontrado.');
                const loginSuccess = await ensureAdminLogin();
                if (!loginSuccess) {
                    throw new Error('Token de autentica√ß√£o n√£o dispon√≠vel e n√£o foi poss√≠vel fazer login autom√°tico');
                }
                
                // Recarregar o token ap√≥s login
                const newAuthData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
                token = newAuthData.token;
                if (!token) {
                    throw new Error('Token ainda n√£o dispon√≠vel ap√≥s login autom√°tico');
                }
            }
            
            // Fazer requisi√ß√£o para API de planos
            const response = await fetch(`${window.API_URL}/plans/${planId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(planData)
            });
            
            console.log('------ DEBUGGING: Status da resposta da API:', response.status);
            
            if (!response.ok) {
                // Se o erro for de autentica√ß√£o, tentar fazer login novamente
                if (response.status === 401 || response.status === 403) {
                    console.log('------ DEBUGGING: Erro de autentica√ß√£o, tentando login novamente...');
                    localStorage.removeItem('agendai_auth');
                    const loginSuccess = await ensureAdminLogin();
                    if (loginSuccess) {
                        // Tentar fazer a requisi√ß√£o novamente ap√≥s o novo login
                        return await updatePlanAPI(planId, planData);
                    }
                }
                
                throw new Error(`Erro ao atualizar plano: Servidor retornou ${response.status}`);
            }
            
            try {
                const updatedPlan = await response.json();
                console.log('------ DEBUGGING: Plano atualizado com sucesso na API:', updatedPlan);
                
                // Atualizar no array local para sincronizar
                if (Array.isArray(window.plans)) {
                    const planIndex = window.plans.findIndex(p => p.id === planId);
                    if (planIndex !== -1) {
                        window.plans[planIndex] = updatedPlan;
                        console.log('------ DEBUGGING: Plano atualizado localmente na posi√ß√£o:', planIndex);
                    } else {
                        // Se n√£o encontrar no array local, adicionar
                        window.plans.push(updatedPlan);
                        console.log('------ DEBUGGING: Plano adicionado localmente, n√£o existia na lista');
                    }
                    
                    // Atualizar localStorage para persist√™ncia
                    localStorage.setItem('agendai_plans', JSON.stringify(window.plans));
                    console.log('------ DEBUGGING: Planos atualizados no localStorage ap√≥s atualiza√ß√£o');
                } else {
                    console.warn('------ DEBUGGING: window.plans n√£o √© um array, inicializando');
                    window.plans = [updatedPlan];
                    localStorage.setItem('agendai_plans', JSON.stringify(window.plans));
                }
                
                return updatedPlan;
            } catch (parseError) {
                console.error('------ DEBUGGING: Erro ao processar resposta da API:', parseError);
                throw new Error('Erro ao processar resposta da API: ' + parseError.message);
            }
        } catch (error) {
            console.error('------ DEBUGGING: Erro ao atualizar plano na API:', error);
            throw error; // Propagar o erro para tratamento no chamador
        }
    }
    
    // Excluir plano na API
    async function deletePlanAPI(planId) {
        try {
            // Obter token de autentica√ß√£o
            const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
            const token = authData.token;
            
            if (!token) {
                console.error('Token de autentica√ß√£o n√£o encontrado.');
                return false;
            }
            
            // Verificar se o plano existe localmente
            const planExists = window.plans.some(p => p.id === planId);
            if (!planExists) {
                console.error(`Plano ID ${planId} n√£o encontrado localmente.`);
                return false;
            }
            
            console.log(`Tentando excluir plano ID: ${planId} na API...`);
            
            try {
                // Fazer requisi√ß√£o para API de planos
                const response = await fetch(`${window.API_URL}/plans/${planId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    console.log(`Plano ID: ${planId} exclu√≠do com sucesso na API.`);
                    return true;
                } else if (response.status === 404) {
                    // Caso 404 (Not Found), considerar como sucesso pois o plano n√£o existe no servidor
                    // Isso pode acontecer se o plano foi criado apenas localmente ou j√° foi exclu√≠do no servidor
                    console.log(`Plano ID: ${planId} n√£o encontrado na API (404). Considerando como exclu√≠do.`);
                    return true;
                } else {
                    console.error(`Erro ao excluir plano na API: ${response.status}`);
                    throw new Error(`Erro no servidor: ${response.status}`);
                }
            } catch (networkError) {
                console.error('Erro de rede ao tentar excluir plano:', networkError);
                
                // Se for erro de conex√£o, permitir exclus√£o local
                if (networkError.message.includes('Failed to fetch') || 
                    networkError.message.includes('NetworkError')) {
                    console.log('Erro de conex√£o. Permitindo exclus√£o local do plano.');
                    return true;
                }
                
                throw networkError;
            }
        } catch (error) {
            console.error('Erro ao excluir plano na API:', error);
            return false;
        }
    }

    // Inicializar a p√°gina carregando planos e configurando eventos
    async function initPlansPage() {
        console.log('------ DEBUGGING: Inicializando p√°gina de planos ------');
        
        try {
            // CR√çTICO: Verificar se window.plans existe no escopo global
            console.log('------ DEBUGGING: Estado de window.plans antes da verifica√ß√£o:', window.plans);
            
            // Certificar que window.plans seja inicializado como um array no escopo global
            if (typeof window.plans === 'undefined' || window.plans === null || !Array.isArray(window.plans)) {
                console.log('------ DEBUGGING: Inicializando window.plans como array vazio no escopo global');
                window.plans = [];
                
                // Tentar carregar do localStorage PRIMEIRO para evitar tela em branco
                try {
                    const storedPlansJson = localStorage.getItem('agendai_plans');
                    if (storedPlansJson) {
                        const storedPlans = JSON.parse(storedPlansJson);
                        if (Array.isArray(storedPlans) && storedPlans.length > 0) {
                            console.log(`------ DEBUGGING: [Global] Inicializando window.plans com ${storedPlans.length} planos do localStorage`);
                            window.plans = storedPlans;
                            // Renderizar planos imediatamente do localStorage
                            await refreshPlansUI();
                        }
                    }
                } catch (e) {
                    console.error('------ DEBUGGING: [Global] Erro ao processar planos do localStorage:', e);
                }
            }
            
            // Garantir que o usu√°rio esteja autenticado como admin
            const isAuthenticated = await ensureAdminLogin();
            console.log('------ DEBUGGING: Status de autentica√ß√£o:', isAuthenticated);
            
            // CR√çTICO: For√ßar carregamento da API, independentemente do que j√° exista no localStorage
            console.log('------ DEBUGGING: FOR√áANDO carregamento de planos da API...');
            try {
                const apiSuccess = await loadPlansFromAPI();
                console.log('------ DEBUGGING: Resultado do carregamento for√ßado da API:', apiSuccess);
                
                // Verificar window.plans ap√≥s carregamento da API
                console.log('------ DEBUGGING: window.plans ap√≥s carregamento da API:', 
                    Array.isArray(window.plans) ? window.plans.length : 'n√£o √© array');
                    
                // Garantir que os planos da API sejam salvos no localStorage
                if (Array.isArray(window.plans) && window.plans.length > 0) {
                    localStorage.setItem('agendai_plans', JSON.stringify(window.plans));
                    console.log('------ DEBUGGING: Planos salvos no localStorage ap√≥s carregamento for√ßado da API');
                }
                
                if (!apiSuccess) {
                    // Se o carregamento da API falhar, tentar novamente com uma nova tentativa de autentica√ß√£o
                    console.warn('------ DEBUGGING: Carregamento da API falhou, tentando reautenticar...');
                    localStorage.removeItem('agendai_auth');
                    const reauth = await ensureAdminLogin();
                    if (reauth) {
                        const retryApi = await loadPlansFromAPI();
                        console.log('------ DEBUGGING: Resultado da nova tentativa ap√≥s reautentica√ß√£o:', retryApi);
                    }
                }
            } catch (apiError) {
                console.error('------ DEBUGGING: Erro ao carregar planos da API:', apiError);
                // Em caso de erro, n√£o desista - tente usar o localStorage como fallback
                const storedPlansJson = localStorage.getItem('agendai_plans');
                if (storedPlansJson) {
                    try {
                        const storedPlans = JSON.parse(storedPlansJson);
                        if (Array.isArray(storedPlans) && storedPlans.length > 0) {
                            window.plans = storedPlans;
                            console.log(`------ DEBUGGING: Usando ${storedPlans.length} planos do localStorage como fallback ap√≥s erro na API`);
                            await refreshPlansUI();
                        }
                    } catch (e) {
                        console.error('------ DEBUGGING: Erro ao processar localStorage ap√≥s falha na API:', e);
                    }
                }
            }
            
            // Configurar atualiza√ß√µes autom√°ticas
            if (typeof window.plansUpdateInterval !== 'undefined') {
                clearInterval(window.plansUpdateInterval);
            }
            
            // Chamada inicial para sincronizar planos pendentes
            await syncPendingPlans();
            
            // Verificar se h√° algum plano no localStorage mas nenhum na API
            const hasApiPlans = Array.isArray(window.plans) && window.plans.length > 0 && !window.plans.some(p => p.storage_type);
            const hasStoredPlans = localStorage.getItem('agendai_plans') !== null;
            
            if (!hasApiPlans && hasStoredPlans) {
                console.log('------ DEBUGGING: Detectada situa√ß√£o onde h√° planos no localStorage mas n√£o temos dados confirmados da API');
                // For√ßar recarregamento dos planos da API
                const apiRefresh = await loadPlansFromAPI();
                console.log('------ DEBUGGING: Recarregamento for√ßado da API:', apiRefresh ? 'Sucesso' : 'Falha');
            }
            
            // CR√çTICO: Use um closure para garantir que o correto window.plans seja utilizado no setInterval
            const plansInterval = setInterval(async function() {
                console.log('------ DEBUGGING: Atualizando planos automaticamente...');
                await loadPlansFromAPI();
                
                // Tentar sincronizar planos pendentes
                await syncPendingPlans();
                
                // Verificar estado ap√≥s atualiza√ß√£o autom√°tica
                console.log('------ DEBUGGING: Estado ap√≥s atualiza√ß√£o autom√°tica, window.plans cont√©m:', 
                    Array.isArray(window.plans) ? window.plans.length : 'n√£o √© array', 'planos');
            }, 30000); // 30 segundos
            
            // Armazenar o interval no objeto window para poder limp√°-lo depois
            window.plansUpdateInterval = plansInterval;
            
            console.log('------ DEBUGGING: Atualiza√ß√£o autom√°tica de planos configurada');
            
            // Configurar todos os event listeners
            setupEventListeners();
            
            // Verifica√ß√£o final do estado de window.plans
            console.log('------ DEBUGGING: Verifica√ß√£o final: window.plans cont√©m', 
                Array.isArray(window.plans) ? window.plans.length : 'n√£o √© array', 'planos');
            console.log('------ DEBUGGING: localStorage cont√©m', 
                localStorage.getItem('agendai_plans') ? JSON.parse(localStorage.getItem('agendai_plans')).length : 0, 'planos');
            
            console.log('------ DEBUGGING: Inicializa√ß√£o da p√°gina de planos conclu√≠da');
        } catch (error) {
            console.error('------ DEBUGGING: Erro durante inicializa√ß√£o da p√°gina de planos:', error);
            // Tentar recupera√ß√£o para garantir que algo seja mostrado
            try {
                // √öltima tentativa - verificar o localStorage
                const lastResort = localStorage.getItem('agendai_plans');
                if (lastResort) {
                    try {
                        window.plans = JSON.parse(lastResort);
                        if (Array.isArray(window.plans) && window.plans.length > 0) {
                            console.log('------ DEBUGGING: Recupera√ß√£o de emerg√™ncia com', window.plans.length, 'planos do localStorage');
                            await refreshPlansUI();
                        }
                    } catch (e) {
                        console.error('------ DEBUGGING: Falha na recupera√ß√£o de emerg√™ncia:', e);
                        window.plans = window.plans || [];
                        await refreshPlansUI();
                    }
                } else {
                    window.plans = window.plans || [];
                    await refreshPlansUI();
                }
            } catch (finalError) {
                console.error('------ DEBUGGING: Falha completa na recupera√ß√£o:', finalError);
                // Em √∫ltimo caso, mostrar algo na interface
                window.plans = [];
                await refreshPlansUI();
            }
        }
    }

    // Configurar escutadores de eventos
    function setupEventListeners() {
        console.log('------ DEBUGGING: Configurando event listeners para bot√µes...');
        
        try {
            // N√£o precisamos mais configurar os bot√µes de exclus√£o aqui, pois estamos usando onclick

            // Configurar bot√µes de edi√ß√£o na tabela
            const editButtons = document.querySelectorAll('.edit-plan');
            console.log(`------ DEBUGGING: Encontrados ${editButtons.length} bot√µes de edi√ß√£o`);
            
            editButtons.forEach(btn => {
                const planId = btn.getAttribute('data-id');
                console.log(`------ DEBUGGING: Configurando bot√£o de edi√ß√£o para o plano ID: ${planId}`);
                
                // Garantir que o onclick esteja definido
                btn.onclick = function() {
                    console.log(`------ DEBUGGING: Bot√£o de edi√ß√£o clicado para o plano ID: ${planId}`);
                    editPlan(parseInt(planId));
                };
            });
            
            // Configurar bot√£o de salvar no modal de novo plano
            const savePlanBtn = document.getElementById('savePlanBtn');
            if (savePlanBtn) {
                savePlanBtn.removeEventListener('click', savePlan);
                savePlanBtn.addEventListener('click', savePlan);
                console.log('------ DEBUGGING: Event listener configurado para savePlanBtn');
            } else {
                console.warn('------ DEBUGGING: Bot√£o savePlanBtn n√£o encontrado');
            }
            
            // O bot√£o updatePlanBtn s√≥ vai existir quando o modal de edi√ß√£o estiver aberto
            // N√£o precisamos configur√°-lo aqui, pois ele ser√° configurado ao abrir o modal
            
            // Configurar bot√£o de novo plano
            const newPlanBtn = document.getElementById('newPlanBtn');
            if (newPlanBtn) {
                newPlanBtn.onclick = openAddPlanModalManually;
                console.log('------ DEBUGGING: Event listener configurado para newPlanBtn');
            } else {
                console.warn('------ DEBUGGING: Bot√£o newPlanBtn n√£o encontrado');
            }
            
            console.log('------ DEBUGGING: Event listeners configurados com sucesso!');
        } catch (error) {
            console.error('------ DEBUGGING: Erro ao configurar event listeners:', error);
        }
    }

    // Executar quando o DOM estiver totalmente carregado
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('------ DEBUGGING: DOM carregado, iniciando aplica√ß√£o...');
        
        try {
            // CR√çTICO: Garantir que window.plans exista
            window.ensureWindowPlansExists();

            // Verificar se j√° temos planos carregados do localStorage durante inicializa√ß√£o
            if (Array.isArray(window.plans) && window.plans.length > 0) {
                console.log(`------ DEBUGGING: Na inicializa√ß√£o do DOM, j√° temos ${window.plans.length} planos carregados. Atualizando UI...`);
                // Atualizar UI com planos j√° carregados para exibi√ß√£o imediata
                try {
                    await refreshPlansUI();
                } catch (e) {
                    console.error('------ DEBUGGING: Erro ao atualizar UI com planos iniciais:', e);
                }
            }
            
            // Debug do Bootstrap
            debugBootstrap();
            
            // Configurar bot√£o de cancelar do modal manualmente
            const cancelPlanBtn = document.getElementById('cancelPlanBtn');
            if (cancelPlanBtn) {
                cancelPlanBtn.addEventListener('click', function() {
                    console.log('------ DEBUGGING: Bot√£o Cancelar clicado, fechando modal manualmente...');
                    const modal = document.getElementById('addPlanModal');
                    if (modal) {
                        closeModalManually(modal);
                    }
                });
            }
            
            // Tentar carregar Bootstrap diretamente se n√£o estiver dispon√≠vel
            if (typeof bootstrap === 'undefined') {
                console.log('------ DEBUGGING: Bootstrap n√£o detectado, carregando dinamicamente...');
                
                // Carregar o Bootstrap CSS se necess√°rio
                if (!document.querySelector('link[href*="bootstrap"]')) {
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = 'https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css';
                    document.head.appendChild(link);
                }
                
                // Carregar o Bootstrap JS
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js';
                script.onload = function() {
                    console.log('------ DEBUGGING: Bootstrap carregado com sucesso!');
                    // Debugar novamente ap√≥s carregar
                    setTimeout(debugBootstrap, 500);
                    // Inicializar a p√°gina ap√≥s o carregamento do Bootstrap
                    initPlansPage();
                };
                document.body.appendChild(script);
            } else {
                console.log('------ DEBUGGING: Bootstrap j√° est√° dispon√≠vel, iniciando p√°gina...');
                // Inicializa√ß√£o da p√°gina - IMPORTANTE
                await initPlansPage();
            }
        } catch (error) {
            console.error('------ DEBUGGING: Erro durante inicializa√ß√£o:', error);
            alert('Ocorreu um erro ao inicializar a p√°gina. Por favor, recarregue ou contate o suporte.');
        }
    });

    // Fun√ß√£o para debugar estado do Bootstrap
    function debugBootstrap() {
        console.log('--------- DEBUG DO BOOTSTRAP ---------');
        console.log('bootstrap global existe:', typeof bootstrap !== 'undefined');
        
        if (typeof bootstrap !== 'undefined') {
            console.log('bootstrap.Modal existe:', typeof bootstrap.Modal !== 'undefined');
            
            if (typeof bootstrap.Modal !== 'undefined') {
                console.log('bootstrap.Modal.getInstance existe:', typeof bootstrap.Modal.getInstance === 'function');
            }
        }
        
        console.log('jQuery existe:', typeof $ !== 'undefined');
        
        // Verificar se os scripts do Bootstrap est√£o carregados
        const scripts = Array.from(document.querySelectorAll('script')).map(s => s.src);
        console.log('Scripts carregados:', scripts);
        
        // Verificar se os estilos do Bootstrap est√£o carregados
        const styles = Array.from(document.querySelectorAll('link')).map(l => l.href);
        console.log('Estilos carregados:', styles);
        
        console.log('------------------------------------');
    }

    // Abrir o modal manualmente sem depender do Bootstrap
    function openAddPlanModalManually() {
        console.log('Abrindo modal manualmente...');
        
        // Obter o modal
        let modal = document.getElementById('addPlanModal');
        
        // Se o modal n√£o existir, vamos cri√°-lo dinamicamente
        if (!modal) {
            console.log('Modal n√£o encontrado! Criando dinamicamente...');
            
            // Template HTML do modal
            const modalHTML = `
            <div class="modal fade" id="addPlanModal" tabindex="-1" aria-labelledby="addPlanModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="addPlanModalLabel">Novo Plano</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="planForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="planName" class="form-label">Nome do Plano*</label>
                                        <input type="text" class="form-control" id="planName" value="Novo Plano" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="planPrice" class="form-label">Pre√ßo (R$)*</label>
                                        <input type="number" class="form-control" id="planPrice" step="0.01" min="0" value="50.00" required>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="planAppointments" class="form-label">Limite de Agendamentos*</label>
                                        <input type="number" class="form-control" id="planAppointments" value="50" min="0" required>
                                        <div class="form-text">0 para ilimitado</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="planProfessionals" class="form-label">Limite de Profissionais*</label>
                                        <input type="number" class="form-control" id="planProfessionals" value="2" min="0" required>
                                        <div class="form-text">0 para ilimitado</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="planServices" class="form-label">Limite de Servi√ßos*</label>
                                        <input type="number" class="form-control" id="planServices" value="10" min="0" required>
                                        <div class="form-text">0 para ilimitado</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="planStatus" class="form-label">Status*</label>
                                        <select class="form-select" id="planStatus" required>
                                            <option value="active" selected>Ativo</option>
                                            <option value="inactive">Inativo</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="planHighlight" class="form-label">Destaque*</label>
                                        <select class="form-select" id="planHighlight" required>
                                            <option value="none" selected>Sem Destaque</option>
                                            <option value="popular">Popular</option>
                                            <option value="recommended">Recomendado</option>
                                            <option value="best-value">Melhor Custo-Benef√≠cio</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="planDescription" class="form-label">Descri√ß√£o</label>
                                    <textarea class="form-control" id="planDescription" rows="3"></textarea>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label">Recursos Inclu√≠dos</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="featureReports">
                                                <label class="form-check-label" for="featureReports">Relat√≥rios Avan√ßados</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="featureEmailNotifications" checked>
                                                <label class="form-check-label" for="featureEmailNotifications">Notifica√ß√µes por Email</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="featureSmsNotifications">
                                                <label class="form-check-label" for="featureSmsNotifications">Notifica√ß√µes por SMS</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="featureWhatsAppNotifications">
                                                <label class="form-check-label" for="featureWhatsAppNotifications">Notifica√ß√µes por WhatsApp</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="featureCustomization">
                                                <label class="form-check-label" for="featureCustomization">Personaliza√ß√£o Avan√ßada</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="featureAPI">
                                                <label class="form-check-label" for="featureAPI">Acesso √† API</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancelPlanBtn">Cancelar</button>
                            <button type="button" class="btn btn-primary" id="savePlanBtn" onclick="createNewPlan()">Salvar</button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            // Adicionar o modal ao DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Aguardar um momento para garantir que o DOM foi atualizado
            setTimeout(function() {
                // Obter refer√™ncia ao modal rec√©m-criado
                modal = document.getElementById('addPlanModal');
                console.log('Modal criado dinamicamente com sucesso!');
                
                // Adicionar eventos aos bot√µes
                const cancelBtn = modal.querySelector('#cancelPlanBtn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        closeModalManually(modal);
                    });
                }
                
                // Mostrar o modal com um pequeno atraso para garantir que tudo est√° pronto
                setTimeout(function() {
                    showModalSafely(modal);
                }, 50);
            }, 50);
        } else {
            // Resetar o formul√°rio se existir
            const form = modal.querySelector('form');
            if (form) {
                try {
                    form.reset();
                } catch (e) {
                    console.warn('Erro ao resetar formul√°rio:', e);
                }
            }
            
            // Mostrar o modal com um pequeno atraso
            setTimeout(function() {
                showModalSafely(modal);
            }, 50);
        }
    }
    
    // Fun√ß√£o auxiliar para mostrar o modal de forma segura
    function showModalSafely(modal) {
        try {
            console.log('Mostrando modal com m√©todo seguro...');
            
            // Primeiro tente usar Bootstrap
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                try {
                    let bsModal = bootstrap.Modal.getInstance(modal);
                    if (!bsModal) {
                        bsModal = new bootstrap.Modal(modal);
                    }
                    bsModal.show();
                    console.log('Modal aberto com sucesso usando Bootstrap');
                    return;
                } catch (e) {
                    console.warn('Erro ao usar Bootstrap.Modal:', e);
                }
            }
            
            // M√©todo alternativo direto se Bootstrap falhar
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.classList.add('modal-open');
            
            // Adicionar backdrop manualmente
            if (!document.querySelector('.modal-backdrop')) {
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
            }
            
            console.log('Modal aberto manualmente com m√©todo direto');
            
            // Garantir que os bot√µes de fechamento funcionem
            const closeButtons = modal.querySelectorAll('[data-bs-dismiss="modal"], #cancelEditBtn');
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    closeModalManually(modal);
                });
            });
        } catch (e) {
            console.error('Erro ao abrir modal:', e);
            alert('N√£o foi poss√≠vel abrir o formul√°rio. Por favor, tente novamente ou recarregue a p√°gina.');
        }
    }
    
    // Fun√ß√£o para fechar o modal manualmente de forma segura
    function closeModalManually(modal) {
        console.log('Fechando modal manualmente com m√©todo seguro');
        
        if (!modal) {
            modal = document.getElementById('addPlanModal') || document.getElementById('editPlanModal');
            if (!modal) return;
        }
        
        // Tentar primeiro usar Bootstrap se dispon√≠vel
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            try {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                    console.log('Modal fechado com Bootstrap');
                    return;
                }
            } catch (e) {
                console.warn('Erro ao usar Bootstrap para fechar modal:', e);
            }
        }
        
        // Tentar usar jQuery se dispon√≠vel
        if (typeof $ !== 'undefined') {
            try {
                $(modal).modal('hide');
                console.log('Modal fechado com jQuery');
                return;
            } catch (e) {
                console.warn('Erro ao usar jQuery para fechar modal:', e);
            }
        }
        
        // M√©todo direto sem depender do Bootstrap ou jQuery
        try {
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
            
            // Remover backdrop
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) backdrop.remove();
            
            console.log('Modal fechado com m√©todo direto');
        } catch (e) {
            console.error('Erro ao fechar modal com m√©todo direto:', e);
        }
        
        // Garantir que o bot√£o Novo Plano permane√ßa vis√≠vel
        setTimeout(function() {
            const newPlanBtn = document.getElementById('newPlanBtn');
            if (!newPlanBtn) {
                console.warn('Bot√£o de Novo Plano n√£o encontrado ap√≥s fechar modal, recriando...');
                const headerRow = document.getElementById('headerRow');
                if (headerRow) {
                    const btnContainer = headerRow.querySelector('.col-md-4.text-md-end');
                    if (btnContainer) {
                        btnContainer.innerHTML = `
                            <button type="button" class="btn btn-primary" id="newPlanBtn" onclick="openAddPlanModalManually()">
                                <i class="fas fa-plus me-1"></i> Novo Plano
                            </button>
                        `;
                    }
                }
            }
        }, 100);
    }

    // Obter o r√≥tulo de destaque com base no valor
    function getHighlightLabel(highlight) {
        switch (highlight) {
            case 'popular':
                return 'Popular';
            case 'recommended':
                return 'Recomendado';
            case 'best-value':
                return 'Melhor Custo-Benef√≠cio';
            default:
                return '';
        }
    }

    // Salvar novo plano
    async function savePlan() {
        console.log('Fun√ß√£o savePlan chamada');
        
        // CR√çTICO: Garantir que window.plans exista
        window.ensureWindowPlansExists();
        
        // Mostrar indicador de carregamento no bot√£o
        const saveBtn = document.getElementById('savePlanBtn');
        if (saveBtn) {
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            saveBtn.disabled = true;
        }
        
        try {
            // Coletar dados do formul√°rio
            const name = document.getElementById('planName')?.value || 'Novo Plano';
            const price = parseFloat(document.getElementById('planPrice')?.value || '50');
            const appointments = parseInt(document.getElementById('planAppointments')?.value || '50');
            const professionals = parseInt(document.getElementById('planProfessionals')?.value || '2');
            const services = parseInt(document.getElementById('planServices')?.value || '10');
            const status = document.getElementById('planStatus')?.value || 'active';
            const highlight = document.getElementById('planHighlight')?.value || 'none';
            const description = document.getElementById('planDescription')?.value || '';
            
            // Recursos/features
            const reports = document.getElementById('featureReports')?.checked || false;
            const emailNotifications = document.getElementById('featureEmailNotifications')?.checked || false;
            const smsNotifications = document.getElementById('featureSmsNotifications')?.checked || false;
            const whatsAppNotifications = document.getElementById('featureWhatsAppNotifications')?.checked || false;
            const customization = document.getElementById('featureCustomization')?.checked || false;
            const api = document.getElementById('featureAPI')?.checked || false;
            
            // Criar o objeto do plano
            const planData = {
                name: name,
                price: price,
                appointments: appointments,
                professionals: professionals,
                services: services,
                status: status,
                highlight: highlight,
                description: description,
                features: {
                    reports: reports,
                    emailNotifications: emailNotifications,
                    smsNotifications: smsNotifications,
                    whatsAppNotifications: whatsAppNotifications,
                    customization: customization,
                    api: api
                }
            };
            
            console.log('Dados do novo plano:', planData);
            
            // Verificar autentica√ß√£o antes de salvar
            const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
            if (!authData.token) {
                console.warn('Token de autentica√ß√£o n√£o encontrado, tentando login autom√°tico...');
                const loginSuccess = await ensureAdminLogin();
                if (!loginSuccess) {
                    throw new Error('N√£o foi poss√≠vel autenticar automaticamente. Por favor, fa√ßa login manualmente.');
                }
                console.log('Login autom√°tico realizado com sucesso, continuando com o salvamento do plano');
            }
            
            // Salvar no backend via API ou localStorage
            const newPlan = await createPlanAPI(planData);
            
            if (!newPlan) {
                throw new Error('N√£o foi poss√≠vel criar o plano');
            }
            
            // Verificar se o plano foi salvo localmente ou na API
            if (newPlan.storage_type === 'local') {
                console.log('Plano criado no localStorage:', newPlan);
            } else {
                console.log('Plano criado com sucesso na API:', newPlan);
            }
            
            // A fun√ß√£o createPlanAPI j√° adicionou o plano ao array window.plans
            // e salvou no localStorage, n√£o precisamos fazer isso novamente
            
            // Fechar o modal com m√©todo seguro
            const modal = document.getElementById('addPlanModal');
            if (modal) {
                closeModalManually(modal);
            }
            
            // Atualizar a interface do usu√°rio (ap√≥s fechar o modal)
            setTimeout(function() {
                refreshPlansUI();
                
                // Verificar se o bot√£o "Novo Plano" ainda est√° dispon√≠vel
                const newPlanBtn = document.getElementById('newPlanBtn');
                if (!newPlanBtn) {
                    console.warn('Bot√£o "Novo Plano" n√£o encontrado ap√≥s atualiza√ß√£o, recriando...');
                    const headerRow = document.getElementById('headerRow');
                    if (headerRow) {
                        const btnContainer = headerRow.querySelector('.col-md-4.text-md-end');
                        if (btnContainer) {
                            btnContainer.innerHTML = `
                                <button type="button" class="btn btn-primary" id="newPlanBtn" onclick="openAddPlanModalManually()">
                                    <i class="fas fa-plus me-1"></i> Novo Plano
                                </button>
                            `;
                        }
                    }
                }
                
                // Mostrar mensagem de sucesso
                if (newPlan.storage_type === 'local') {
                    alert('Plano adicionado com sucesso no armazenamento local (modo offline)!');
                } else {
                    alert('Plano adicionado com sucesso!');
                }
            }, 100);
            
        } catch (error) {
            console.error('Erro ao salvar plano:', error);
            
            // Tratar erro espec√≠fico de autentica√ß√£o
            if (error.message && error.message.includes('autentica√ß√£o')) {
                alert('Erro de autentica√ß√£o: ' + error.message);
                
                // Tentar autenticar novamente
                const loginAgain = confirm('Deseja tentar fazer login novamente?');
                if (loginAgain) {
                    localStorage.removeItem('agendai_auth');
                    await ensureAdminLogin();
                    alert('Login realizado. Por favor, tente salvar o plano novamente.');
                }
            } else if (error.message && error.message.includes('Failed to fetch')) {
                // Erro de conex√£o - oferecer salvamento offline
                alert('Erro de conex√£o com o servidor. Deseja salvar o plano no modo offline?');
                // O salvamento offline j√° acontece automaticamente na fun√ß√£o createPlanAPI
            } else {
                // Exibir mensagem gen√©rica para outros erros
                alert('Erro ao salvar o plano: ' + error.message);
            }
        } finally {
            // Restaurar bot√£o para estado normal
            if (saveBtn) {
                saveBtn.innerHTML = 'Salvar';
                saveBtn.disabled = false;
            }
        }
    }
    
    // Atualizar a interface ap√≥s mudan√ßas nos planos
    async function refreshPlansUI() {
        console.log('------ DEBUGGING: In√≠cio da fun√ß√£o refreshPlansUI ------');
        
        // CR√çTICO: Garantir que window.plans exista antes de atualizar a UI
        window.ensureWindowPlansExists();
        
        try {
            // Verificar se window.plans existe e √© um array
            if (!Array.isArray(window.plans)) {
                console.error('------ DEBUGGING: window.plans n√£o √© um array em refreshPlansUI!');
                window.plans = [];
            }
            
            console.log(`------ DEBUGGING: Atualizando UI com ${window.plans.length} planos`);
            
            // Normalizar todos os planos para garantir que as features existam e sejam booleanos
            const normalizedPlans = window.plans.map(plan => {
                // Criar uma c√≥pia para n√£o modificar o original
                const normalizedPlan = { ...plan };
                
                // Garantir que features exista
                if (!normalizedPlan.features) {
                    normalizedPlan.features = {};
                }
                
                // Se features √© uma string, tentar converter para objeto
                if (typeof normalizedPlan.features === 'string') {
                    try {
                        normalizedPlan.features = JSON.parse(normalizedPlan.features);
                    } catch (e) {
                        console.error(`------ DEBUGGING: Erro ao parsear features do plano ${normalizedPlan.id}:`, e);
                        normalizedPlan.features = {};
                    }
                }
                
                // Garantir que features seja um objeto
                if (typeof normalizedPlan.features !== 'object' || normalizedPlan.features === null) {
                    normalizedPlan.features = {};
                }
                
                // Converter explicitamente cada propriedade para booleano
                normalizedPlan.features = {
                    reports: !!normalizedPlan.features.reports,
                    emailNotifications: normalizedPlan.features.emailNotifications === undefined ? true : !!normalizedPlan.features.emailNotifications,
                    smsNotifications: !!normalizedPlan.features.smsNotifications,
                    whatsAppNotifications: !!normalizedPlan.features.whatsAppNotifications,
                    customization: !!normalizedPlan.features.customization,
                    api: !!normalizedPlan.features.api
                };
                
                console.log(`------ DEBUGGING: Plano normalizado ID=${normalizedPlan.id}, reports=${normalizedPlan.features.reports}`);
                
                return normalizedPlan;
            });
            
            // Atualizar tabela de planos
            const plansTable = document.querySelector('#plansTable tbody');
            if (plansTable) {
                // Limpar tabela
                plansTable.innerHTML = '';
                
                if (normalizedPlans.length === 0) {
                    // Adicionar mensagem de nenhum plano
                    const emptyRow = `
                    <tr>
                        <td colspan="8" class="text-center py-3">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Nenhum plano cadastrado. Clique em "Novo Plano" para adicionar.
                            </div>
                        </td>
                    </tr>
                    `;
                    plansTable.innerHTML = emptyRow;
                } else {
                    // Adicionar cada plano
                    normalizedPlans.forEach(plan => {
                        // Formata√ß√£o dos valores
                        const price = typeof plan.price === 'number' ? plan.price.toFixed(2) : 
                                    (typeof plan.price === 'string' ? parseFloat(plan.price).toFixed(2) : '0.00');
                        const appointmentsText = plan.appointments === 0 ? 'Ilimitado' : plan.appointments;
                        const professionalsText = plan.professionals === 0 ? 'Ilimitado' : plan.professionals;
                        const servicesText = plan.services === 0 ? 'Ilimitado' : plan.services;
                        const statusClass = plan.status === 'active' ? 'bg-success' : 'bg-danger';
                        const statusText = plan.status === 'active' ? 'Ativo' : 'Inativo';
                        
                        // Criar HTML da linha
                        const rowHTML = `
                        <tr>
                            <td>${plan.id}</td>
                            <td>${plan.name}</td>
                            <td>R$ ${price}</td>
                            <td>${appointmentsText}</td>
                            <td>${professionalsText}</td>
                            <td>${servicesText}</td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary edit-plan me-1" data-id="${plan.id}" onclick="editPlan(${plan.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-plan" data-id="${plan.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>`;
                        
                        plansTable.innerHTML += rowHTML;
                    });
                }
                console.log('------ DEBUGGING: Tabela de planos atualizada');
            } else {
                console.error('------ DEBUGGING: Tabela de planos n√£o encontrada!');
            }
            
            // Atualizar cards de planos
            const headerRow = document.querySelector('.row.mb-4#headerRow');
            if (headerRow) {
                let cardsContainer = headerRow.nextElementSibling;
                if (!cardsContainer || !cardsContainer.classList.contains('row')) {
                    console.log('------ DEBUGGING: Container de cards n√£o encontrado, criando novo');
                    cardsContainer = document.createElement('div');
                    cardsContainer.className = 'row mb-4';
                    headerRow.parentNode.insertBefore(cardsContainer, headerRow.nextSibling);
                }
                
                // Limpar container
                cardsContainer.innerHTML = '';
                
                // Filtrar apenas planos ativos para mostrar nos cards
                const activePlans = normalizedPlans.filter(plan => plan.status === 'active');
                
                if (activePlans.length === 0) {
                    // Adicionar mensagem de nenhum plano ativo
                    const emptyCardHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Nenhum plano ativo para exibi√ß√£o. Ative um plano para que ele apare√ßa aqui.
                        </div>
                    </div>`;
                    cardsContainer.innerHTML = emptyCardHTML;
                } else {
                    // Adicionar cada plano ativo
                    activePlans.forEach(plan => {
                        // Formata√ß√£o dos valores
                        const price = typeof plan.price === 'number' ? plan.price.toFixed(2) : 
                                     (typeof plan.price === 'string' ? parseFloat(plan.price).toFixed(2) : '0.00');
                        const appointmentsText = plan.appointments === 0 ? 'Ilimitados' : plan.appointments;
                        const professionalsText = plan.professionals === 0 ? 'Ilimitados' : plan.professionals;
                        const servicesText = plan.services === 0 ? 'Ilimitados' : plan.services;
                        
                        // Garantir que features seja um objeto v√°lido e com valores booleanos
                        const features = plan.features || {};
                        
                        // Log para debug das features
                        console.log(`------ DEBUGGING: Card do plano ID=${plan.id}, nome=${plan.name}, reports=${features.reports}`);
                        
                        function getHighlightLabel(highlight) {
                            switch (highlight) {
                                case 'popular': return 'Popular';
                                case 'recommended': return 'Recomendado';
                                case 'best-value': return 'Melhor Custo-Benef√≠cio';
                                default: return '';
                            }
                        }
                        
                        // Criar HTML do card
                        const cardHTML = `
                        <div class="col-md-4 mb-4">
                            <div class="card shadow h-100 ${plan.highlight !== 'none' ? 'border-primary' : ''}">
                                <div class="card-header py-3 bg-primary text-white">
                                    <h6 class="m-0 font-weight-bold">${plan.name}</h6>
                                    ${plan.highlight !== 'none' ? `
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark">
                                        ${getHighlightLabel(plan.highlight)}
                                    </span>` : ''}
                                </div>
                                <div class="card-body">
                                    <div class="text-center mb-4">
                                        <h2 class="card-price text-primary">R$ ${price}<span class="period">/m√™s</span></h2>
                                    </div>
                                    <ul class="list-group list-group-flush mb-4">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Agendamentos
                                            <span class="badge bg-primary rounded-pill">${appointmentsText}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Profissionais
                                            <span class="badge bg-primary rounded-pill">${professionalsText}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Servi√ßos
                                            <span class="badge bg-primary rounded-pill">${servicesText}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Relat√≥rios
                                            <span class="badge ${features.reports ? 'bg-success' : 'bg-danger'} rounded-pill">
                                                ${features.reports ? 'Sim' : 'N√£o'}
                                            </span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Notifica√ß√µes
                                            <span class="badge ${(features.emailNotifications || features.smsNotifications || features.whatsAppNotifications) ? 'bg-success' : 'bg-danger'} rounded-pill">
                                                ${(features.emailNotifications || features.smsNotifications || features.whatsAppNotifications) ? 'Sim' : 'N√£o'}
                                            </span>
                                        </li>
                                    </ul>
                                    <div class="d-grid">
                                        <button class="btn btn-outline-primary" onclick="editPlan(${plan.id})">
                                            <i class="fas fa-edit me-1"></i> Editar Plano
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                        
                        cardsContainer.innerHTML += cardHTML;
                    });
                }
                console.log('------ DEBUGGING: Cards de planos atualizados');
            } else {
                console.error('------ DEBUGGING: Header row n√£o encontrado para adicionar cards');
            }
            
            // Debug dados salvos no localStorage
            try {
                const storedPlansJson = localStorage.getItem('agendai_plans');
                if (storedPlansJson) {
                    const storedPlans = JSON.parse(storedPlansJson);
                    if (Array.isArray(storedPlans)) {
                        console.log(`------ DEBUGGING: localStorage cont√©m ${storedPlans.length} planos ap√≥s UI refresh`);
                        
                        // Tamb√©m atualizar o localStorage com as features normalizadas para evitar problemas futuros
                        localStorage.setItem('agendai_plans', JSON.stringify(normalizedPlans));
                        console.log('------ DEBUGGING: localStorage atualizado com planos normalizados');
                    }
                }
            } catch (localStorageError) {
                console.error('------ DEBUGGING: Erro ao verificar localStorage ap√≥s UI refresh:', localStorageError);
            }
            
            // Configurar listeners para os bot√µes de exclus√£o
            try {
                const deleteButtons = document.querySelectorAll('.delete-plan');
                console.log(`------ DEBUGGING: Encontrados ${deleteButtons.length} bot√µes de exclus√£o para configurar`);
                
                deleteButtons.forEach(btn => {
                    const planId = btn.getAttribute('data-id');
                    if (planId) {
                        // Garantir que o onclick esteja definido
                        btn.onclick = function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            console.log(`Bot√£o de exclus√£o clicado para o plano ID: ${planId}`);
                            window.confirmDeletePlan(parseInt(planId));
                            return false;
                        };
                    }
                });
            } catch (buttonError) {
                console.error('------ DEBUGGING: Erro ao configurar bot√µes de exclus√£o:', buttonError);
            }
            
            // IMPORTANTE: Atualizar window.plans com os planos normalizados para manter consist√™ncia
            window.plans = normalizedPlans;
            
            console.log('------ DEBUGGING: UI atualizada com sucesso');
            return true;
        } catch (error) {
            console.error('------ DEBUGGING: Erro ao atualizar UI:', error);
            
            // Tentar uma abordagem mais simples se a atualiza√ß√£o falhar
            try {
                const plansTable = document.querySelector('#plansTable tbody');
                if (plansTable && Array.isArray(window.plans)) {
                    plansTable.innerHTML = ''; // Limpar tabela
                    
                    // Adicionar mensagem de erro
                    const errorRow = `
                    <tr>
                        <td colspan="8" class="text-center py-3">
                            <div class="alert alert-danger mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Erro ao atualizar a interface. Tente recarregar a p√°gina.
                            </div>
                        </td>
                    </tr>`;
                    plansTable.innerHTML = errorRow;
                    
                    console.log('------ DEBUGGING: Adicionada mensagem de erro na UI');
                }
            } catch (secondaryError) {
                console.error('------ DEBUGGING: Erro secund√°rio ao tentar exibir mensagem de erro:', secondaryError);
            }
            
            return false;
        }
    }
    
    // Atualizar cards de planos
    async function updatePlanCards() {
        console.log('------ DEBUGGING: Atualizando cards de planos');
        
        const headerRow = document.querySelector('.row.mb-4#headerRow');
        if (!headerRow) {
            console.error('------ DEBUGGING: Container de header n√£o encontrado');
            return;
        }
        
        // Encontrar ou criar o container para os cards
        let cardsContainer = headerRow.nextElementSibling;
        if (!cardsContainer || !cardsContainer.classList.contains('row')) {
            console.log('------ DEBUGGING: Container de cards n√£o encontrado, criando novo');
            cardsContainer = document.createElement('div');
            cardsContainer.className = 'row mb-4';
            headerRow.parentNode.insertBefore(cardsContainer, headerRow.nextSibling);
        }
        
        // Limpar container
        cardsContainer.innerHTML = '';
        
        // Se n√£o houver planos, mostrar mensagem
        if (!window.plans || window.plans.length === 0) {
            cardsContainer.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i> Nenhum plano cadastrado. Clique em "Novo Plano" para adicionar.
                    </div>
                </div>
            `;
            console.log('------ DEBUGGING: Nenhum plano para mostrar nos cards');
            return;
        }
        
        console.log(`------ DEBUGGING: Criando ${window.plans.length} cards de planos`);
        
        // Adicionar cada plano
        window.plans.forEach(plan => {
            if (plan.status !== 'active') return;
            
            // Formata√ß√£o dos valores
            const price = typeof plan.price === 'number' ? plan.price.toFixed(2) : 
                         (typeof plan.price === 'string' ? parseFloat(plan.price).toFixed(2) : '0.00');
            const appointmentsText = plan.appointments === 0 ? 'Ilimitados' : plan.appointments;
            const professionalsText = plan.professionals === 0 ? 'Ilimitados' : plan.professionals;
            const servicesText = plan.services === 0 ? 'Ilimitados' : plan.services;
            
            // Verificar se features est√° definido e √© um objeto
            const features = plan.features || {};
            
            // Criar HTML do card
            const cardHTML = `
            <div class="col-md-4 mb-4">
                <div class="card shadow h-100 ${plan.highlight !== 'none' ? 'border-primary' : ''}">
                    <div class="card-header py-3 bg-primary text-white">
                        <h6 class="m-0 font-weight-bold">${plan.name}</h6>
                        ${plan.highlight !== 'none' ? `
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark">
                            ${getHighlightLabel(plan.highlight)}
                        </span>` : ''}
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <h2 class="card-price text-primary">R$ ${price}<span class="period">/m√™s</span></h2>
                        </div>
                        <ul class="list-group list-group-flush mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Agendamentos
                                <span class="badge bg-primary rounded-pill">${appointmentsText}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Profissionais
                                <span class="badge bg-primary rounded-pill">${professionalsText}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Servi√ßos
                                <span class="badge bg-primary rounded-pill">${servicesText}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Relat√≥rios
                                <span class="badge ${features.reports ? 'bg-success' : 'bg-danger'} rounded-pill">
                                    ${features.reports ? 'Sim' : 'N√£o'}
                                </span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Notifica√ß√µes
                                <span class="badge bg-success rounded-pill">Sim</span>
                            </li>
                        </ul>
                        <div class="d-grid">
                            <button class="btn btn-outline-primary" onclick="editPlan(${plan.id})">
                                <i class="fas fa-edit me-1"></i> Editar Plano
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            cardsContainer.innerHTML += cardHTML;
        });
        
        console.log('------ DEBUGGING: Cards de planos atualizados com sucesso');
    }
    
    // Atualizar a tabela de planos
    async function updatePlanTable() {
        console.log('------ DEBUGGING: Atualizando tabela de planos');
        
        const tableBody = document.querySelector('#plansTable tbody');
        if (!tableBody) {
            console.error('------ DEBUGGING: Tabela de planos n√£o encontrada');
            return;
        }
        
        // Limpar tabela
        tableBody.innerHTML = '';
        
        // Se n√£o houver planos, mostrar mensagem
        if (!window.plans || window.plans.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="alert alert-info mb-0" role="alert">
                            <i class="fas fa-info-circle me-2"></i> Nenhum plano cadastrado.
                        </div>
                    </td>
                </tr>
            `;
            console.log('------ DEBUGGING: Nenhum plano para mostrar na tabela');
            return;
        }
        
        console.log(`------ DEBUGGING: Inserindo ${window.plans.length} planos na tabela`);
        
        // Adicionar cada plano
        window.plans.forEach(plan => {
            // Formata√ß√£o dos valores
            const price = typeof plan.price === 'number' ? plan.price.toFixed(2) : 
                         (typeof plan.price === 'string' ? parseFloat(plan.price).toFixed(2) : '0.00');
            const appointmentsText = plan.appointments === 0 ? 'Ilimitado' : plan.appointments;
            const professionalsText = plan.professionals === 0 ? 'Ilimitado' : plan.professionals;
            const servicesText = plan.services === 0 ? 'Ilimitado' : plan.services;
            const statusClass = plan.status === 'active' ? 'bg-success' : 'bg-danger';
            const statusText = plan.status === 'active' ? 'Ativo' : 'Inativo';
            
            // Criar HTML da linha
            const rowHTML = `
            <tr>
                <td>${plan.id}</td>
                <td>${plan.name}</td>
                <td>R$ ${price}</td>
                <td>${appointmentsText}</td>
                <td>${professionalsText}</td>
                <td>${servicesText}</td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="btn btn-sm btn-primary edit-plan me-1" data-id="${plan.id}" onclick="editPlan(${plan.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-plan" data-id="${plan.id}" onclick="confirmDeletePlan(${plan.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
            
            tableBody.innerHTML += rowHTML;
        });
        
        console.log('------ DEBUGGING: Tabela de planos atualizada com sucesso');
    }
    
    // Fun√ß√£o para excluir um plano
    async function deletePlan(id) {
        console.log('Excluindo plano:', id);
        
        try {
            // Verificar se a exclus√£o desse plano j√° est√° em andamento
            if (window.deletingPlans && window.deletingPlans.has(id)) {
                console.log(`Fun√ß√£o deletePlan: Exclus√£o do plano ID ${id} j√° est√° em andamento. Ignorando chamada duplicada.`);
                return;
            }
            
            // Registrar que este plano est√° em processo de exclus√£o (se o Set n√£o existir, ser√° criado)
            window.deletingPlans = window.deletingPlans || new Set();
            window.deletingPlans.add(id);
            
            // CR√çTICO: Garantir que window.plans exista
            if (typeof window.ensureWindowPlansExists === 'function') {
                window.ensureWindowPlansExists();
            }
            
            // Verificar se o plano existe na mem√≥ria antes de tentar excluir
            if (!window.plans || !Array.isArray(window.plans) || !window.plans.some(p => p.id === id)) {
                console.error(`Plano ID ${id} n√£o existe na mem√≥ria`);
                alert('Erro: Plano n√£o encontrado na lista local.');
                window.deletingPlans.delete(id); // Remover da lista de exclus√£o em andamento
                return;
            }
            
            // Desabilitar todos os bot√µes de exclus√£o para este plano enquanto processa
            const deleteButtons = document.querySelectorAll(`.delete-plan[data-id="${id}"]`);
            deleteButtons.forEach(button => {
                // Salvar o conte√∫do original para restaurar depois se necess√°rio
                button.dataset.originalHtml = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                button.disabled = true;
            });
            
            // Excluir no backend via API
            const success = await deletePlanAPI(id);
            
            if (!success) {
                console.warn('API retornou erro, mas tentaremos remover localmente mesmo assim');
            } else {
                console.log('Plano exclu√≠do com sucesso na API');
            }
            
            // Remover o plano do array local em todos os casos
            // Mesmo com falha na API, removemos para manter consist√™ncia na interface
            window.plans = window.plans.filter(plan => plan.id !== id);
            
            // Atualizar localStorage como backup
            localStorage.setItem('agendai_plans', JSON.stringify(window.plans));
            
            // Garantir que o PlansStorage tamb√©m seja atualizado se estiver dispon√≠vel
            if (window.PlansStorage && typeof window.PlansStorage.savePlans === 'function') {
                window.PlansStorage.savePlans(window.plans);
            }
            
            // Restaurar bot√µes para estado original caso a opera√ß√£o seja muito r√°pida
            deleteButtons.forEach(button => {
                if (button.dataset.originalHtml) {
                    button.innerHTML = button.dataset.originalHtml;
                } else {
                    button.innerHTML = '<i class="fas fa-trash"></i>';
                }
                button.disabled = false;
            });
            
            // Atualizar interface antes de mostrar alerta
            refreshPlansUI();
            
            // Mostrar mensagem de sucesso apropriada
            if (success) {
                alert('Plano exclu√≠do com sucesso!');
            } else {
                alert('Plano removido localmente, mas houve um problema ao comunicar com o servidor.');
            }
            
            // Remover da lista de exclus√£o em andamento ap√≥s concluir
            window.deletingPlans.delete(id);
        } catch (error) {
            console.error('Erro ao excluir plano:', error);
            alert(`Erro ao excluir o plano: ${error.message || 'Erro desconhecido'}`);
            
            // Restaurar bot√µes para estado original em caso de erro
            const deleteButtons = document.querySelectorAll(`.delete-plan[data-id="${id}"]`);
            deleteButtons.forEach(button => {
                if (button.dataset.originalHtml) {
                    button.innerHTML = button.dataset.originalHtml;
                } else {
                    button.innerHTML = '<i class="fas fa-trash"></i>';
                }
                button.disabled = false;
            });
            
            // Remover da lista de exclus√£o em andamento em caso de erro
            if (window.deletingPlans) {
                window.deletingPlans.delete(id);
            }
        }
    }
    
    // Fun√ß√£o para editar um plano
    function editPlan(id) {
        console.log('------ DEBUGGING: Editando plano:', id);
        
        try {
            // Encontrar o plano pelo ID
            const plan = window.plans.find(p => p.id === parseInt(id));
            if (!plan) {
                console.error('------ DEBUGGING: Plano n√£o encontrado com ID:', id);
                alert('Plano n√£o encontrado!');
                return;
            }
            
            // Remover qualquer modal de edi√ß√£o anterior se existir
            const oldModal = document.getElementById('superEditPlanModal');
            if (oldModal) {
                oldModal.remove();
            }
            
            // Remover backdrop antigo se existir
            const oldBackdrop = document.querySelector('.modal-backdrop');
            if (oldBackdrop) {
                oldBackdrop.remove();
            }
            
            // Remover classe modal-open do body
            document.body.classList.remove('modal-open');
            
            // Normalizar as features para garantir valores booleanos consistentes
            const features = plan.features || {};
            
            // Garantir que todas as propriedades features existam como booleanos
            const ensuredFeatures = {
                reports: Boolean(features.reports),
                emailNotifications: features.emailNotifications === undefined ? true : Boolean(features.emailNotifications),
                smsNotifications: Boolean(features.smsNotifications),
                whatsAppNotifications: Boolean(features.whatsAppNotifications),
                customization: Boolean(features.customization),
                api: Boolean(features.api)
            };
            
            console.log('------ DEBUGGING: Features normalizadas para edi√ß√£o:', ensuredFeatures);
            
            // Criar um novo modal completamente do zero
            const newModalHTML = `
            <div class="modal fade" id="superEditPlanModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">Editar Plano</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="superEditPlanForm">
                                <input type="hidden" id="superEditPlanId" value="${plan.id}">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Nome do Plano*</label>
                                        <input type="text" class="form-control" id="superEditPlanName" value="${plan.name}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Pre√ßo (R$)*</label>
                                        <input type="number" class="form-control" id="superEditPlanPrice" value="${plan.price}" step="0.01" min="0" required>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Limite de Agendamentos*</label>
                                        <input type="number" class="form-control" id="superEditPlanAppointments" value="${plan.appointments}" min="0" required>
                                        <div class="form-text">0 para ilimitado</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Limite de Profissionais*</label>
                                        <input type="number" class="form-control" id="superEditPlanProfessionals" value="${plan.professionals}" min="0" required>
                                        <div class="form-text">0 para ilimitado</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Limite de Servi√ßos*</label>
                                        <input type="number" class="form-control" id="superEditPlanServices" value="${plan.services}" min="0" required>
                                        <div class="form-text">0 para ilimitado</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Status*</label>
                                        <select class="form-select" id="superEditPlanStatus" required>
                                            <option value="active" ${plan.status === 'active' ? 'selected' : ''}>Ativo</option>
                                            <option value="inactive" ${plan.status === 'inactive' ? 'selected' : ''}>Inativo</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Destaque*</label>
                                        <select class="form-select" id="superEditPlanHighlight" required>
                                            <option value="none" ${plan.highlight === 'none' ? 'selected' : ''}>Sem Destaque</option>
                                            <option value="popular" ${plan.highlight === 'popular' ? 'selected' : ''}>Popular</option>
                                            <option value="recommended" ${plan.highlight === 'recommended' ? 'selected' : ''}>Recomendado</option>
                                            <option value="best-value" ${plan.highlight === 'best-value' ? 'selected' : ''}>Melhor Custo-Benef√≠cio</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Descri√ß√£o</label>
                                    <textarea class="form-control" id="superEditPlanDescription" rows="3">${plan.description || ''}</textarea>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label">Recursos Inclu√≠dos</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="superEditFeatureReports" ${ensuredFeatures.reports ? 'checked' : ''}>
                                                <label class="form-check-label" for="superEditFeatureReports">Relat√≥rios Avan√ßados</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="superEditFeatureEmailNotifications" ${ensuredFeatures.emailNotifications ? 'checked' : ''}>
                                                <label class="form-check-label" for="superEditFeatureEmailNotifications">Notifica√ß√µes por Email</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="superEditFeatureSmsNotifications" ${ensuredFeatures.smsNotifications ? 'checked' : ''}>
                                                <label class="form-check-label" for="superEditFeatureSmsNotifications">Notifica√ß√µes por SMS</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="superEditFeatureWhatsAppNotifications" ${ensuredFeatures.whatsAppNotifications ? 'checked' : ''}>
                                                <label class="form-check-label" for="superEditFeatureWhatsAppNotifications">Notifica√ß√µes por WhatsApp</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="superEditFeatureCustomization" ${ensuredFeatures.customization ? 'checked' : ''}>
                                                <label class="form-check-label" for="superEditFeatureCustomization">Personaliza√ß√£o Avan√ßada</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="superEditFeatureAPI" ${ensuredFeatures.api ? 'checked' : ''}>
                                                <label class="form-check-label" for="superEditFeatureAPI">Acesso √† API</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="savePlan()">Atualizar</button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            // Adicionar o novo modal ao corpo do documento
            document.body.insertAdjacentHTML('beforeend', newModalHTML);
            
            // Criar e inicializar o modal usando Bootstrap
            const modalElement = document.getElementById('superEditPlanModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            // Somente ap√≥s o modal ser mostrado, for√ßar a atualiza√ß√£o das checkboxes
            // para garantir que estejam com o estado visual correto
            setTimeout(() => {
                const checkboxes = [
                    { id: 'superEditFeatureReports', state: ensuredFeatures.reports },
                    { id: 'superEditFeatureEmailNotifications', state: ensuredFeatures.emailNotifications },
                    { id: 'superEditFeatureSmsNotifications', state: ensuredFeatures.smsNotifications },
                    { id: 'superEditFeatureWhatsAppNotifications', state: ensuredFeatures.whatsAppNotifications },
                    { id: 'superEditFeatureCustomization', state: ensuredFeatures.customization },
                    { id: 'superEditFeatureAPI', state: ensuredFeatures.api }
                ];
                
                checkboxes.forEach(item => {
                    const checkbox = document.getElementById(item.id);
                    if (checkbox) {
                        // Garantir que o estado visual coincida com o estado l√≥gico
                        checkbox.checked = item.state;
                        console.log(`------ DEBUGGING: Checkbox ${item.id} = ${item.state}`);
                    }
                });
            }, 100);
            
        } catch (error) {
            console.error('------ DEBUGGING: Erro ao criar modal de edi√ß√£o:', error);
            alert('Erro ao abrir o formul√°rio de edi√ß√£o. Por favor, tente novamente.');
        }
    }

    // M√©todo melhorado para mostrar modal com maior compatibilidade
    function showModalSafelyEnhanced(modal) {
        console.log('------ DEBUGGING: Abrindo modal com m√©todo seguro aprimorado...');
        
        if (!modal) {
            console.error('------ DEBUGGING: Modal n√£o encontrado!');
            return;
        }
        
        try {
            // Garantir que o Bootstrap esteja dispon√≠vel
            if (typeof bootstrap === 'undefined' || !bootstrap.Modal) {
                console.warn('------ DEBUGGING: Bootstrap.Modal n√£o est√° dispon√≠vel, criando polyfill...');
                
                // Criar polyfill simples para Bootstrap.Modal
                window.bootstrap = window.bootstrap || {};
                bootstrap.Modal = function(element) {
                    this.element = element;
                    
                    this.show = function() {
                        element.style.display = 'block';
                        element.classList.add('show');
                        document.body.classList.add('modal-open');
                        
                        // Criar backdrop
                        if (!document.querySelector('.modal-backdrop')) {
                            const backdrop = document.createElement('div');
                            backdrop.className = 'modal-backdrop fade show';
                            document.body.appendChild(backdrop);
                        }
                        
                        // IMPORTANTE: For√ßar checkbox UI update ap√≥s abertura do modal
                        setTimeout(() => {
                            const checkboxes = element.querySelectorAll('input[type="checkbox"]');
                            console.log('------ DEBUGGING: For√ßando atualiza√ß√£o de', checkboxes.length, 'checkboxes ap√≥s abertura do modal');
                            checkboxes.forEach(checkbox => {
                                // Armazenar estado atual
                                const isChecked = checkbox.checked;
                                
                                // For√ßar mudan√ßa visual (toggle para o estado oposto e depois de volta)
                                checkbox.checked = !isChecked;
                                
                                // For√ßar reflow DOM
                                checkbox.offsetHeight;
                                
                                // Restaurar estado original
                                checkbox.checked = isChecked;
                                
                                console.log('------ DEBUGGING: Checkbox', checkbox.id, 'estado final:', checkbox.checked);
                            });
                        }, 200);
                    };
                    
                    this.hide = function() {
                        element.style.display = 'none';
                        element.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        
                        // Remover backdrop
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) backdrop.remove();
                    };
                };
                
                bootstrap.Modal.getInstance = function(element) {
                    return new bootstrap.Modal(element);
                };
            }
            
            // M√©todo 1: Tentar usar a API de Bootstrap (mais confi√°vel)
            try {
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
                console.log('------ DEBUGGING: Modal aberto com Bootstrap Modal API');
                
                // IMPORTANTE: For√ßar checkbox UI update ap√≥s abertura do modal
                setTimeout(() => {
                    const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
                    console.log('------ DEBUGGING: For√ßando atualiza√ß√£o de', checkboxes.length, 'checkboxes ap√≥s abertura do modal');
                    checkboxes.forEach(checkbox => {
                        // Armazenar estado atual
                        const isChecked = checkbox.checked;
                        
                        // For√ßar mudan√ßa visual (toggle para o estado oposto e depois de volta)
                        checkbox.checked = !isChecked;
                        
                        // For√ßar reflow DOM
                        checkbox.offsetHeight;
                        
                        // Restaurar estado original
                        checkbox.checked = isChecked;
                        
                        console.log('------ DEBUGGING: Checkbox', checkbox.id, 'estado final:', checkbox.checked);
                    });
                }, 200);
                
                return;
            } catch (bootstrapError) {
                console.warn('------ DEBUGGING: Erro ao usar Bootstrap Modal API:', bootstrapError);
            }
            
            // M√©todo 2: Tentar jQuery se dispon√≠vel
            if (typeof $ !== 'undefined') {
                try {
                    $(modal).modal('show');
                    console.log('------ DEBUGGING: Modal aberto com jQuery');
                    
                    // IMPORTANTE: For√ßar checkbox UI update ap√≥s abertura do modal com jQuery
                    setTimeout(() => {
                        const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
                        console.log('------ DEBUGGING: For√ßando atualiza√ß√£o de', checkboxes.length, 'checkboxes ap√≥s abertura do modal (jQuery)');
                        checkboxes.forEach(checkbox => {
                            const $checkbox = $(checkbox);
                            const isChecked = $checkbox.prop('checked');
                            
                            // Toggle e restaurar com jQuery
                            $checkbox.prop('checked', !isChecked).change();
                            $checkbox.prop('checked', isChecked).change();
                            
                            console.log('------ DEBUGGING: Checkbox', checkbox.id, 'estado final (jQuery):', $checkbox.prop('checked'));
                        });
                    }, 200);
                    
                    return;
                } catch (jQueryError) {
                    console.warn('------ DEBUGGING: Erro ao usar jQuery para abrir modal:', jQueryError);
                }
            }
            
            // M√©todo 3: Manipula√ß√£o direta do DOM como √∫ltimo recurso
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.classList.add('modal-open');
            
            // Adicionar backdrop manualmente
            if (!document.querySelector('.modal-backdrop')) {
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
            }
            
            console.log('------ DEBUGGING: Modal aberto com manipula√ß√£o direta do DOM');
            
            // IMPORTANTE: For√ßar checkbox UI update ap√≥s abertura do modal com DOM direto
            setTimeout(() => {
                const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
                console.log('------ DEBUGGING: For√ßando atualiza√ß√£o de', checkboxes.length, 'checkboxes ap√≥s abertura do modal (DOM direto)');
                checkboxes.forEach(checkbox => {
                    // Armazenar estado atual
                    const isChecked = checkbox.checked;
                    
                    // For√ßar mudan√ßa visual (toggle e restaurar)
                    checkbox.checked = !isChecked;
                    
                    // For√ßar reflow DOM
                    checkbox.offsetHeight;
                    
                    // Restaurar estado original
                    checkbox.checked = isChecked;
                    
                    console.log('------ DEBUGGING: Checkbox', checkbox.id, 'estado final (DOM direto):', checkbox.checked);
                });
            }, 200);
            
            // Garantir que os bot√µes de fechamento funcionem
            const closeButtons = modal.querySelectorAll('[data-bs-dismiss="modal"], .btn-close, #cancelEditBtn');
            closeButtons.forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                newButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    closeModalManually(modal);
                    return false;
                });
            });
        } catch (e) {
            console.error('------ DEBUGGING: Erro ao abrir modal:', e);
            alert('N√£o foi poss√≠vel abrir o formul√°rio de edi√ß√£o. Por favor, tente novamente ou recarregue a p√°gina.');
        }
    }
    
    // Fun√ß√£o para atualizar um plano existente
    async function updatePlan() {
        console.log('------ DEBUGGING: Fun√ß√£o updatePlan chamada');
        
        // CR√çTICO: Garantir que window.plans exista
        window.ensureWindowPlansExists();
        
        // Mostrar indicador de carregamento no bot√£o
        const updateBtn = document.getElementById('updatePlanBtn');
        if (updateBtn) {
            updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
            updateBtn.disabled = true;
        }
        
        try {
            // Verificar se o campo de ID existe
            const editPlanId = document.getElementById('editPlanId');
            if (!editPlanId) {
                throw new Error('Campo de ID do plano n√£o encontrado');
            }
            
            // Obter ID do plano
            const id = parseInt(editPlanId.value);
            if (isNaN(id) || id <= 0) {
                throw new Error('ID do plano inv√°lido');
            }
            
            console.log('------ DEBUGGING: Atualizando plano ID:', id);
            
            // Coletar dados do formul√°rio
            const name = document.getElementById('editPlanName')?.value || 'Plano';
            const price = parseFloat(document.getElementById('editPlanPrice')?.value || '0');
            const appointments = parseInt(document.getElementById('editPlanAppointments')?.value || '0');
            const professionals = parseInt(document.getElementById('editPlanProfessionals')?.value || '0');
            const services = parseInt(document.getElementById('editPlanServices')?.value || '0');
            const status = document.getElementById('editPlanStatus')?.value || 'active';
            const highlight = document.getElementById('editPlanHighlight')?.value || 'none';
            const description = document.getElementById('editPlanDescription')?.value || '';
            
            // Recursos/features - obter diretamente o estado das checkboxes
            const reports = document.getElementById('editFeatureReports')?.checked || false;
            const emailNotifications = document.getElementById('editFeatureEmailNotifications')?.checked || false;
            const smsNotifications = document.getElementById('editFeatureSmsNotifications')?.checked || false;
            const whatsAppNotifications = document.getElementById('editFeatureWhatsAppNotifications')?.checked || false;
            const customization = document.getElementById('editFeatureCustomization')?.checked || false;
            const api = document.getElementById('editFeatureAPI')?.checked || false;
            
            // Debug dos valores das checkboxes
            console.log('------ DEBUGGING: Valores das checkboxes no momento do salvamento:');
            console.log('reports:', reports, typeof reports);
            console.log('emailNotifications:', emailNotifications, typeof emailNotifications);
            console.log('smsNotifications:', smsNotifications, typeof smsNotifications);
            console.log('whatsAppNotifications:', whatsAppNotifications, typeof whatsAppNotifications);
            console.log('customization:', customization, typeof customization);
            console.log('api:', api, typeof api);
            
            // Criar o objeto atualizado do plano com features explicitamente como booleanos
            const planData = {
                name: name,
                price: price,
                appointments: appointments,
                professionals: professionals,
                services: services,
                status: status,
                highlight: highlight,
                description: description,
                features: {
                    reports: Boolean(reports),
                    emailNotifications: Boolean(emailNotifications),
                    smsNotifications: Boolean(smsNotifications),
                    whatsAppNotifications: Boolean(whatsAppNotifications),
                    customization: Boolean(customization),
                    api: Boolean(api)
                }
            };
            
            console.log('------ DEBUGGING: Dados atualizados do plano:', planData);
            
            // Fechar o modal com m√©todo seguro antes de fazer a requisi√ß√£o para evitar problemas de UI
            const modal = document.getElementById('editPlanModal');
            if (modal) {
                try {
                    console.log('------ DEBUGGING: Fechando modal antecipadamente para melhor UX');
                    closeModalManually(modal);
                } catch (modalError) {
                    console.error('------ DEBUGGING: Erro ao fechar modal:', modalError);
                    // N√£o interromper o fluxo principal em caso de erro no modal
                }
            }
            
            // Mostrar mensagem de processamento
            const tempMessage = document.createElement('div');
            tempMessage.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-4 shadow';
            tempMessage.style.zIndex = '9999';
            tempMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processando atualiza√ß√£o do plano...';
            document.body.appendChild(tempMessage);
            
            // Verificar conex√£o com API e token de autentica√ß√£o
            const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
            if (!authData.token) {
                console.warn('------ DEBUGGING: Token de autentica√ß√£o n√£o encontrado, tentando login autom√°tico...');
                const loginSuccess = await ensureAdminLogin();
                if (!loginSuccess) {
                    throw new Error('Token de autentica√ß√£o n√£o dispon√≠vel e n√£o foi poss√≠vel fazer login autom√°tico');
                }
            }
            
            // Atualizar no backend via API
            let updatedPlan = null;
            try {
                updatedPlan = await updatePlanAPI(id, planData);
                if (!updatedPlan) {
                    throw new Error('A API n√£o retornou um plano atualizado');
                }
            } catch (apiError) {
                console.error('------ DEBUGGING: Erro na API ao atualizar plano:', apiError);
                
                // Se falhar, atualizar localmente como fallback
                console.log('------ DEBUGGING: Tentando atualizar localmente como fallback...');
                
                // Garantir que window.plans √© um array v√°lido
                if (!Array.isArray(window.plans)) {
                    console.warn('------ DEBUGGING: window.plans n√£o √© um array, inicializando');
                    window.plans = [];
                }
                
                // Verificar se o plano existe na lista local
                const planIndex = window.plans.findIndex(p => p.id === id);
                
                // Criar plano local atualizado com features explicitamente definidas
                updatedPlan = {
                    id: id,  // Garantir que o ID seja preservado
                    ...planData,
                    updated_at: new Date().toISOString(),
                    storage_type: 'local_update',
                    features: {
                        reports: reports,
                        emailNotifications: emailNotifications,
                        smsNotifications: smsNotifications,
                        whatsAppNotifications: whatsAppNotifications,
                        customization: customization,
                        api: api
                    }
                };
                
                // Atualizar localmente
                if (planIndex !== -1) {
                    // Se o plano j√° existe, atualizar
                    window.plans[planIndex] = updatedPlan;
                } else {
                    // Se o plano n√£o existe, adicionar
                    window.plans.push(updatedPlan);
                }
                
                // Salvar no localStorage
                localStorage.setItem('agendai_plans', JSON.stringify(window.plans));
                console.log('------ DEBUGGING: Plano atualizado localmente como fallback');
            }
            
            console.log('------ DEBUGGING: Plano atualizado com sucesso:', updatedPlan);
            
            // Atualizar a interface do usu√°rio imediatamente ap√≥s a atualiza√ß√£o
            await refreshPlansUI();
            
            // Remover mensagem tempor√°ria
            if (tempMessage && tempMessage.parentNode) {
                tempMessage.parentNode.removeChild(tempMessage);
            }
            
            // Mostrar mensagem de sucesso
            const successMessage = document.createElement('div');
            successMessage.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-4 shadow';
            successMessage.style.zIndex = '9999';
            
            if (updatedPlan.storage_type === 'local_update') {
                successMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i> Plano atualizado com sucesso (localmente)! A sincroniza√ß√£o com a API ocorrer√° quando a conex√£o for restaurada.';
            } else {
                successMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i> Plano atualizado com sucesso!';
            }
            
            document.body.appendChild(successMessage);
            
            // Remover mensagem ap√≥s 5 segundos
            setTimeout(() => {
                if (successMessage && successMessage.parentNode) {
                    successMessage.parentNode.removeChild(successMessage);
                }
            }, 5000);
            
            // Tentar carregar da API novamente para garantir sincroniza√ß√£o
            setTimeout(loadPlansFromAPI, 1000);
            
        } catch (error) {
            console.error('------ DEBUGGING: Erro ao atualizar plano:', error);
            
            // Mostrar alerta de erro
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert alert-danger position-fixed top-0 start-50 translate-middle-x mt-4 shadow';
            errorMessage.style.zIndex = '9999';
            errorMessage.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i> Erro ao atualizar o plano: ${error.message}`;
            document.body.appendChild(errorMessage);
            
            // Remover alerta ap√≥s 5 segundos
            setTimeout(() => {
                if (errorMessage && errorMessage.parentNode) {
                    errorMessage.parentNode.removeChild(errorMessage);
                }
            }, 5000);
        } finally {
            // Restaurar bot√£o para estado normal
            if (updateBtn) {
                updateBtn.innerHTML = 'Atualizar';
                updateBtn.disabled = false;
            }
        }
    }

    // Fun√ß√£o para verificar a integridade da interface e garantir que todos os elementos necess√°rios estejam presentes
    function checkUIIntegrity() {
        console.log('------ DEBUGGING: Verificando integridade da UI...');
        
        try {
            // Verificar se o bot√£o de novo plano existe
            const newPlanBtn = document.getElementById('newPlanBtn');
            if (!newPlanBtn) {
                console.warn('------ DEBUGGING: Bot√£o de novo plano n√£o encontrado, recriando...');
                const headerRow = document.getElementById('headerRow');
                if (headerRow) {
                    const btnContainer = headerRow.querySelector('.col-md-4.text-md-end');
                    if (btnContainer) {
                        btnContainer.innerHTML = `
                            <button type="button" class="btn btn-primary" id="newPlanBtn" onclick="openAddPlanModalManually()">
                                <i class="fas fa-plus me-1"></i> Novo Plano
                            </button>
                        `;
                        console.log('------ DEBUGGING: Bot√£o de novo plano recriado com sucesso');
                    } else {
                        console.error('------ DEBUGGING: Container de bot√µes n√£o encontrado');
                    }
                } else {
                    console.error('------ DEBUGGING: Container de header n√£o encontrado');
                }
            }
            
            // Verificar se h√° container para os cards
            const headerRow = document.getElementById('headerRow');
            if (headerRow) {
                let cardsContainer = headerRow.nextElementSibling;
                if (!cardsContainer || !cardsContainer.classList.contains('row')) {
                    console.warn('------ DEBUGGING: Container de cards n√£o encontrado, criando novo');
                    cardsContainer = document.createElement('div');
                    cardsContainer.className = 'row mb-4';
                    headerRow.parentNode.insertBefore(cardsContainer, headerRow.nextSibling);
                }
            }
            
            // Verificar se a tabela de planos existe
            const plansTable = document.getElementById('plansTable');
            if (!plansTable) {
                console.warn('------ DEBUGGING: Tabela de planos n√£o encontrada');
            } else {
                // Verificar se o corpo da tabela existe
                const tableBody = plansTable.querySelector('tbody');
                if (!tableBody) {
                    console.warn('------ DEBUGGING: Corpo da tabela n√£o encontrado, criando novo');
                    const newTbody = document.createElement('tbody');
                    plansTable.appendChild(newTbody);
                }
            }
            
            console.log('------ DEBUGGING: Verifica√ß√£o de integridade da UI conclu√≠da');
        } catch (error) {
            console.error('------ DEBUGGING: Erro ao verificar integridade da UI:', error);
        }
    }

    // Fun√ß√£o para sincronizar planos pendentes com a API
    async function syncPendingPlans() {
        console.log('----- DEBUGGING: Iniciando sincroniza√ß√£o de planos pendentes -----');
        
        // Verificar se temos planos para sincronizar
        if (!window.plans || !Array.isArray(window.plans)) {
            console.log('----- DEBUGGING: N√£o h√° planos para sincronizar (window.plans inv√°lido) -----');
            return;
        }
        
        // Filtrar planos que precisam ser sincronizados (criados ou atualizados localmente)
        const pendingPlans = window.plans.filter(p => p.storage_type === 'local' || p.storage_type === 'local_update');
        
        if (pendingPlans.length === 0) {
            console.log('----- DEBUGGING: N√£o h√° planos pendentes para sincronizar -----');
            return;
        }
        
        console.log(`----- DEBUGGING: Encontrados ${pendingPlans.length} planos pendentes para sincroniza√ß√£o -----`);
        
        // Obter token de autentica√ß√£o
        const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
        let token = authData.token;
        
        if (!token) {
            console.error('----- DEBUGGING: Token de autentica√ß√£o n√£o encontrado para sincroniza√ß√£o -----');
            return;
        }
        
        // Processar cada plano pendente
        for (const plan of pendingPlans) {
            console.log(`----- DEBUGGING: Sincronizando plano: ${plan.name} (ID: ${plan.id}) -----`);
            
            try {
                // Preparar dados para envio √† API (remover propriedades locais)
                const planToSync = { ...plan };
                delete planToSync.storage_type;
                delete planToSync.last_updated;
                
                // Determinar se √© uma cria√ß√£o ou atualiza√ß√£o
                const isNewPlan = typeof plan.id === 'string' && plan.id.startsWith('local_');
                
                if (isNewPlan) {
                    // Se for um novo plano, remover o ID local para que a API gere um novo
                    delete planToSync.id;
                    
                    // Enviar para a API (cria√ß√£o)
                    const response = await fetch(`${window.API_URL}/plans`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(planToSync)
                    });
                    
                    if (response.ok) {
                        const newPlan = await response.json();
                        console.log(`----- DEBUGGING: Plano criado com sucesso na API, ID: ${newPlan.id} -----`);
                        
                        // Atualizar o plano local com o ID da API
                        const planIndex = window.plans.findIndex(p => p.id === plan.id);
                        if (planIndex !== -1) {
                            // Mesclar dados (manter o novo ID da API e outros dados da resposta)
                            window.plans[planIndex] = {
                                ...newPlan,
                                storage_type: 'api', // Marcar como sincronizado
                                last_updated: new Date().toISOString()
                            };
                        }
                    } else {
                        console.error(`----- DEBUGGING: Erro ao criar plano na API: ${response.status} -----`);
                        // Manter o plano como local para tentar sincronizar novamente depois
                    }
                } else {
                    // √â uma atualiza√ß√£o de um plano existente
                    const response = await fetch(`${window.API_URL}/plans/${plan.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(planToSync)
                    });
                    
                    if (response.ok) {
                        const updatedPlan = await response.json();
                        console.log(`----- DEBUGGING: Plano atualizado com sucesso na API, ID: ${updatedPlan.id} -----`);
                        
                        // Atualizar o plano local
                        const planIndex = window.plans.findIndex(p => p.id === plan.id);
                        if (planIndex !== -1) {
                            // Mesclar dados (manter dados da resposta)
                            window.plans[planIndex] = {
                                ...updatedPlan,
                                storage_type: 'api', // Marcar como sincronizado
                                last_updated: new Date().toISOString()
                            };
                        }
                    } else {
                        console.error(`----- DEBUGGING: Erro ao atualizar plano na API: ${response.status} -----`);
                        // Manter o plano como local_update para tentar sincronizar novamente depois
                    }
                }
            } catch (error) {
                console.error(`----- DEBUGGING: Erro ao sincronizar plano ${plan.id}:`, error);
                // Manter o plano como pendente para tentar novamente mais tarde
            }
        }
        
        // Salvar planos atualizados
        window.PlansStorage.savePlans(window.plans);
        
        console.log('----- DEBUGGING: Sincroniza√ß√£o de planos pendentes conclu√≠da -----');
    }

    // CR√çTICO: Tentar novamente exibir os planos
    (function() {
        // Executar quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Esperar um pouco para garantir que tudo carregou
            setTimeout(function() {
                console.log('===== DIAGN√ìSTICO DE EXIBI√á√ÉO DE PLANOS =====');
                
                // Verificar se temos planos no localStorage
                const storedPlansJson = localStorage.getItem('agendai_plans');
                if (storedPlansJson) {
                    try {
                        const storedPlans = JSON.parse(storedPlansJson);
                        if (Array.isArray(storedPlans) && storedPlans.length > 0) {
                            console.log(`Encontrados ${storedPlans.length} planos no localStorage`);
                            
                            // For√ßar a atualiza√ß√£o da interface com estes planos
                            window.plans = storedPlans;
                            
                            // Garantir que PlansStorage tamb√©m esteja atualizado
                            if (window.PlansStorage) {
                                window.PlansStorage.savePlans(storedPlans);
                            }
                            
                            // For√ßar atualiza√ß√£o da interface
                            if (typeof refreshPlansUI === 'function') {
                                console.log('For√ßando atualiza√ß√£o da UI com os planos do localStorage');
                                refreshPlansUI();
                            } else {
                                console.error('Fun√ß√£o refreshPlansUI n√£o encontrada!');
                                
                                // Atualiza√ß√£o manual como √∫ltimo recurso
                                const plansTable = document.querySelector('#plansTable tbody');
                                if (plansTable) {
                                    // Limpar tabela
                                    plansTable.innerHTML = '';
                                    
                                    // Adicionar cada plano
                                    storedPlans.forEach(plan => {
                                        // Formata√ß√£o dos valores
                                        const price = typeof plan.price === 'number' ? plan.price.toFixed(2) : 
                                                    (typeof plan.price === 'string' ? parseFloat(plan.price).toFixed(2) : '0.00');
                                        const appointmentsText = plan.appointments === 0 ? 'Ilimitado' : plan.appointments;
                                        const professionalsText = plan.professionals === 0 ? 'Ilimitado' : plan.professionals;
                                        const servicesText = plan.services === 0 ? 'Ilimitado' : plan.services;
                                        const statusClass = plan.status === 'active' ? 'bg-success' : 'bg-danger';
                                        const statusText = plan.status === 'active' ? 'Ativo' : 'Inativo';
                                        
                                        // Criar HTML da linha
                                        const rowHTML = `
                                        <tr>
                                            <td>${plan.id}</td>
                                            <td>${plan.name}</td>
                                            <td>R$ ${price}</td>
                                            <td>${appointmentsText}</td>
                                            <td>${professionalsText}</td>
                                            <td>${servicesText}</td>
                                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                                            <td>
                                                <button class="btn btn-sm btn-primary edit-plan me-1" data-id="${plan.id}" onclick="editPlan(${plan.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger delete-plan" data-id="${plan.id}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>`;
                                        
                                        plansTable.innerHTML += rowHTML;
                                    });
                                }
                                
                                // Atualizar cards tamb√©m
                                const headerRow = document.querySelector('.row.mb-4#headerRow');
                                if (headerRow) {
                                    let cardsContainer = headerRow.nextElementSibling;
                                    if (!cardsContainer || !cardsContainer.classList.contains('row')) {
                                        console.log('Container de cards n√£o encontrado, criando novo');
                                        cardsContainer = document.createElement('div');
                                        cardsContainer.className = 'row mb-4';
                                        headerRow.parentNode.insertBefore(cardsContainer, headerRow.nextSibling);
                                    }
                                    
                                    // Limpar container
                                    cardsContainer.innerHTML = '';
                                    
                                    // Adicionar cada plano ativo
                                    storedPlans.forEach(plan => {
                                        if (plan.status !== 'active') return;
                                        
                                        // Formata√ß√£o dos valores
                                        const price = typeof plan.price === 'number' ? plan.price.toFixed(2) : 
                                                    (typeof plan.price === 'string' ? parseFloat(plan.price).toFixed(2) : '0.00');
                                        const appointmentsText = plan.appointments === 0 ? 'Ilimitados' : plan.appointments;
                                        const professionalsText = plan.professionals === 0 ? 'Ilimitados' : plan.professionals;
                                        const servicesText = plan.services === 0 ? 'Ilimitados' : plan.services;
                                        
                                        // Verificar se features est√° definido e √© um objeto
                                        const features = plan.features || {};
                                        
                                        function getHighlightLabel(highlight) {
                                            switch (highlight) {
                                                case 'popular': return 'Popular';
                                                case 'recommended': return 'Recomendado';
                                                case 'best-value': return 'Melhor Custo-Benef√≠cio';
                                                default: return '';
                                            }
                                        }
                                        
                                        // Criar HTML do card
                                        const cardHTML = `
                                        <div class="col-md-4 mb-4">
                                            <div class="card shadow h-100 ${plan.highlight !== 'none' ? 'border-primary' : ''}">
                                                <div class="card-header py-3 bg-primary text-white">
                                                    <h6 class="m-0 font-weight-bold">${plan.name}</h6>
                                                    ${plan.highlight !== 'none' ? `
                                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark">
                                                        ${getHighlightLabel(plan.highlight)}
                                                    </span>` : ''}
                                                </div>
                                                <div class="card-body">
                                                    <div class="text-center mb-4">
                                                        <h2 class="card-price text-primary">R$ ${price}<span class="period">/m√™s</span></h2>
                                                    </div>
                                                    <ul class="list-group list-group-flush mb-4">
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            Agendamentos
                                                            <span class="badge bg-primary rounded-pill">${appointmentsText}</span>
                                                        </li>
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            Profissionais
                                                            <span class="badge bg-primary rounded-pill">${professionalsText}</span>
                                                        </li>
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            Servi√ßos
                                                            <span class="badge bg-primary rounded-pill">${servicesText}</span>
                                                        </li>
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            Relat√≥rios
                                                            <span class="badge ${features.reports ? 'bg-success' : 'bg-danger'} rounded-pill">
                                                                ${features.reports ? 'Sim' : 'N√£o'}
                                                            </span>
                                                        </li>
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            Notifica√ß√µes
                                                            <span class="badge bg-success rounded-pill">Sim</span>
                                                        </li>
                                                    </ul>
                                                    <div class="d-grid">
                                                        <button class="btn btn-outline-primary" onclick="editPlan(${plan.id})">
                                                            <i class="fas fa-edit me-1"></i> Editar Plano
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>`;
                                        
                                        cardsContainer.innerHTML += cardHTML;
                                    });
                                }
                            }
                        } else {
                            console.warn('N√£o foram encontrados planos v√°lidos no localStorage');
                        }
                    } catch (e) {
                        console.error('Erro ao processar planos do localStorage:', e);
                    }
                } else {
                    console.warn('Nenhum plano encontrado no localStorage');
                }
                
                console.log('===== FIM DO DIAGN√ìSTICO =====');
            }, 1000); // Aguardar 1 segundo para certificar-se de que tudo j√° carregou
        });
    })();

    // ... existing code ...
    // Fun√ß√£o para confirmar exclus√£o de um plano
    window.confirmDeletePlan = function(id) {
        console.log(`------ DEBUGGING: Confirmando exclus√£o do plano ID: ${id}`);
        if (confirm(`Deseja realmente excluir o plano ID: ${id}?`)) {
            deletePlan(id);
        }
    };

    // Fun√ß√£o para atualizar a interface do usu√°rio
    async function refreshPlansUI() {
        console.log('------ DEBUGGING: Iniciando refreshPlansUI...');
        
        // CR√çTICO: Garantir que window.plans exista
        window.ensureWindowPlansExists();
        
        try {
            // Verificar se window.plans existe e √© um array
            if (!Array.isArray(window.plans)) {
                console.error('------ DEBUGGING: window.plans n√£o √© um array em refreshPlansUI!');
                window.plans = [];
            }
            
            console.log(`------ DEBUGGING: Atualizando UI com ${window.plans.length} planos`);
            
            // Normalizar os planos para garantir que todas as propriedades existam
            const normalizedPlans = window.plans.map(plan => normalizePlanFeatures(plan));
            
            // Atualizar tabela de planos
            const plansTable = document.querySelector('#plansTable tbody');
            if (plansTable) {
                // Limpar tabela
                plansTable.innerHTML = '';
                
                if (normalizedPlans.length === 0) {
                    // Adicionar mensagem de nenhum plano
                    const emptyRow = `
                    <tr>
                        <td colspan="8" class="text-center py-3">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Nenhum plano cadastrado. Clique em "Novo Plano" para adicionar.
                            </div>
                        </td>
                    </tr>
                    `;
                    plansTable.innerHTML = emptyRow;
                } else {
                    // Adicionar cada plano
                    normalizedPlans.forEach(plan => {
                        // Formata√ß√£o dos valores
                        const price = typeof plan.price === 'number' ? plan.price.toFixed(2) : 
                                    (typeof plan.price === 'string' ? parseFloat(plan.price).toFixed(2) : '0.00');
                        const appointmentsText = plan.appointments === 0 ? 'Ilimitado' : plan.appointments;
                        const professionalsText = plan.professionals === 0 ? 'Ilimitado' : plan.professionals;
                        const servicesText = plan.services === 0 ? 'Ilimitado' : plan.services;
                        const statusClass = plan.status === 'active' ? 'bg-success' : 'bg-danger';
                        const statusText = plan.status === 'active' ? 'Ativo' : 'Inativo';
                        
                        // Criar HTML da linha
                        const rowHTML = `
                        <tr>
                            <td>${plan.id}</td>
                            <td>${plan.name}</td>
                            <td>R$ ${price}</td>
                            <td>${appointmentsText}</td>
                            <td>${professionalsText}</td>
                            <td>${servicesText}</td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary edit-plan me-1" data-id="${plan.id}" onclick="editPlan(${plan.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-plan" data-id="${plan.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>`;
                        
                        plansTable.innerHTML += rowHTML;
                    });
                }
                console.log('------ DEBUGGING: Tabela de planos atualizada');
            } else {
                console.error('------ DEBUGGING: Tabela de planos n√£o encontrada!');
            }
            
            // Atualizar cards de planos
            const headerRow = document.querySelector('.row.mb-4#headerRow');
            if (headerRow) {
                let cardsContainer = headerRow.nextElementSibling;
                if (!cardsContainer || !cardsContainer.classList.contains('row')) {
                    console.log('------ DEBUGGING: Container de cards n√£o encontrado, criando novo');
                    cardsContainer = document.createElement('div');
                    cardsContainer.className = 'row mb-4';
                    headerRow.parentNode.insertBefore(cardsContainer, headerRow.nextSibling);
                }
                
                // Limpar container
                cardsContainer.innerHTML = '';
                
                // Filtrar apenas planos ativos para mostrar nos cards
                const activePlans = normalizedPlans.filter(plan => plan.status === 'active');
                
                if (activePlans.length === 0) {
                    // Adicionar mensagem de nenhum plano ativo
                    const emptyCardHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Nenhum plano ativo para exibi√ß√£o. Ative um plano para que ele apare√ßa aqui.
                        </div>
                    </div>`;
                    cardsContainer.innerHTML = emptyCardHTML;
                } else {
                    // Adicionar cada plano ativo
                    activePlans.forEach(plan => {
                        // Formata√ß√£o dos valores
                        const price = typeof plan.price === 'number' ? plan.price.toFixed(2) : 
                                     (typeof plan.price === 'string' ? parseFloat(plan.price).toFixed(2) : '0.00');
                        const appointmentsText = plan.appointments === 0 ? 'Ilimitados' : plan.appointments;
                        const professionalsText = plan.professionals === 0 ? 'Ilimitados' : plan.professionals;
                        const servicesText = plan.services === 0 ? 'Ilimitados' : plan.services;
                        
                        // Verificar se features est√° definido e √© um objeto
                        const features = plan.features || {};
                        console.log(`------ DEBUGGING: Plano ID ${plan.id} features para card:`, features);
                        
                        function getHighlightLabel(highlight) {
                            switch (highlight) {
                                case 'popular': return 'Popular';
                                case 'recommended': return 'Recomendado';
                                case 'best-value': return 'Melhor Custo-Benef√≠cio';
                                default: return '';
                            }
                        }
                        
                        // Criar HTML do card
                        const cardHTML = `
                        <div class="col-md-4 mb-4">
                            <div class="card shadow h-100 ${plan.highlight !== 'none' ? 'border-primary' : ''}">
                                <div class="card-header py-3 bg-primary text-white">
                                    <h6 class="m-0 font-weight-bold">${plan.name}</h6>
                                    ${plan.highlight !== 'none' ? `
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark">
                                        ${getHighlightLabel(plan.highlight)}
                                    </span>` : ''}
                                </div>
                                <div class="card-body">
                                    <div class="text-center mb-4">
                                        <h2 class="card-price text-primary">R$ ${price}<span class="period">/m√™s</span></h2>
                                    </div>
                                    <ul class="list-group list-group-flush mb-4">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Agendamentos
                                            <span class="badge bg-primary rounded-pill">${appointmentsText}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Profissionais
                                            <span class="badge bg-primary rounded-pill">${professionalsText}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Servi√ßos
                                            <span class="badge bg-primary rounded-pill">${servicesText}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Relat√≥rios
                                            <span class="badge ${features.reports ? 'bg-success' : 'bg-danger'} rounded-pill">
                                                ${features.reports ? 'Sim' : 'N√£o'}
                                            </span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Notifica√ß√µes
                                            <span class="badge ${(features.emailNotifications || features.smsNotifications || features.whatsAppNotifications) ? 'bg-success' : 'bg-danger'} rounded-pill">
                                                ${(features.emailNotifications || features.smsNotifications || features.whatsAppNotifications) ? 'Sim' : 'N√£o'}
                                            </span>
                                        </li>
                                    </ul>
                                    <div class="d-grid">
                                        <button class="btn btn-outline-primary" onclick="editPlan(${plan.id})">
                                            <i class="fas fa-edit me-1"></i> Editar Plano
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                        
                        cardsContainer.innerHTML += cardHTML;
                    });
                }
                console.log('------ DEBUGGING: Cards de planos atualizados');
            } else {
                console.error('------ DEBUGGING: Header row n√£o encontrado para adicionar cards');
            }
            
            // Debug dados salvos no localStorage
            try {
                const storedPlansJson = localStorage.getItem('agendai_plans');
                if (storedPlansJson) {
                    const storedPlans = JSON.parse(storedPlansJson);
                    if (Array.isArray(storedPlans)) {
                        console.log(`------ DEBUGGING: localStorage cont√©m ${storedPlans.length} planos ap√≥s UI refresh`);
                    }
                }
            } catch (localStorageError) {
                console.error('------ DEBUGGING: Erro ao verificar localStorage ap√≥s UI refresh:', localStorageError);
            }
            
            // Configurar listeners para os bot√µes de exclus√£o
            // Antiga chamada para fun√ß√£o inexistente que causava o erro:
            // setupPlanActionButtonListeners();
            
            // Em vez disso, vamos configurar os bot√µes de exclus√£o diretamente aqui:
            try {
                const deleteButtons = document.querySelectorAll('.delete-plan');
                console.log(`------ DEBUGGING: Encontrados ${deleteButtons.length} bot√µes de exclus√£o para configurar`);
                
                deleteButtons.forEach(btn => {
                    const planId = btn.getAttribute('data-id');
                    if (planId) {
                        // Garantir que o onclick esteja definido
                        btn.onclick = function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            console.log(`Bot√£o de exclus√£o clicado para o plano ID: ${planId}`);
                            window.confirmDeletePlan(parseInt(planId));
                            return false;
                        };
                    }
                });
            } catch (buttonError) {
                console.error('------ DEBUGGING: Erro ao configurar bot√µes de exclus√£o:', buttonError);
            }
            
            console.log('------ DEBUGGING: UI atualizada com sucesso');
            return true;
        } catch (error) {
            console.error('------ DEBUGGING: Erro ao atualizar UI:', error);
            
            // Tentar uma abordagem mais simples se a atualiza√ß√£o falhar
            try {
                const plansTable = document.querySelector('#plansTable tbody');
                if (plansTable && Array.isArray(window.plans)) {
                    plansTable.innerHTML = ''; // Limpar tabela
                    
                    // Adicionar mensagem de erro
                    const errorRow = `
                    <tr>
                        <td colspan="8" class="text-center py-3">
                            <div class="alert alert-danger mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Erro ao atualizar a interface. Tente recarregar a p√°gina.
                            </div>
                        </td>
                    </tr>`;
                    plansTable.innerHTML = errorRow;
                    
                    console.log('------ DEBUGGING: Adicionada mensagem de erro na UI');
                }
            } catch (secondaryError) {
                console.error('------ DEBUGGING: Erro secund√°rio ao tentar exibir mensagem de erro:', secondaryError);
            }
            
            return false;
        }
    }
    
    // ... existing code ...
    
    // Fun√ß√£o para salvar um plano editado
    function savePlan() {
        console.log('------ DEBUGGING: Fun√ß√£o savePlan chamada');
        
        try {
            // Coletar dados do formul√°rio
            const id = parseInt(document.getElementById('superEditPlanId').value);
            const name = document.getElementById('superEditPlanName').value || 'Plano';
            const price = parseFloat(document.getElementById('superEditPlanPrice').value || '0');
            const appointments = parseInt(document.getElementById('superEditPlanAppointments').value || '0');
            const professionals = parseInt(document.getElementById('superEditPlanProfessionals').value || '0');
            const services = parseInt(document.getElementById('superEditPlanServices').value || '0');
            const status = document.getElementById('superEditPlanStatus').value || 'active';
            const highlight = document.getElementById('superEditPlanHighlight').value || 'none';
            const description = document.getElementById('superEditPlanDescription').value || '';
            
            // Obter estado das checkboxes
            const reports = document.getElementById('superEditFeatureReports').checked;
            const emailNotifications = document.getElementById('superEditFeatureEmailNotifications').checked;
            const smsNotifications = document.getElementById('superEditFeatureSmsNotifications').checked;
            const whatsAppNotifications = document.getElementById('superEditFeatureWhatsAppNotifications').checked;
            const customization = document.getElementById('superEditFeatureCustomization').checked;
            const api = document.getElementById('superEditFeatureAPI').checked;
            
            console.log('------ DEBUGGING: Estado das checkboxes ao salvar:');
            console.log('reports:', reports);
            console.log('emailNotifications:', emailNotifications);
            console.log('smsNotifications:', smsNotifications);
            console.log('whatsAppNotifications:', whatsAppNotifications);
            console.log('customization:', customization);
            console.log('api:', api);
            
            // Criar o objeto atualizado do plano
            const planData = {
                name: name,
                price: price,
                appointments: appointments,
                professionals: professionals,
                services: services,
                status: status,
                highlight: highlight,
                description: description,
                features: {
                    reports: reports,
                    emailNotifications: emailNotifications,
                    smsNotifications: smsNotifications,
                    whatsAppNotifications: whatsAppNotifications,
                    customization: customization,
                    api: api
                }
            };
            
            // Fechar o modal
            const modalElement = document.getElementById('superEditPlanModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            
            // Mostrar mensagem de processamento
            const tempMessage = document.createElement('div');
            tempMessage.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-4 shadow';
            tempMessage.style.zIndex = '9999';
            tempMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processando atualiza√ß√£o do plano...';
            document.body.appendChild(tempMessage);
            
            // Chamar a API para atualizar o plano
            updatePlanAPI(id, planData)
                .then(updatedPlan => {
                    console.log('------ DEBUGGING: Plano atualizado com sucesso:', updatedPlan);
                    
                    // Atualizar a interface do usu√°rio
                    refreshPlansUI();
                    
                    // Remover mensagem tempor√°ria
                    if (tempMessage && tempMessage.parentNode) {
                        tempMessage.parentNode.removeChild(tempMessage);
                    }
                    
                    // Mostrar mensagem de sucesso
                    const successMessage = document.createElement('div');
                    successMessage.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-4 shadow';
                    successMessage.style.zIndex = '9999';
                    successMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i> Plano atualizado com sucesso!';
                    document.body.appendChild(successMessage);
                    
                    // Remover mensagem ap√≥s 3 segundos
                    setTimeout(() => {
                        if (successMessage && successMessage.parentNode) {
                            successMessage.parentNode.removeChild(successMessage);
                        }
                    }, 3000);
                })
                .catch(error => {
                    console.error('------ DEBUGGING: Erro ao atualizar plano:', error);
                    
                    // Remover mensagem tempor√°ria
                    if (tempMessage && tempMessage.parentNode) {
                        tempMessage.parentNode.removeChild(tempMessage);
                    }
                    
                    // Mostrar mensagem de erro
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'alert alert-danger position-fixed top-0 start-50 translate-middle-x mt-4 shadow';
                    errorMessage.style.zIndex = '9999';
                    errorMessage.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i> Erro ao atualizar o plano: ${error.message}`;
                    document.body.appendChild(errorMessage);
                    
                    // Remover mensagem ap√≥s 5 segundos
                    setTimeout(() => {
                        if (errorMessage && errorMessage.parentNode) {
                            errorMessage.parentNode.removeChild(errorMessage);
                        }
                    }, 5000);
                });
        } catch (error) {
            console.error('------ DEBUGGING: Erro ao processar formul√°rio:', error);
            alert(`Erro ao processar formul√°rio: ${error.message}`);
        }
    }
    
    // ... existing code ...
    
    // Fun√ß√£o para criar um novo plano a partir do modal #addPlanModal
    async function createPlan() {
        console.log('Fun√ß√£o createPlan chamada');
        
        // CR√çTICO: Garantir que window.plans exista
        window.ensureWindowPlansExists();
        
        // Mostrar indicador de carregamento no bot√£o
        const saveBtn = document.getElementById('savePlanBtn');
        if (saveBtn) {
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            saveBtn.disabled = true;
        }
        
        try {
            // Coletar dados do formul√°rio
            const formElements = {
                name: document.getElementById('planName'),
                price: document.getElementById('planPrice'),
                appointments: document.getElementById('planAppointments'),
                professionals: document.getElementById('planProfessionals'),
                services: document.getElementById('planServices'),
                status: document.getElementById('planStatus'),
                highlight: document.getElementById('planHighlight'),
                description: document.getElementById('planDescription'),
                reports: document.getElementById('featureReports'),
                emailNotifications: document.getElementById('featureEmailNotifications'),
                smsNotifications: document.getElementById('featureSmsNotifications'),
                whatsAppNotifications: document.getElementById('featureWhatsAppNotifications'),
                customization: document.getElementById('featureCustomization'),
                api: document.getElementById('featureAPI')
            };
            
            // Verificar se todos os elementos foram encontrados
            let missingElements = [];
            for (const [key, element] of Object.entries(formElements)) {
                if (!element) {
                    missingElements.push(key);
                }
            }
            
            if (missingElements.length > 0) {
                console.error('------ DEBUGGING: Elementos ausentes no formul√°rio:', missingElements);
                throw new Error('Falha ao encontrar todos os elementos do formul√°rio: ' + missingElements.join(', '));
            }
            
            // Extrair valores com seguran√ßa
            const name = formElements.name.value || 'Novo Plano';
            const price = parseFloat(formElements.price.value || '50');
            const appointments = parseInt(formElements.appointments.value || '50');
            const professionals = parseInt(formElements.professionals.value || '2');
            const services = parseInt(formElements.services.value || '10');
            const status = formElements.status.value || 'active';
            const highlight = formElements.highlight.value || 'none';
            const description = formElements.description.value || '';
            
            // Recursos/features
            const reports = formElements.reports.checked;
            const emailNotifications = formElements.emailNotifications.checked;
            const smsNotifications = formElements.smsNotifications.checked;
            const whatsAppNotifications = formElements.whatsAppNotifications.checked;
            const customization = formElements.customization.checked;
            const api = formElements.api.checked;
            
            // Criar o objeto do plano
            const planData = {
                name: name,
                price: price,
                appointments: appointments,
                professionals: professionals,
                services: services,
                status: status,
                highlight: highlight,
                description: description,
                features: {
                    reports: reports,
                    emailNotifications: emailNotifications,
                    smsNotifications: smsNotifications,
                    whatsAppNotifications: whatsAppNotifications,
                    customization: customization,
                    api: api
                }
            };
            
            console.log('Dados do novo plano:', planData);
            
            // Verificar autentica√ß√£o antes de salvar
            const authData = JSON.parse(localStorage.getItem('agendai_auth') || '{}');
            if (!authData.token) {
                console.warn('Token de autentica√ß√£o n√£o encontrado, tentando login autom√°tico...');
                const loginSuccess = await ensureAdminLogin();
                if (!loginSuccess) {
                    throw new Error('N√£o foi poss√≠vel autenticar automaticamente. Por favor, fa√ßa login manualmente.');
                }
                console.log('Login autom√°tico realizado com sucesso, continuando com o salvamento do plano');
            }
            
            // Salvar no backend via API ou localStorage
            const newPlan = await createPlanAPI(planData);
            
            if (!newPlan) {
                throw new Error('N√£o foi poss√≠vel criar o plano');
            }
            
            // Fechar o modal com m√©todo seguro
            const modal = document.getElementById('addPlanModal');
            if (modal) {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) bsModal.hide();
                } else {
                    modal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                }
            }
            
            // Atualizar a interface do usu√°rio
            if (typeof refreshPlansUI === 'function') {
                setTimeout(refreshPlansUI, 100);
            }
            
            // Mostrar mensagem de sucesso
            setTimeout(() => {
                alert('Plano adicionado com sucesso!');
            }, 200);
            
        } catch (error) {
            console.error('Erro ao salvar plano:', error);
            alert('Erro ao salvar o plano: ' + error.message);
        } finally {
            // Restaurar bot√£o para estado normal
            if (saveBtn) {
                saveBtn.innerHTML = 'Salvar';
                saveBtn.disabled = false;
            }
        }
    }
    
    // Fun√ß√£o de fallback para criar plano localmente
    function createPlanLocally(planData) {
        console.log('Usando fallback para criar plano localmente');
        
        try {
            // Garantir que window.plans exista
            if (!window.plans) window.plans = [];
            if (!Array.isArray(window.plans)) window.plans = [];
            
            // Encontrar o pr√≥ximo ID dispon√≠vel
            const maxId = window.plans.reduce((max, plan) => Math.max(max, plan.id || 0), 0);
            const newId = maxId + 1;
            
            // Criar o novo plano com ID
            const newPlan = {
                ...planData,
                id: newId,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
                storage_type: 'local'
            };
            
            // Adicionar √† lista de planos
            window.plans.push(newPlan);
            
            // Atualizar localStorage
            localStorage.setItem('agendai_plans', JSON.stringify(window.plans));
            
            return newPlan;
        } catch (error) {
            console.error('Erro ao criar plano localmente:', error);
            throw new Error('Falha ao salvar o plano localmente: ' + error.message);
        }
    }
</script>

<!-- Corre√ß√£o para erros de Bootstrap -->
<script>
    // Patch preventivo para problemas do Bootstrap Modal
    window.addEventListener('DOMContentLoaded', function() {
        console.log('Aplicando patches de compatibilidade para o Bootstrap...');
        
        // Garantir que o objeto bootstrap exista
        window.bootstrap = window.bootstrap || {};
        
        // Criar um polyfill para Modal se n√£o existir
        if (!bootstrap.Modal) {
            bootstrap.Modal = function(element) {
                this.element = element;
                
                this.show = function() {
                    element.style.display = 'block';
                    element.classList.add('show');
                    document.body.classList.add('modal-open');
                    
                    // Criar backdrop
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    document.body.appendChild(backdrop);
                };
                
                this.hide = function() {
                    element.style.display = 'none';
                    element.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    
                    // Remover backdrop
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                };
                
                // M√©todo est√°tico
                this.constructor.getInstance = function(element) {
                    return new bootstrap.Modal(element);
                };
            };
        }
        
        // Garantir que o objeto On exista e tenha os m√©todos necess√°rios
        window.On = window.On || {};
        On.initializeBackdrop = On.initializeBackdrop || function() { 
            console.log('Backdrop inicializado (polyfill)'); 
            return true; 
        };
        
        On.getOrCreateInstance = On.getOrCreateInstance || function() {
            console.log('getOrCreateInstance chamado (polyfill)');
            return { 
                backdrop: true, 
                reset: function() { console.log('Reset chamado (polyfill)'); } 
            };
        };
        
        // Monitorar erros do Bootstrap
        window.addEventListener('error', function(e) {
            if (e.message && (
                e.message.includes('backdrop') || 
                e.message.includes('modal') || 
                e.message.includes('Bootstrap')
            )) {
                console.warn('Erro relacionado ao Bootstrap detectado e suprimido:', e.message);
                e.preventDefault();
                e.stopPropagation();
            }
        }, true);
        
        // Modificar os bot√µes de modal
        setTimeout(() => {
            // Modificar o bot√£o "Salvar" do modal de adi√ß√£o
            const saveBtns = document.querySelectorAll('[onclick="createNewPlan()"]');
            saveBtns.forEach(btn => {
                btn.innerHTML = 'Salvar Plano';
                console.log('Bot√£o de salvamento modificado para usar fun√ß√£o global');
            });
            
            console.log('Corre√ß√µes do Bootstrap e dos bot√µes aplicadas com sucesso!');
        }, 500);
    });
    
    // Definir a fun√ß√£o createNewPlan diretamente no escopo global
    window.createNewPlan = async function() {
        console.log('------ DEBUGGING: Fun√ß√£o createNewPlan chamada - escopo global');
        
        try {
            // Coletar dados do formul√°rio com seguran√ßa
            const planName = document.getElementById('planName');
            const planPrice = document.getElementById('planPrice');
            const planAppointments = document.getElementById('planAppointments');
            const planProfessionals = document.getElementById('planProfessionals');
            const planServices = document.getElementById('planServices');
            const planStatus = document.getElementById('planStatus');
            const planHighlight = document.getElementById('planHighlight');
            const planDescription = document.getElementById('planDescription');
            
            // Verificar se os elementos foram encontrados
            if (!planName || !planPrice || !planAppointments || !planProfessionals || 
                !planServices || !planStatus || !planHighlight) {
                console.error('------ DEBUGGING: Elementos do formul√°rio n√£o encontrados');
                alert('Erro: N√£o foi poss√≠vel encontrar todos os campos do formul√°rio.');
                return;
            }
            
            // Obter valores
            const name = planName.value || 'Novo Plano';
            const price = parseFloat(planPrice.value || '0');
            const appointments = parseInt(planAppointments.value || '0');
            const professionals = parseInt(planProfessionals.value || '0');
            const services = parseInt(planServices.value || '0');
            const status = planStatus.value || 'active';
            const highlight = planHighlight.value || 'none';
            const description = planDescription ? planDescription.value : '';
            
            // Obter estado das checkboxes com verifica√ß√£o de seguran√ßa
            const getCheckboxState = (id) => {
                const checkbox = document.getElementById(id);
                return checkbox ? checkbox.checked : false;
            };
            
            const features = {
                reports: getCheckboxState('featureReports'),
                emailNotifications: getCheckboxState('featureEmailNotifications'),
                smsNotifications: getCheckboxState('featureSmsNotifications'),
                whatsAppNotifications: getCheckboxState('featureWhatsAppNotifications'),
                customization: getCheckboxState('featureCustomization'),
                api: getCheckboxState('featureAPI')
            };
            
            // Criar objeto do plano
            const planData = {
                name, price, appointments, professionals, 
                services, status, highlight, description, features
            };
            
            console.log('------ DEBUGGING: Dados do novo plano:', planData);
            
            // Verificar se a fun√ß√£o createPlanAPI existe
            if (typeof createPlanAPI !== 'function') {
                console.error('------ DEBUGGING: Fun√ß√£o createPlanAPI n√£o encontrada, usando fallback');
                
                // Criar plano localmente como fallback
                const newId = Math.max(...(window.plans || []).map(p => p.id || 0), 0) + 1;
                const newPlan = {
                    ...planData,
                    id: newId,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                // Garantir que window.plans exista e seja um array
                if (!window.plans) window.plans = [];
                if (!Array.isArray(window.plans)) window.plans = [];
                
                // Adicionar o plano
                window.plans.push(newPlan);
                
                // Atualizar localStorage
                try {
                    localStorage.setItem('agendai_plans', JSON.stringify(window.plans));
                } catch (e) {
                    console.error('------ DEBUGGING: Erro ao salvar no localStorage:', e);
                }
                
                // Fechar o modal
                fecharModal();
                
                // Atualizar a interface
                if (typeof refreshPlansUI === 'function') {
                    setTimeout(() => {
                        refreshPlansUI();
                        alert('Plano criado localmente com sucesso!');
                    }, 100);
                } else {
                    alert('Plano criado localmente com sucesso! Recarregue a p√°gina para ver as altera√ß√µes.');
                    setTimeout(() => window.location.reload(), 1000);
                }
                
                return;
            }
            
            // Criar plano via API
            createPlanAPI(planData).then(newPlan => {
                console.log('------ DEBUGGING: Plano criado com sucesso:', newPlan);
                
                // Fechar o modal
                fecharModal();
                
                // Atualizar a interface
                if (typeof refreshPlansUI === 'function') {
                    setTimeout(() => {
                        refreshPlansUI();
                        alert('Plano criado com sucesso!');
                    }, 100);
                } else {
                    alert('Plano criado com sucesso! Recarregue a p√°gina para ver as altera√ß√µes.');
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(error => {
                console.error('------ DEBUGGING: Erro ao criar plano via API:', error);
                alert(`Erro ao criar plano: ${error.message}`);
            });
            
        } catch (error) {
            console.error('------ DEBUGGING: Erro ao criar plano:', error);
            alert(`Erro ao criar plano: ${error.message}`);
        }
    };
    
    // Fun√ß√£o auxiliar para fechar o modal
    function fecharModal() {
        // Fechar o modal
        const modal = document.getElementById('addPlanModal');
        if (modal) {
            // Tentar m√©todos diferentes para fechar o modal
            try {
                // M√©todo 1: Usar Bootstrap
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) bsModal.hide();
                } 
                // M√©todo 2: Fechar manualmente
                else {
                    modal.style.display = 'none';
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(b => b.remove());
                    document.body.classList.remove('modal-open');
                }
            } catch (e) {
                console.error('------ DEBUGGING: Erro ao fechar modal:', e);
                // M√©todo 3: For√ßar fechamento
                modal.style.display = 'none';
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(b => b.remove());
                document.body.classList.remove('modal-open');
            }
        }
    }
</script>

<!-- Script de corre√ß√£o para bot√µes de exclus√£o de planos -->
<script src="/public/js/plan-actions-fix.js"></script>
</body>
</html> 